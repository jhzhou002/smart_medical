-- ===================================================================
-- Smart Diagnosis v3 orchestration and helper functions
-- ===================================================================

SET search_path = public;

-- ---------------------------------------------------------------
-- 1. Prepare diagnosis context (patient profile + latest modality data)
-- ---------------------------------------------------------------
CREATE OR REPLACE FUNCTION prepare_diagnosis_context(p_patient_id integer)
RETURNS jsonb
LANGUAGE plpgsql
AS $$
DECLARE
  v_patient jsonb;
  v_text jsonb;
  v_ct jsonb;
  v_lab jsonb;
  v_lab_anomalies jsonb := '[]'::jsonb;
  v_previous jsonb := '[]'::jsonb;
  v_abnormal_count integer := 0;
BEGIN
  SELECT to_jsonb(row)
    INTO v_patient
  FROM (
    SELECT patient_id,
           name,
           age,
           gender,
           phone,
           id_card,
           first_visit,
           past_medical_history,
           latest_condition
      FROM patients
     WHERE patient_id = p_patient_id
  ) AS row;

  IF v_patient IS NULL THEN
    RAISE EXCEPTION 'Patient % not found', p_patient_id USING ERRCODE = 'NO_DATA_FOUND';
  END IF;

  SELECT to_jsonb(row)
    INTO v_text
  FROM (
    SELECT id,
           COALESCE(final_summary, text_summary, ai_summary) AS summary,
           key_findings,
           analyzed_at,
           reviewed_at,
           created_at
      FROM patient_text_data
     WHERE patient_id = p_patient_id
       AND COALESCE(status, 'completed') <> 'failed'
     ORDER BY COALESCE(reviewed_at, analyzed_at, created_at) DESC
     LIMIT 1
  ) AS row;

  SELECT to_jsonb(row)
    INTO v_ct
  FROM (
    SELECT id,
           body_part,
           COALESCE(final_analysis, analysis_result, ai_analysis) AS analysis,
           ct_url,
           analyzed_at,
           reviewed_at,
           created_at
      FROM patient_ct_data
     WHERE patient_id = p_patient_id
       AND COALESCE(status, 'completed') <> 'failed'
     ORDER BY COALESCE(reviewed_at, analyzed_at, created_at) DESC
     LIMIT 1
  ) AS row;

  SELECT to_jsonb(row)
    INTO v_lab
  FROM (
    SELECT id,
           COALESCE(final_interpretation, lab_data::text) AS interpretation,
           lab_data,
           analyzed_at,
           reviewed_at,
           created_at
      FROM patient_lab_data
     WHERE patient_id = p_patient_id
       AND COALESCE(status, 'completed') <> 'failed'
     ORDER BY COALESCE(reviewed_at, analyzed_at, created_at) DESC
     LIMIT 1
  ) AS row;

  -- Âü∫‰∫éÊ£ÄÊµãÂÄº‰∏éÊ≠£Â∏∏ËåÉÂõ¥ÊØîËæÉËÆ°ÁÆóÂºÇÂ∏∏ÊåáÊ†áÊï∞Èáè
  v_lab_anomalies := '[]'::jsonb;

  IF v_lab IS NOT NULL AND (v_lab ? 'lab_data') THEN
    DECLARE
      v_lab_data jsonb := COALESCE(v_lab->'lab_data', '{}'::jsonb);
      v_key text;
      v_indicator_value numeric;
      v_reference text;
      v_normal_min numeric;
      v_normal_max numeric;
      v_unit text;
      v_is_abnormal boolean;
      v_ref_parts text[];
    BEGIN
      FOR v_key IN SELECT jsonb_object_keys(v_lab_data) LOOP
        v_is_abnormal := false;

        -- Ëé∑ÂèñÊåáÊ†áÂÄº
        BEGIN
          v_indicator_value := (v_lab_data->v_key->>'value')::numeric;
        EXCEPTION WHEN OTHERS THEN
          CONTINUE; -- Ë∑≥ËøáÊó†Ê≥ïËΩ¨Êç¢‰∏∫Êï∞Â≠óÁöÑÂÄº
        END;

        -- üîß ‰øÆÂ§çÔºö‰ªéreferenceÂ≠óÊÆµËß£ÊûêÊ≠£Â∏∏ËåÉÂõ¥
        v_reference := v_lab_data->v_key->>'reference';
        v_unit := COALESCE(v_lab_data->v_key->>'unit', '');

        -- Ëß£Êûê "3.97-9.15" Ê†ºÂºèÁöÑÊ≠£Â∏∏ËåÉÂõ¥
        IF v_reference IS NOT NULL AND v_reference <> '' THEN
          BEGIN
            -- ‰ΩøÁî®Ê≠£ÂàôË°®ËææÂºèÂåπÈÖç "Êï∞Â≠ó-Êï∞Â≠ó" Ê†ºÂºè
            v_ref_parts := regexp_match(v_reference, '([\d.]+)-([\d.]+)');

            IF v_ref_parts IS NOT NULL THEN
              v_normal_min := v_ref_parts[1]::numeric;
              v_normal_max := v_ref_parts[2]::numeric;

              -- Ê£ÄÊü•ÊòØÂê¶Ë∂ÖÂá∫Ê≠£Â∏∏ËåÉÂõ¥
              IF v_indicator_value < v_normal_min OR v_indicator_value > v_normal_max THEN
                v_abnormal_count := v_abnormal_count + 1;
                v_is_abnormal := true;

                -- Ê∑ªÂä†Âà∞ÂºÇÂ∏∏Êï∞ÁªÑ
                v_lab_anomalies := v_lab_anomalies || jsonb_build_object(
                  'indicator', v_key,
                  'is_abnormal', true,
                  'current_value', v_indicator_value::text || v_unit,
                  'normal_range', v_reference,
                  'abnormal_type', CASE
                    WHEN v_indicator_value < v_normal_min THEN 'ÂÅè‰Ωé'
                    WHEN v_indicator_value > v_normal_max THEN 'ÂÅèÈ´ò'
                    ELSE 'Ê≠£Â∏∏'
                  END
                );
              END IF;
            END IF;
          EXCEPTION WHEN OTHERS THEN
            -- Â¶ÇÊûúËß£ÊûêÂ§±Ë¥•ÔºåË∑≥ËøáËØ•ÊåáÊ†á
            CONTINUE;
          END;
        END IF;
      END LOOP;
    EXCEPTION
      WHEN others THEN
        v_lab_anomalies := '[]'::jsonb;
    END;
  END IF;

  -- ÊúÄËøë‰∏âÊù°ËØäÊñ≠ÔºåÁî®‰∫é‰∏ä‰∏ãÊñá
  SELECT COALESCE(jsonb_agg(row_to_json(t)), '[]'::jsonb)
    INTO v_previous
    FROM (
      SELECT id,
             diagnosis_text,
             confidence_score,
             risk_score,
             diagnosed_at
        FROM patient_diagnosis
       WHERE patient_id = p_patient_id
       ORDER BY diagnosed_at DESC NULLS LAST, created_at DESC
       LIMIT 3
    ) AS t;

  RETURN jsonb_build_object(
    'patient', v_patient,
    'text', v_text,
    'ct', v_ct,
    'lab', v_lab,
    'lab_anomalies', v_lab_anomalies,
    'abnormal_count', v_abnormal_count,
    'previous_diagnosis', v_previous
  );
END;
$$;


-- ---------------------------------------------------------------
-- 2. Compute evidence profile based on weights
-- ---------------------------------------------------------------
CREATE OR REPLACE FUNCTION compute_evidence_profile(p_context jsonb)
RETURNS jsonb
LANGUAGE plpgsql
AS $$
DECLARE
  v_version integer;
  v_weight_text numeric := 0.33;
  v_weight_ct numeric := 0.33;
  v_weight_lab numeric := 0.34;
  v_summary jsonb := '[]'::jsonb;
  v_detail jsonb := '{}'::jsonb;
  v_text jsonb := p_context->'text';
  v_ct jsonb := p_context->'ct';
  v_lab jsonb := p_context->'lab';
  v_anomalies jsonb := COALESCE(p_context->'lab_anomalies', '[]'::jsonb);
BEGIN
  SELECT MAX(version) INTO v_version FROM evidence_weights;

  IF v_version IS NOT NULL THEN
    SELECT COALESCE(SUM(weight), 0.0)
      INTO v_weight_text
      FROM evidence_weights
     WHERE modality = 'text' AND version = v_version;

    SELECT COALESCE(SUM(weight), 0.0)
      INTO v_weight_ct
      FROM evidence_weights
     WHERE modality = 'ct' AND version = v_version;

    SELECT COALESCE(SUM(weight), 0.0)
      INTO v_weight_lab
      FROM evidence_weights
     WHERE modality = 'lab' AND version = v_version;

    IF (v_weight_text + v_weight_ct + v_weight_lab) = 0 THEN
      v_weight_text := 0.33;
      v_weight_ct := 0.33;
      v_weight_lab := 0.34;
    END IF;
  END IF;

  IF v_text IS NOT NULL THEN
    v_summary := v_summary || jsonb_build_array(
      format('ÁóÖÂéÜÔºàÊùÉÈáç %s%%ÔºâÔºö%s',
             to_char(v_weight_text * 100, 'FM999990.0'),
             COALESCE(v_text->>'summary', 'ÊöÇÊó†ÁóÖÂéÜÊëòË¶Å'))
    );
    v_detail := v_detail || jsonb_build_object('text', v_text);
  END IF;

  IF v_ct IS NOT NULL THEN
    v_summary := v_summary || jsonb_build_array(
      format('ÂΩ±ÂÉèÔºàÊùÉÈáç %s%%ÔºâÔºö%s',
             to_char(v_weight_ct * 100, 'FM999990.0'),
             COALESCE(v_ct->>'analysis', 'ÊöÇÊó†ÂΩ±ÂÉèÂàÜÊûê'))
    );
    v_detail := v_detail || jsonb_build_object('ct', v_ct);
  END IF;

  IF v_lab IS NOT NULL THEN
    -- ÁîüÊàê‰∫∫Á±ªÂèØËØªÁöÑÂÆûÈ™åÂÆ§ÊåáÊ†áÊëòË¶Å
    DECLARE
      v_lab_summary text;
      v_lab_data jsonb;
      v_total_indicators integer := 0;
      v_key text;
    BEGIN
      -- ÂÆâÂÖ®Ëé∑Âèñ lab_dataÔºåÁ°Æ‰øùÊòØ jsonb Á±ªÂûã
      BEGIN
        v_lab_data := v_lab->'lab_data';

        -- Ê£ÄÊü• v_lab_data ÊòØÂê¶‰∏∫ jsonb ÂØπË±°Á±ªÂûã
        IF v_lab_data IS NOT NULL AND jsonb_typeof(v_lab_data) = 'object' THEN
          -- ÁªüËÆ°ÊåáÊ†áÊï∞Èáè
          SELECT COUNT(*) INTO v_total_indicators FROM jsonb_object_keys(v_lab_data);
          v_lab_summary := format('ÂÖ±Ê£ÄÊµã %s È°πÊåáÊ†á', v_total_indicators);

          -- Ê∑ªÂä†ÂºÇÂ∏∏ÊåáÊ†áÊëòË¶Å
          IF jsonb_array_length(v_anomalies) > 0 THEN
            v_lab_summary := v_lab_summary || format('ÔºåÂèëÁé∞ %s È°πÂºÇÂ∏∏Ôºö', jsonb_array_length(v_anomalies));

            -- Âàó‰∏æÂÖ≥ÈîÆÂºÇÂ∏∏ÊåáÊ†áÔºàÊúÄÂ§öÂâç5‰∏™Ôºâ
            FOR i IN 0..LEAST(4, jsonb_array_length(v_anomalies)-1) LOOP
              v_key := v_anomalies->i->>'indicator';
              v_lab_summary := v_lab_summary || format('%s%sÔºà%sÔºâ',
                CASE WHEN i > 0 THEN '„ÄÅ' ELSE '' END,
                v_key,
                v_anomalies->i->>'abnormal_type');
            END LOOP;

            IF jsonb_array_length(v_anomalies) > 5 THEN
              v_lab_summary := v_lab_summary || format(' Á≠â');
            END IF;
          ELSE
            v_lab_summary := v_lab_summary || 'ÔºåÂêÑÈ°πÊåáÊ†áÂü∫Êú¨Ê≠£Â∏∏';
          END IF;
        ELSE
          -- lab_data ‰∏çÊòØÊúâÊïàÁöÑ jsonb ÂØπË±°
          v_lab_summary := 'ÊöÇÊó†ÊúâÊïàÁöÑÊ£ÄÈ™åÊï∞ÊçÆ';
        END IF;
      EXCEPTION WHEN OTHERS THEN
        -- ÂèëÁîü‰ªª‰ΩïÈîôËØØÊó∂ÁöÑÂÖúÂ∫ïÂ§ÑÁêÜ
        v_lab_summary := 'Ê£ÄÈ™åÊï∞ÊçÆËß£ÊûêÂ§±Ë¥•';
      END;

      v_summary := v_summary || jsonb_build_array(
        format('Ê£ÄÈ™åÔºàÊùÉÈáç %s%%ÔºâÔºö%s',
               to_char(v_weight_lab * 100, 'FM999990.0'),
               v_lab_summary)
      );
    END;
    v_detail := v_detail || jsonb_build_object('lab', v_lab);
  END IF;

  IF jsonb_array_length(v_anomalies) > 0 THEN
    v_detail := v_detail || jsonb_build_object('lab_anomalies', v_anomalies);
  END IF;

  RETURN jsonb_build_object(
    'summary', v_summary,
    'detail', v_detail,
    'weights', jsonb_build_object(
      'text', v_weight_text,
      'ct', v_weight_ct,
      'lab', v_weight_lab
    )
  );
END;
$$;


-- ---------------------------------------------------------------
-- 3. Compute risk profile
-- ---------------------------------------------------------------
CREATE OR REPLACE FUNCTION compute_risk_profile(p_context jsonb, p_evidence jsonb)
RETURNS jsonb
LANGUAGE plpgsql
AS $$
DECLARE
  v_anomalies jsonb := COALESCE(p_context->'lab_anomalies', '[]'::jsonb);
  v_anomaly_count integer := COALESCE((p_context->>'abnormal_count')::integer, jsonb_array_length(v_anomalies));
  v_weights jsonb := COALESCE(p_evidence->'weights', '{}'::jsonb);
  v_weight_lab numeric := COALESCE((v_weights->>'lab')::numeric, 0.34);
  v_weight_ct numeric := COALESCE((v_weights->>'ct')::numeric, 0.33);
  v_weight_text numeric := COALESCE((v_weights->>'text')::numeric, 0.33);

  -- ÊÇ£ËÄÖÂü∫Êú¨‰ø°ÊÅØ
  v_patient jsonb := COALESCE(p_context->'patient', '{}'::jsonb);
  v_age integer := COALESCE((v_patient->>'age')::integer, 45);
  v_gender text := COALESCE(v_patient->>'gender', 'Áî∑');

  -- È£éÈô©ËØÑÂàÜÂèòÈáè
  v_base_risk numeric := 0.1;  -- Èôç‰ΩéÂü∫Á°ÄÈ£éÈô©
  v_risk numeric;
  v_level text;

  -- ÂºÇÂ∏∏ÊåáÊ†á‰∏•ÈáçÁ®ãÂ∫¶ËØÑ‰º∞
  v_severe_anomaly_count integer := 0;
  v_moderate_anomaly_count integer := 0;
  v_mild_anomaly_count integer := 0;
  v_anomaly_severity_score numeric := 0.0;

  -- ËÆ°ÁÆóÂèòÈáè
  v_age_factor numeric := 0.0;
  v_modality_risk_factor numeric := 0.0;
  v_anomaly_risk_factor numeric := 0.0;
  v_critical_indicator_risk numeric := 0.0;
BEGIN
  -- 1. ËÆ°ÁÆóÂπ¥ÈæÑÈ£éÈô©Âõ†Â≠êÔºà65Â≤Å‰ª•‰∏äÈ£éÈô©Â¢ûÂä†Ôºâ
  IF v_age >= 65 THEN
    v_age_factor := 0.15;  -- ËÄÅÂπ¥ÊÇ£ËÄÖÂü∫Á°ÄÈ£éÈô©Â¢ûÂä†
  ELSIF v_age >= 45 THEN
    v_age_factor := 0.05;  -- ‰∏≠Âπ¥ÊÇ£ËÄÖËΩªÂæÆÈ£éÈô©Â¢ûÂä†
  END IF;

  -- 2. ËÆ°ÁÆóÊ®°ÊÄÅÊï∞ÊçÆÂÆåÊï¥Â∫¶È£éÈô©Âõ†Â≠ê
  -- Êï∞ÊçÆ‰∏çÂÆåÊï¥‰ºöÂ¢ûÂä†È£éÈô©ËØÑÂàÜ
  v_modality_risk_factor :=
    CASE
      WHEN (p_context->'text') IS NULL THEN 0.08  -- Áº∫Â∞ëÁóÖÂéÜÊï∞ÊçÆ
      ELSE 0.0
    END +
    CASE
      WHEN (p_context->'ct') IS NULL THEN 0.06   -- Áº∫Â∞ëCTÊï∞ÊçÆ
      ELSE 0.0
    END +
    CASE
      WHEN (p_context->'lab') IS NULL THEN 0.10  -- Áº∫Â∞ëÊ£ÄÈ™åÊï∞ÊçÆÂΩ±ÂìçÊúÄÂ§ß
      ELSE 0.0
    END;

  -- 3. ËÆ°ÁÆóÂºÇÂ∏∏ÊåáÊ†á‰∏•ÈáçÁ®ãÂ∫¶ËØÑÂàÜ
  IF v_anomaly_count > 0 THEN
    -- ÈÅçÂéÜÂºÇÂ∏∏ÊåáÊ†áÔºåËØÑ‰º∞‰∏•ÈáçÁ®ãÂ∫¶
    DECLARE
      v_anomaly jsonb;
      v_abnormal_type text;
      v_indicator text;
    BEGIN
      FOR i IN 0..jsonb_array_length(v_anomalies)-1 LOOP
        v_anomaly := v_anomalies->i;
        v_abnormal_type := COALESCE(v_anomaly->>'abnormal_type', 'Êú™Áü•');
        v_indicator := COALESCE(v_anomaly->>'indicator', '');

        -- ÂÖ≥ÈîÆÊåáÊ†áÈ£éÈô©Êõ¥È´ò
        IF v_indicator ~ '(ÁôΩÁªÜËÉû|WBC|Ë°ÄÁ∫¢ËõãÁôΩ|Hb|Ë°ÄÂ∞èÊùø|PLT|Ë°ÄÁ≥ñ|Ë°ÄÂéã|ËÇåÈÖê|Cr|Â∞øÁ¥†Ê∞Æ|BUN)' THEN
          v_critical_indicator_risk := v_critical_indicator_risk + 0.1;
        END IF;

        -- Ê†πÊçÆÂºÇÂ∏∏Á±ªÂûãÂàÜÈÖç‰∏•ÈáçÁ®ãÂ∫¶
        -- ËøôÈáåÁÆÄÂåñÂ§ÑÁêÜÔºåÂÆûÈôÖÂèØ‰ª•Ê†πÊçÆÂÅèÁ¶ªÁ®ãÂ∫¶Ëøõ‰∏ÄÊ≠•ÁªÜÂåñ
        IF v_abnormal_type = 'ÂÅèÈ´ò' OR v_abnormal_type = 'ÂÅè‰Ωé' THEN
          -- ÂÅáËÆæÂÅèÁ¶ªÁ®ãÂ∫¶Ë∂äÈ´òÔºåÈ£éÈô©Ë∂äÂ§ßÔºàËøôÈáåÁÆÄÂåñÂ§ÑÁêÜÔºâ
          v_anomaly_severity_score := v_anomaly_severity_score + 0.8 / v_anomaly_count;
        END IF;
      END LOOP;
    END;

    -- Â∞ÜÂºÇÂ∏∏ËØÑÂàÜÈôêÂà∂Âú®0-0.6‰πãÈó¥ÔºåÈÅøÂÖçËøáÂ∫¶ÂΩ±Âìç
    v_anomaly_risk_factor := LEAST(0.6, v_anomaly_severity_score);
  END IF;

  -- 4. ÁªºÂêàÈ£éÈô©ËØÑÂàÜËÆ°ÁÆóÔºàÊîπËøõÁöÑÊùÉÈáçÂàÜÈÖçÔºâ
  v_risk := v_base_risk + v_age_factor + v_modality_risk_factor + v_anomaly_risk_factor + v_critical_indicator_risk;

  -- 5. Ê®°ÊÄÅÊùÉÈáçË∞ÉÊï¥ÔºàÈ´òË¥®ÈáèÊï∞ÊçÆÈôç‰ΩéÈ£éÈô©Ôºâ
  v_risk := v_risk * (1.0 - (v_weight_lab * 0.15 + v_weight_ct * 0.10 + v_weight_text * 0.05));

  -- 6. ÈôêÂà∂Âú®0-1ËåÉÂõ¥ÂÜÖ
  v_risk := GREATEST(0.0, LEAST(1.0, v_risk));

  -- ÊîπËøõÁöÑÈ£éÈô©Á≠âÁ∫ßÂà§Êñ≠ÔºàÊõ¥Á¨¶ÂêàÂåªÂ≠¶ÂÆûË∑µÔºâ
  IF v_risk < 0.25 THEN
    v_level := 'low';      -- ‰ΩéÈ£éÈô©ÔºöÂÅ•Â∫∑Áä∂ÂÜµËâØÂ•Ω
  ELSIF v_risk < 0.45 THEN
    v_level := 'medium';   -- ‰∏≠È£éÈô©ÔºöÈúÄË¶ÅÂÖ≥Ê≥®
  ELSIF v_risk < 0.70 THEN
    v_level := 'high';     -- È´òÈ£éÈô©ÔºöÈúÄË¶ÅÂèäÊó∂Âπ≤È¢Ñ
  ELSE
    v_level := 'critical'; -- Âç±ÊÄ•È£éÈô©ÔºöÈúÄË¶ÅÁ´ãÂç≥Â§ÑÁêÜ
  END IF;

  RETURN jsonb_build_object(
    'risk_score', v_risk,
    'risk_level', v_level,
    'lab_anomaly_count', v_anomaly_count,
    -- ËØ¶ÁªÜÁöÑËØÑÂàÜÂõ†Â≠êÂàÜËß£ÔºàÁî®‰∫éË∞ÉËØïÂíåËß£ÈáäÔºâ
    'risk_factors', jsonb_build_object(
      'base_risk', v_base_risk,
      'age_factor', v_age_factor,
      'age', v_age,
      'modality_completeness_risk', v_modality_risk_factor,
      'lab_data_available', (p_context->'lab') IS NOT NULL,
      'ct_data_available', (p_context->'ct') IS NOT NULL,
      'text_data_available', (p_context->'text') IS NOT NULL,
      'anomaly_risk_factor', v_anomaly_risk_factor,
      'critical_indicator_risk', v_critical_indicator_risk,
      'modality_weights', jsonb_build_object(
        'lab', v_weight_lab,
        'ct', v_weight_ct,
        'text', v_weight_text
      )
    )
  );
END;
$$;


-- ---------------------------------------------------------------
-- 4. Generate AI diagnosis via OpenTenBase AI plugin
-- ---------------------------------------------------------------
CREATE OR REPLACE FUNCTION generate_ai_diagnosis(
  p_context jsonb,
  p_evidence jsonb,
  p_risk jsonb
)
RETURNS jsonb
LANGUAGE plpgsql
AS $$
DECLARE
  v_prompt text;
  v_response text;
  v_json jsonb;
  v_summary jsonb := COALESCE(p_evidence->'summary', '[]'::jsonb);
  v_patient_text text;
  v_summary_text text;
  v_risk_percent text;
  v_risk_level text := COALESCE(p_risk->>'risk_level', 'unknown');
  v_anomaly_count text;
BEGIN
  v_patient_text := COALESCE((p_context->'patient')::text, '{}');
  v_summary_text := v_summary::text;
  v_risk_percent := to_char(COALESCE((p_risk->>'risk_score')::numeric, 0.0) * 100, 'FM999990.0');
  v_anomaly_count := COALESCE((p_risk->>'lab_anomaly_count')::text, '0');

  v_prompt := format($prompt$
‰Ω†ÊòØ‰∏ÄÂêçËµÑÊ∑±ÁöÑÂ§öÊ®°ÊÄÅ‰∏¥Â∫äÂåªÁîüÔºåÂü∫‰∫é‰ª•‰∏ãÊÇ£ËÄÖËÉåÊôØ„ÄÅËØÅÊçÆÊùÉÈáç‰∏éÈ£éÈô©‰ø°ÊÅØÔºåËæìÂá∫‰∏Ä‰ªΩ JSON ËØäÊñ≠Êä•Âëä„ÄÇ

„ÄêÊÇ£ËÄÖ‰ø°ÊÅØ„Äë
%s

„ÄêÈáçÁÇπËØÅÊçÆ„Äë
%s

„ÄêÈ£éÈô©Ê¥ûÂØü„Äë
È£éÈô©ËØÑÂàÜÔºö%s%%
È£éÈô©Á≠âÁ∫ßÔºö%s
ÂÆûÈ™åÂÆ§ÂºÇÂ∏∏È°πÔºö%s

ËØ∑ËøîÂõû‰∏•Ê†ºÁöÑ JSONÔºåÁªìÊûÑ‰∏∫Ôºö
{
  "diagnosis": "‰∏ÄÂè•ËØù‰∏ªËØäÊñ≠ÁªìËÆ∫",
  "analysis": "ËØ¶ÁªÜÂàÜÊûê‰∏é‰ΩêËØÅÔºàÊÆµËêΩÔºâ",
  "recommendations": ["Ê≤ªÁñóÊàñÈöèËÆøÂª∫ËÆÆ1", "Âª∫ËÆÆ2", ...],
  "warnings": ["ÈúÄË≠¶ÊÉïÁöÑÈ£éÈô©", "..."],
  "confidence": 0.0 ~ 1.0
}

ËØ∑ÂãøËæìÂá∫‰ªª‰ΩïÈùû JSON ÁöÑÊñáÊú¨„ÄÇ
$prompt$,
    v_patient_text,
    v_summary_text,
    v_risk_percent,
    v_risk_level,
    v_anomaly_count
  );

  SELECT ai.generate_text(v_prompt) INTO v_response;
  v_response := trim(both from v_response);

  IF left(v_response, 3) = '```' THEN
    -- ÂéªÈô§ Markdown ‰ª£Á†ÅÂùóÂåÖË£π
    v_response := regexp_replace(v_response, '^```[a-zA-Z]*[ \t\r\n]*', '', 'n');
    v_response := regexp_replace(v_response, '[ \t\r\n]*```$', '', 'n');
    v_response := trim(both from v_response);
  END IF;

  BEGIN
    v_json := v_response::jsonb;
  EXCEPTION WHEN others THEN
    -- ÂÜçÂ∞ùËØï‰∏ÄÊ¨°ÔºöÁßªÈô§ÊΩúÂú®ÁöÑ ``` ÂíåËØ≠Ë®ÄÊ†áËÆ∞
    v_response := trim(both from v_response);
    v_response := regexp_replace(v_response, '^```[a-zA-Z]*[ \t\r\n]*', '', 'n');
    v_response := regexp_replace(v_response, '[ \t\r\n]*```$', '', 'n');

    BEGIN
      v_json := v_response::jsonb;
    EXCEPTION WHEN others THEN
      -- ÊúÄÁªàÂÖúÂ∫ï‰ΩøÁî®Êà™Êñ≠ÊñáÊú¨
      v_json := jsonb_build_object(
        'diagnosis', substring(v_response, 1, 300),
        'analysis', substring(v_response, 1, 600),
        'recommendations', jsonb_build_array(),
        'warnings', jsonb_build_array(),
        'confidence', 0.5
      );
    END;
  END;

  -- Á°Æ‰øùÂÖ≥ÈîÆÂ≠óÊÆµÂ≠òÂú®
  IF (v_json ? 'diagnosis') = FALSE THEN
    v_json := v_json || jsonb_build_object('diagnosis', substring(v_response, 1, 200));
  END IF;

  IF (v_json ? 'analysis') = FALSE THEN
    v_json := v_json || jsonb_build_object(
      'analysis', substring(v_response, 1, 600)
    );
  END IF;

  RETURN v_json || jsonb_build_object('raw_text', v_response);
END;
$$;


-- ---------------------------------------------------------------
-- 5. Apply confidence calibration
-- ---------------------------------------------------------------
CREATE OR REPLACE FUNCTION apply_confidence_calibration(
  p_model_key text,
  p_raw_confidence numeric
)
RETURNS numeric
LANGUAGE plpgsql
AS $$
DECLARE
  v_params jsonb;
  v_gain numeric := 1.0;
  v_bias numeric := 0.0;
  v_temperature numeric;
  v_calibrated numeric;
BEGIN
  SELECT parameters
    INTO v_params
    FROM model_calibration
   WHERE model_key = p_model_key
   ORDER BY effective_from DESC, created_at DESC
   LIMIT 1;

  IF v_params IS NOT NULL THEN
    v_gain := COALESCE((v_params->>'gain')::numeric, 1.0);
    v_bias := COALESCE((v_params->>'bias')::numeric, 0.0);
    v_temperature := (v_params->>'temperature')::numeric;
  END IF;

  IF v_temperature IS NOT NULL AND v_temperature > 0 THEN
    v_calibrated := 1 / (1 + exp(- (ln(p_raw_confidence / NULLIF(1 - p_raw_confidence, 0.00001)) / v_temperature)));
  ELSE
    v_calibrated := v_gain * p_raw_confidence + v_bias;
  END IF;

  v_calibrated := GREATEST(0.0, LEAST(1.0, v_calibrated));
  RETURN v_calibrated;
END;
$$;


-- ---------------------------------------------------------------
-- 6. Persist diagnosis result and return enriched JSON
-- ---------------------------------------------------------------
CREATE OR REPLACE FUNCTION persist_diagnosis_result(
  p_patient_id integer,
  p_context jsonb,
  p_ai_result jsonb,
  p_evidence jsonb,
  p_risk jsonb,
  p_confidence numeric,
  p_calibrated_confidence numeric
)
RETURNS jsonb
LANGUAGE plpgsql
AS $$
DECLARE
  v_diagnosis_id integer;
  v_result jsonb;
  v_recommendations jsonb := COALESCE(p_ai_result->'recommendations', '[]'::jsonb);
  v_warnings jsonb := COALESCE(p_ai_result->'warnings', '[]'::jsonb);
  v_analysis text := COALESCE(p_ai_result->>'analysis', '');
  v_diagnosis text := COALESCE(p_ai_result->>'diagnosis', 'Êú™ÁîüÊàêËØäÊñ≠');
  v_evidence_summary jsonb := COALESCE(p_evidence->'summary', '[]'::jsonb);
  v_evidence_detail jsonb := COALESCE(p_evidence->'detail', '{}'::jsonb);
  v_metadata jsonb := jsonb_build_object(
    'model', 'smart_diagnosis_v3',
    'warnings', v_warnings
  );
  -- ‰øÆÂ§ç: È¢ÑÂÖàËΩ¨Êç¢ recommendations Âíå warnings Êï∞ÁªÑ‰∏∫ÊñáÊú¨
  v_treatment_text text;
  v_advice_text text;
  v_weights jsonb := COALESCE(p_evidence->'weights', '{}'::jsonb);
  v_base_weights jsonb;
BEGIN
  -- Â∞Ü recommendations Êï∞ÁªÑËΩ¨‰∏∫Êç¢Ë°åÂàÜÈöîÁöÑÊñáÊú¨
  IF jsonb_array_length(v_recommendations) > 0 THEN
    SELECT string_agg(value::text, E'\n')
      INTO v_treatment_text
      FROM jsonb_array_elements_text(v_recommendations);
  ELSE
    v_treatment_text := NULL;
  END IF;

  -- Â∞Ü warnings Êï∞ÁªÑËΩ¨‰∏∫Êç¢Ë°åÂàÜÈöîÁöÑÊñáÊú¨
  IF jsonb_array_length(v_warnings) > 0 THEN
    SELECT string_agg(value::text, E'\n')
      INTO v_advice_text
      FROM jsonb_array_elements_text(v_warnings);
  ELSE
    v_advice_text := NULL;
  END IF;

  -- ÊèêÂèñÂü∫Á°ÄÊùÉÈáç
  v_base_weights := v_weights;

  INSERT INTO patient_diagnosis (
    patient_id,
    diagnosis_text,
    ai_diagnosis,
    confidence_score,
    calibrated_confidence,
    diagnosis_basis,
    evidence_json,
    risk_score,
    treatment_plan,
    medical_advice,
    base_weights,
    quality_adjusted,
    metadata,
    status,
    diagnosed_at
  ) VALUES (
    p_patient_id,
    v_diagnosis,
    v_analysis,  -- ‰øÆÂ§ç: ‰ΩøÁî®Ëß£ÊûêÂêéÁöÑ analysis Â≠óÊÆµ
    p_confidence,
    p_calibrated_confidence,
    v_evidence_detail,
    v_evidence_summary,
    COALESCE((p_risk->>'risk_score')::numeric, 0.0) * 100,
    v_treatment_text,  -- ‰øÆÂ§ç: ‰ΩøÁî®È¢ÑÂÖàËΩ¨Êç¢ÁöÑÊñáÊú¨
    v_advice_text,     -- ‰øÆÂ§ç: ‰ΩøÁî®È¢ÑÂÖàËΩ¨Êç¢ÁöÑÊñáÊú¨
    v_base_weights,    -- Êñ∞Â¢û: ‰øùÂ≠òÂü∫Á°ÄÊùÉÈáç
    false,             -- Êñ∞Â¢û: Ê†áËÆ∞Êú™ËøõË°åË¥®ÈáèË∞ÉÊï¥ÔºàÊöÇÊó∂ËÆæ‰∏∫ falseÔºâ
    v_metadata,
    'completed',
    NOW()
  )
  RETURNING id INTO v_diagnosis_id;

  INSERT INTO analysis_tasks (
    patient_id,
    task_type,
    status,
    result,
    started_at,
    completed_at
  ) VALUES (
    p_patient_id,
    'diagnosis',
    'completed',
    jsonb_build_object(
      'diagnosis_id', v_diagnosis_id,
      'diagnosis', v_diagnosis,
      'analysis', v_analysis,
      'confidence', p_confidence,
      'calibrated_confidence', p_calibrated_confidence,
      'risk', p_risk
    ),
    NOW(),
    NOW()
  );

  v_result := jsonb_build_object(
    'patient_id', p_patient_id,
    'diagnosis_id', v_diagnosis_id,
    'diagnosis', v_diagnosis,
    'analysis', v_analysis,
    'confidence', p_confidence,
    'calibrated_confidence', p_calibrated_confidence,
    'risk_score', COALESCE((p_risk->>'risk_score')::numeric, 0.0),
    'risk_level', COALESCE(p_risk->>'risk_level', 'unknown'),
    'evidence_summary', v_evidence_summary,
    'evidence_detail', v_evidence_detail,
    'recommendations', v_recommendations,
    'warnings', v_warnings,
    'metadata', v_metadata,
    'source', 'plpgsql',
    'generated_at', NOW()
  );

  RETURN v_result;
END;
$$;


-- ---------------------------------------------------------------
-- 7. Orchestration function
-- ---------------------------------------------------------------
CREATE OR REPLACE FUNCTION smart_diagnosis_v3(p_patient_id integer)
RETURNS jsonb
LANGUAGE plpgsql
AS $$
DECLARE
  v_context jsonb;
  v_evidence jsonb;
  v_risk jsonb;
  v_ai jsonb;
  v_confidence numeric;
  v_calibrated numeric;
  v_result jsonb;
BEGIN
  v_context := prepare_diagnosis_context(p_patient_id);
  v_evidence := compute_evidence_profile(v_context);
  v_risk := compute_risk_profile(v_context, v_evidence);

  v_ai := generate_ai_diagnosis(v_context, v_evidence, v_risk);
  v_confidence := COALESCE((v_ai->>'confidence')::numeric, 0.6);
  v_confidence := GREATEST(0.0, LEAST(1.0, v_confidence));

  v_calibrated := apply_confidence_calibration('smart_diagnosis_v3', v_confidence);

  v_result := persist_diagnosis_result(
    p_patient_id,
    v_context,
    v_ai,
    v_evidence,
    v_risk,
    v_confidence,
    v_calibrated
  );

  RETURN v_result;
END;
$$;

-- ===================================================================
-- End of smart diagnosis v3 definitions
-- ===================================================================
