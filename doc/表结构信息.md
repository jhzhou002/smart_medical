1.patient_text_data

SET search_path = public;
CREATE TABLE patient_text_data (
    id integer GENERATED ALWAYS AS (nextval('patient_text_data_id_seq'::regclass)) STORED NOT NULL,
    patient_id integer NOT NULL,
    image_url text,
    ai_summary text,
    ocr_text text,
    status character varying(20) GENERATED ALWAYS AS ('pending'::character varying) STORED,
    error_message text,
    created_at timestamp without time zone GENERATED ALWAYS AS (CURRENT_TIMESTAMP) STORED,
    final_summary text,
    edited boolean GENERATED ALWAYS AS (false) STORED,
    edited_by integer,
    edit_reason text,
    version integer GENERATED ALWAYS AS (1) STORED,
    analyzed_at timestamp without time zone,
    reviewed_at timestamp without time zone,
    text_summary text,
    key_findings jsonb,
    CONSTRAINT patient_text_data_status_check CHECK (((status)::text = ANY ((ARRAY['pending'::character varying, 'processing'::character varying, 'completed'::character varying, 'failed'::character varying, 'reviewed'::character varying, 'approved'::character varying])::text[]))),
    CONSTRAINT patient_text_data_edited_by_fkey2 FOREIGN KEY (edited_by) REFERENCES users(id),
    CONSTRAINT patient_text_data_edited_by_fkey1 FOREIGN KEY (edited_by) REFERENCES users(id),
    CONSTRAINT patient_text_data_edited_by_fkey FOREIGN KEY (edited_by) REFERENCES users(id),
    CONSTRAINT patient_text_data_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES patients(patient_id) ON DELETE CASCADE
)
WITH (checksum=on);
COMMENT ON TABLE patient_text_data IS '病历文本数据表';
COMMENT ON COLUMN patient_text_data.ai_summary IS 'AI原始分析结果（不可修改）';
COMMENT ON COLUMN patient_text_data.ocr_text IS 'OCR 识别的原始文本';
COMMENT ON COLUMN patient_text_data.status IS '复审状态: pending-待复审, reviewed-已复审, approved-已确认';
COMMENT ON COLUMN patient_text_data.final_summary IS '医生复审后的最终结果';
COMMENT ON COLUMN patient_text_data.edited IS '是否被医生编辑过';
COMMENT ON COLUMN patient_text_data.edited_by IS '复审医生ID';
COMMENT ON COLUMN patient_text_data.edit_reason IS '编辑原因或复审意见';
COMMENT ON COLUMN patient_text_data.version IS '版本号（每次编辑+1）';
COMMENT ON COLUMN patient_text_data.analyzed_at IS 'AI分析完成时间';
COMMENT ON COLUMN patient_text_data.reviewed_at IS '医生复审时间';
COMMENT ON COLUMN patient_text_data.text_summary IS '病历文本总结';
COMMENT ON COLUMN patient_text_data.key_findings IS '关键发现，JSON格式';
CREATE INDEX idx_text_data_reviewed ON public.patient_text_data USING btree (edited_by, reviewed_at) WITH (checksum='on');
CREATE INDEX idx_text_data_status ON public.patient_text_data USING btree (patient_id, status) WITH (checksum='on');
CREATE INDEX idx_text_created_at ON public.patient_text_data USING btree (created_at DESC) WITH (checksum='on');
CREATE INDEX idx_text_patient_id ON public.patient_text_data USING btree (patient_id) WITH (checksum='on');
ALTER TABLE patient_text_data ADD CONSTRAINT patient_text_data_pkey PRIMARY KEY (id) WITH (checksum='on');





2.patient_ct_data

SET search_path = public;
CREATE TABLE patient_ct_data (
    id integer GENERATED ALWAYS AS (nextval('patient_ct_data_id_seq'::regclass)) STORED NOT NULL,
    patient_id integer NOT NULL,
    body_part character varying(50) GENERATED ALWAYS AS ('lung'::character varying) STORED NOT NULL,
    ct_url text,
    status character varying(20) GENERATED ALWAYS AS ('pending'::character varying) STORED,
    error_message text,
    created_at timestamp without time zone GENERATED ALWAYS AS (CURRENT_TIMESTAMP) STORED,
    analysis_result text,
    ai_analysis text,
    final_analysis text,
    edited boolean GENERATED ALWAYS AS (false) STORED,
    edited_by integer,
    edit_reason text,
    version integer GENERATED ALWAYS AS (1) STORED,
    analyzed_at timestamp without time zone,
    reviewed_at timestamp without time zone,
    CONSTRAINT patient_ct_data_status_check CHECK (((status)::text = ANY ((ARRAY['pending'::character varying, 'processing'::character varying, 'completed'::character varying, 'failed'::character varying, 'reviewed'::character varying, 'approved'::character varying])::text[]))),
    CONSTRAINT patient_ct_data_edited_by_fkey2 FOREIGN KEY (edited_by) REFERENCES users(id),
    CONSTRAINT patient_ct_data_edited_by_fkey1 FOREIGN KEY (edited_by) REFERENCES users(id),
    CONSTRAINT patient_ct_data_edited_by_fkey FOREIGN KEY (edited_by) REFERENCES users(id),
    CONSTRAINT patient_ct_data_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES patients(patient_id) ON DELETE CASCADE,
    CONSTRAINT patient_ct_data_body_part_check CHECK (((body_part)::text = ANY ((ARRAY['lung'::character varying, 'liver'::character varying, 'kidney'::character varying, 'brain'::character varying])::text[])))
)
WITH (checksum=on);
COMMENT ON TABLE patient_ct_data IS 'CT 影像数据表';
COMMENT ON COLUMN patient_ct_data.body_part IS 'CT 扫描部位: lung-肺部, liver-肝脏, kidney-肾脏, brain-脑部';
COMMENT ON COLUMN patient_ct_data.ct_url IS '原始 CT 影像 URL';
COMMENT ON COLUMN patient_ct_data.status IS '复审状态: pending-待复审, reviewed-已复审, approved-已确认';
COMMENT ON COLUMN patient_ct_data.ai_analysis IS 'AI原始分析结果（不可修改）';
COMMENT ON COLUMN patient_ct_data.final_analysis IS '医生复审后的最终分析';
COMMENT ON COLUMN patient_ct_data.edited IS '是否被医生编辑过';
COMMENT ON COLUMN patient_ct_data.edited_by IS '复审医生ID';
COMMENT ON COLUMN patient_ct_data.edit_reason IS '编辑原因或复审意见';
COMMENT ON COLUMN patient_ct_data.version IS '版本号（每次编辑+1）';
COMMENT ON COLUMN patient_ct_data.analyzed_at IS 'AI分析完成时间';
COMMENT ON COLUMN patient_ct_data.reviewed_at IS '医生复审时间';
CREATE INDEX idx_ct_data_reviewed ON public.patient_ct_data USING btree (edited_by, reviewed_at) WITH (checksum='on');
CREATE INDEX idx_ct_data_status ON public.patient_ct_data USING btree (patient_id, status) WITH (checksum='on');
CREATE INDEX idx_ct_created_at ON public.patient_ct_data USING btree (created_at DESC) WITH (checksum='on');
CREATE INDEX idx_ct_body_part ON public.patient_ct_data USING btree (body_part) WITH (checksum='on');
CREATE INDEX idx_ct_patient_id ON public.patient_ct_data USING btree (patient_id) WITH (checksum='on');
ALTER TABLE patient_ct_data ADD CONSTRAINT patient_ct_data_pkey PRIMARY KEY (id) WITH (checksum='on');





3.patient_lab_data

SET search_path = public;
CREATE TABLE patient_lab_data (
    id integer GENERATED ALWAYS AS (nextval('patient_lab_data_id_seq'::regclass)) STORED NOT NULL,
    patient_id integer NOT NULL,
    lab_url text,
    lab_data jsonb,
    status character varying(20) GENERATED ALWAYS AS ('pending'::character varying) STORED,
    error_message text,
    created_at timestamp without time zone GENERATED ALWAYS AS (CURRENT_TIMESTAMP) STORED,
    lab_json jsonb,
    ai_interpretation text,
    final_interpretation text,
    edited boolean GENERATED ALWAYS AS (false) STORED,
    edited_by integer,
    edit_reason text,
    version integer GENERATED ALWAYS AS (1) STORED,
    analyzed_at timestamp without time zone,
    reviewed_at timestamp without time zone,
    CONSTRAINT patient_lab_data_status_check CHECK (((status)::text = ANY ((ARRAY['pending'::character varying, 'processing'::character varying, 'completed'::character varying, 'failed'::character varying, 'reviewed'::character varying, 'approved'::character varying])::text[]))),
    CONSTRAINT patient_lab_data_edited_by_fkey2 FOREIGN KEY (edited_by) REFERENCES users(id),
    CONSTRAINT patient_lab_data_edited_by_fkey1 FOREIGN KEY (edited_by) REFERENCES users(id),
    CONSTRAINT patient_lab_data_edited_by_fkey FOREIGN KEY (edited_by) REFERENCES users(id),
    CONSTRAINT patient_lab_data_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES patients(patient_id) ON DELETE CASCADE
)
WITH (checksum=on);
COMMENT ON TABLE patient_lab_data IS '实验室指标数据表';
COMMENT ON COLUMN patient_lab_data.lab_data IS 'AI 提取的实验室指标 JSON 数据';
COMMENT ON COLUMN patient_lab_data.status IS '复审状态: pending-待复审, reviewed-已复审, approved-已确认';
COMMENT ON COLUMN patient_lab_data.ai_interpretation IS 'AI原始解读结果（不可修改）';
COMMENT ON COLUMN patient_lab_data.final_interpretation IS '医生复审后的最终解读';
COMMENT ON COLUMN patient_lab_data.edited IS '是否被医生编辑过';
COMMENT ON COLUMN patient_lab_data.edited_by IS '复审医生ID';
COMMENT ON COLUMN patient_lab_data.edit_reason IS '编辑原因或复审意见';
COMMENT ON COLUMN patient_lab_data.version IS '版本号（每次编辑+1）';
COMMENT ON COLUMN patient_lab_data.analyzed_at IS 'AI分析完成时间';
COMMENT ON COLUMN patient_lab_data.reviewed_at IS '医生复审时间';
CREATE INDEX idx_lab_data_reviewed ON public.patient_lab_data USING btree (edited_by, reviewed_at) WITH (checksum='on');
CREATE INDEX idx_lab_data_status ON public.patient_lab_data USING btree (patient_id, status) WITH (checksum='on');
CREATE INDEX idx_lab_created_at ON public.patient_lab_data USING btree (created_at DESC) WITH (checksum='on');
CREATE INDEX idx_lab_patient_id ON public.patient_lab_data USING btree (patient_id) WITH (checksum='on');
ALTER TABLE patient_lab_data ADD CONSTRAINT patient_lab_data_pkey PRIMARY KEY (id) WITH (checksum='on');





4.patient_diagnosis

SET search_path = public;
CREATE TABLE patient_diagnosis (
    id integer GENERATED ALWAYS AS (nextval('patient_diagnosis_id_seq'::regclass)) STORED NOT NULL,
    patient_id integer NOT NULL,
    diagnosis_text text NOT NULL,
    confidence_score numeric(3,2),
    doctor_review text,
    reviewed_at timestamp without time zone,
    created_at timestamp without time zone GENERATED ALWAYS AS (CURRENT_TIMESTAMP) STORED,
    condition_updated boolean GENERATED ALWAYS AS (false) STORED,
    evidence_json jsonb,
    ai_diagnosis text,
    final_diagnosis text,
    diagnosis_basis jsonb,
    treatment_plan text,
    medical_advice text,
    risk_score integer,
    edited boolean GENERATED ALWAYS AS (false) STORED,
    edited_by integer,
    edit_reason text,
    version integer GENERATED ALWAYS AS (1) STORED,
    status character varying(20) GENERATED ALWAYS AS ('draft'::character varying) STORED,
    diagnosed_at timestamp without time zone,
    confirmed_at timestamp without time zone,
    CONSTRAINT patient_diagnosis_edited_by_fkey2 FOREIGN KEY (edited_by) REFERENCES users(id),
    CONSTRAINT patient_diagnosis_edited_by_fkey1 FOREIGN KEY (edited_by) REFERENCES users(id),
    CONSTRAINT patient_diagnosis_edited_by_fkey FOREIGN KEY (edited_by) REFERENCES users(id),
    CONSTRAINT patient_diagnosis_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES patients(patient_id) ON DELETE CASCADE
)
WITH (checksum=on);
COMMENT ON TABLE patient_diagnosis IS '综合诊断表';
COMMENT ON COLUMN patient_diagnosis.diagnosis_text IS 'AI 生成的综合诊断结论';
COMMENT ON COLUMN patient_diagnosis.confidence_score IS '诊断置信度 0.00-1.00';
COMMENT ON COLUMN patient_diagnosis.doctor_review IS '医生审核意见';
COMMENT ON COLUMN patient_diagnosis.condition_updated IS '标记该诊断是否已用于更新患者最新病症字段';
COMMENT ON COLUMN patient_diagnosis.evidence_json IS '关键诊断证据（多模态，JSON格式）';
COMMENT ON COLUMN patient_diagnosis.ai_diagnosis IS 'AI原始综合诊断（不可修改）';
COMMENT ON COLUMN patient_diagnosis.final_diagnosis IS '医生确认后的最终诊断';
COMMENT ON COLUMN patient_diagnosis.diagnosis_basis IS '诊断依据（JSON格式，包含病历、影像、检验依据）';
COMMENT ON COLUMN patient_diagnosis.treatment_plan IS '治疗方案';
COMMENT ON COLUMN patient_diagnosis.medical_advice IS '医嘱';
COMMENT ON COLUMN patient_diagnosis.risk_score IS '风险评分（1-10分）';
COMMENT ON COLUMN patient_diagnosis.edited IS '是否被医生编辑过';
COMMENT ON COLUMN patient_diagnosis.edited_by IS '诊断医生ID';
COMMENT ON COLUMN patient_diagnosis.edit_reason IS '编辑原因或审核意见';
COMMENT ON COLUMN patient_diagnosis.version IS '版本号（每次编辑+1）';
COMMENT ON COLUMN patient_diagnosis.status IS '诊断状态: draft-草稿, confirmed-已确认, completed-已完成';
COMMENT ON COLUMN patient_diagnosis.diagnosed_at IS '诊断时间';
COMMENT ON COLUMN patient_diagnosis.confirmed_at IS '确认时间';
CREATE INDEX idx_diagnosis_risk ON public.patient_diagnosis USING btree (risk_score DESC) WITH (checksum='on');
CREATE INDEX idx_diagnosis_doctor ON public.patient_diagnosis USING btree (edited_by, diagnosed_at) WITH (checksum='on');
CREATE INDEX idx_diagnosis_status ON public.patient_diagnosis USING btree (patient_id, status) WITH (checksum='on');
CREATE INDEX idx_diagnosis_evidence_json ON public.patient_diagnosis USING gin (evidence_json) WITH (checksum='on');
CREATE INDEX idx_diagnosis_created_at ON public.patient_diagnosis USING btree (created_at DESC) WITH (checksum='on');
CREATE INDEX idx_diagnosis_patient_id ON public.patient_diagnosis USING btree (patient_id) WITH (checksum='on');
ALTER TABLE patient_diagnosis ADD CONSTRAINT patient_diagnosis_pkey PRIMARY KEY (id) WITH (checksum='on');



5.analysis_tasks

SET search_path = public;
CREATE TABLE analysis_tasks (
    task_id integer GENERATED ALWAYS AS (nextval('analysis_tasks_task_id_seq'::regclass)) STORED NOT NULL,
    patient_id integer NOT NULL,
    task_type character varying(50) NOT NULL,
    status character varying(20) GENERATED ALWAYS AS ('pending'::character varying) STORED,
    result jsonb,
    error_message text,
    started_at timestamp without time zone,
    completed_at timestamp without time zone,
    created_at timestamp without time zone GENERATED ALWAYS AS (CURRENT_TIMESTAMP) STORED,
    CONSTRAINT analysis_tasks_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES patients(patient_id) ON DELETE CASCADE,
    CONSTRAINT analysis_tasks_status_check CHECK (((status)::text = ANY ((ARRAY['pending'::character varying, 'processing'::character varying, 'completed'::character varying, 'failed'::character varying])::text[]))),
    CONSTRAINT analysis_tasks_task_type_check CHECK (((task_type)::text = ANY ((ARRAY['text'::character varying, 'ct'::character varying, 'lab'::character varying, 'diagnosis'::character varying])::text[])))
)
WITH (checksum=on);
COMMENT ON TABLE analysis_tasks IS 'AI 分析任务跟踪表';
COMMENT ON COLUMN analysis_tasks.task_type IS '任务类型: text-病历分析, ct-CT分析, lab-实验室指标, diagnosis-综合诊断';
CREATE INDEX idx_tasks_created_at ON public.analysis_tasks USING btree (created_at DESC) WITH (checksum='on');
CREATE INDEX idx_tasks_type ON public.analysis_tasks USING btree (task_type) WITH (checksum='on');
CREATE INDEX idx_tasks_status ON public.analysis_tasks USING btree (status) WITH (checksum='on');
CREATE INDEX idx_tasks_patient_id ON public.analysis_tasks USING btree (patient_id) WITH (checksum='on');
ALTER TABLE analysis_tasks ADD CONSTRAINT analysis_tasks_pkey PRIMARY KEY (task_id) WITH (checksum='on');



6.ai_model_list

SET search_path = public;
CREATE TABLE ai_model_list (
    model_name text NOT NULL,
    model_provider text,
    request_type text NOT NULL,
    request_header http_header[],
    uri text NOT NULL,
    content_type text NOT NULL,
    default_args jsonb NOT NULL,
    json_path text NOT NULL
)
WITH (checksum=on);
ALTER TABLE ai_model_list ADD CONSTRAINT ai_model_list_pkey PRIMARY KEY (model_name) WITH (checksum='on');





7.audit_logs

SET search_path = public;
CREATE TABLE audit_logs (
    id integer GENERATED ALWAYS AS (nextval('audit_logs_id_seq'::regclass)) STORED NOT NULL,
    user_id integer,
    patient_id integer,
    action character varying(50) NOT NULL,
    resource character varying(50),
    resource_id integer,
    old_value jsonb,
    new_value jsonb,
    ip_address character varying(45),
    user_agent text,
    created_at timestamp without time zone GENERATED ALWAYS AS (now()) STORED,
    metadata jsonb,
    CONSTRAINT audit_logs_user_id_fkey FOREIGN KEY (user_id) REFERENCES users(id)
)
WITH (checksum=on);
COMMENT ON TABLE audit_logs IS '审计日志表';
COMMENT ON COLUMN audit_logs.action IS '操作动作';
COMMENT ON COLUMN audit_logs.resource IS '操作的资源类型';
COMMENT ON COLUMN audit_logs.metadata IS '审计补充信息，例如模型版本、提示词、阈值配置';
CREATE INDEX idx_audit_logs_created ON public.audit_logs USING btree (created_at DESC) WITH (checksum='on');
CREATE INDEX idx_audit_logs_resource ON public.audit_logs USING btree (resource, resource_id) WITH (checksum='on');
CREATE INDEX idx_audit_logs_user ON public.audit_logs USING btree (user_id, created_at) WITH (checksum='on');
CREATE INDEX idx_audit_action ON public.audit_logs USING btree (action) WITH (checksum='on');
CREATE INDEX idx_audit_patient ON public.audit_logs USING btree (patient_id) WITH (checksum='on');
CREATE INDEX idx_audit_user ON public.audit_logs USING btree (user_id) WITH (checksum='on');
ALTER TABLE audit_logs ADD CONSTRAINT audit_logs_pkey PRIMARY KEY (id) WITH (checksum='on');



8.departments

SET search_path = public;
CREATE TABLE departments (
    id integer GENERATED ALWAYS AS (nextval('departments_id_seq'::regclass)) STORED NOT NULL,
    name character varying(50) NOT NULL,
    code character varying(20) NOT NULL,
    description text,
    created_at timestamp without time zone GENERATED ALWAYS AS (now()) STORED,
    updated_at timestamp without time zone GENERATED ALWAYS AS (now()) STORED,
    head_doctor_id integer,
    CONSTRAINT fk_departments_head_doctor FOREIGN KEY (head_doctor_id) REFERENCES users(id)
)
WITH (checksum=on);
COMMENT ON TABLE departments IS '科室表';
COMMENT ON COLUMN departments.name IS '科室名称';
COMMENT ON COLUMN departments.code IS '科室代码';
COMMENT ON COLUMN departments.description IS '科室描述';
ALTER TABLE departments ADD CONSTRAINT departments_code_key UNIQUE (code) WITH (checksum='on');
ALTER TABLE departments ADD CONSTRAINT departments_pkey PRIMARY KEY (id) WITH (checksum='on');



9.diagnosis_results

SET search_path = public;
CREATE TABLE diagnosis_results (
    id integer GENERATED ALWAYS AS (nextval('diagnosis_results_id_seq'::regclass)) STORED NOT NULL,
    patient_id integer NOT NULL,
    diagnosis_text text NOT NULL,
    confidence double precision NOT NULL,
    evidence jsonb NOT NULL,
    created_at timestamp without time zone GENERATED ALWAYS AS (CURRENT_TIMESTAMP) STORED,
    CONSTRAINT diagnosis_results_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES patients(patient_id)
)
WITH (checksum=on);
COMMENT ON TABLE diagnosis_results IS '患者诊断结果表';
COMMENT ON COLUMN diagnosis_results.diagnosis_text IS '诊断文本结论';
COMMENT ON COLUMN diagnosis_results.confidence IS '诊断置信度';
COMMENT ON COLUMN diagnosis_results.evidence IS '诊断依据的证据';
ALTER TABLE diagnosis_results ADD CONSTRAINT diagnosis_results_pkey PRIMARY KEY (id) WITH (checksum='on');





10.evidence_training

SET search_path = public;
CREATE TABLE evidence_training (
    id integer GENERATED ALWAYS AS (nextval('evidence_training_id_seq'::regclass)) STORED NOT NULL,
    case_id integer NOT NULL,
    features jsonb NOT NULL,
    label integer NOT NULL,
    created_at timestamp without time zone GENERATED ALWAYS AS (CURRENT_TIMESTAMP) STORED,
    CONSTRAINT evidence_training_case_id_fkey FOREIGN KEY (case_id) REFERENCES patients(patient_id)
)
WITH (checksum=on);
COMMENT ON TABLE evidence_training IS '证据权重学习的训练样本表';
COMMENT ON COLUMN evidence_training.features IS '各模态证据特征 {text: [], ct: [], lab: []}';
COMMENT ON COLUMN evidence_training.label IS '人工标注的相关性标签';
ALTER TABLE evidence_training ADD CONSTRAINT evidence_training_pkey PRIMARY KEY (id) WITH (checksum='on');





11.evidence_weights

SET search_path = public;
CREATE TABLE evidence_weights (
    id integer GENERATED ALWAYS AS (nextval('evidence_weights_id_seq'::regclass)) STORED NOT NULL,
    modality text NOT NULL,
    key text NOT NULL,
    weight double precision NOT NULL,
    version integer GENERATED ALWAYS AS (1) STORED NOT NULL,
    metrics jsonb,
    updated_at timestamp without time zone GENERATED ALWAYS AS (CURRENT_TIMESTAMP) STORED
)
WITH (checksum=on);
COMMENT ON TABLE evidence_weights IS '各模态证据特征的学习权重表';
ALTER TABLE evidence_weights ADD CONSTRAINT evidence_weights_modality_key_version_key UNIQUE (modality, key, version) WITH (checksum='on');
ALTER TABLE evidence_weights ADD CONSTRAINT evidence_weights_pkey PRIMARY KEY (id) WITH (checksum='on');



12.examination_orders

SET search_path = public;
CREATE TABLE examination_orders (
    id integer GENERATED ALWAYS AS (nextval('examination_orders_id_seq'::regclass)) STORED NOT NULL,
    patient_id integer,
    order_type character varying(30) NOT NULL,
    order_name character varying(100) NOT NULL,
    clinical_diagnosis text,
    examination_purpose text,
    priority character varying(20) GENERATED ALWAYS AS ('normal'::character varying) STORED,
    requesting_doctor_id integer,
    requesting_department_id integer,
    target_department_id integer,
    executor_id integer,
    result_id integer,
    result_type character varying(30),
    status character varying(30) GENERATED ALWAYS AS ('pending'::character varying) STORED,
    ordered_at timestamp without time zone GENERATED ALWAYS AS (now()) STORED,
    started_at timestamp without time zone,
    completed_at timestamp without time zone,
    notes text,
    created_at timestamp without time zone GENERATED ALWAYS AS (now()) STORED,
    updated_at timestamp without time zone GENERATED ALWAYS AS (now()) STORED,
    CONSTRAINT examination_orders_executor_id_fkey FOREIGN KEY (executor_id) REFERENCES users(id),
    CONSTRAINT examination_orders_target_department_id_fkey FOREIGN KEY (target_department_id) REFERENCES departments(id),
    CONSTRAINT examination_orders_requesting_department_id_fkey FOREIGN KEY (requesting_department_id) REFERENCES departments(id),
    CONSTRAINT examination_orders_requesting_doctor_id_fkey FOREIGN KEY (requesting_doctor_id) REFERENCES users(id),
    CONSTRAINT examination_orders_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES patients(patient_id)
)
WITH (checksum=on);
COMMENT ON TABLE examination_orders IS '检查申请单表';
COMMENT ON COLUMN examination_orders.order_type IS '检查类型';
COMMENT ON COLUMN examination_orders.status IS '申请单状态';
CREATE INDEX idx_exam_orders_target ON public.examination_orders USING btree (target_department_id, status) WITH (checksum='on');
CREATE INDEX idx_exam_orders_requesting ON public.examination_orders USING btree (requesting_doctor_id, status) WITH (checksum='on');
CREATE INDEX idx_exam_orders_patient ON public.examination_orders USING btree (patient_id, status) WITH (checksum='on');
CREATE INDEX idx_exam_orders_status ON public.examination_orders USING btree (status, target_department_id) WITH (checksum='on');
ALTER TABLE examination_orders ADD CONSTRAINT examination_orders_pkey PRIMARY KEY (id) WITH (checksum='on');



13.model_calibration

SET search_path = public;
CREATE TABLE model_calibration (
    id integer GENERATED ALWAYS AS (nextval('model_calibration_id_seq'::regclass)) STORED NOT NULL,
    model_key character varying(100) NOT NULL,
    calibration_method character varying(50) NOT NULL,
    parameters jsonb NOT NULL,
    metrics jsonb,
    effective_from timestamp without time zone GENERATED ALWAYS AS (CURRENT_TIMESTAMP) STORED,
    created_at timestamp without time zone GENERATED ALWAYS AS (CURRENT_TIMESTAMP) STORED,
    updated_at timestamp without time zone GENERATED ALWAYS AS (CURRENT_TIMESTAMP) STORED
)
WITH (checksum=on);
COMMENT ON TABLE model_calibration IS '模型置信度校准参数表';
COMMENT ON COLUMN model_calibration.model_key IS '模型或流程标识，如 smart_diagnosis_v2';
CREATE UNIQUE INDEX uq_model_calibration_latest ON public.model_calibration USING btree (model_key, effective_from DESC) WITH (checksum='on');
ALTER TABLE model_calibration ADD CONSTRAINT model_calibration_pkey PRIMARY KEY (id) WITH (checksum='on');



14.patients

SET search_path = public;
CREATE TABLE patients (
    patient_id integer GENERATED ALWAYS AS (nextval('patients_patient_id_seq'::regclass)) STORED NOT NULL,
    name character varying(100) NOT NULL,
    age integer,
    gender character varying(10),
    phone character varying(20),
    id_card character varying(50),
    first_visit boolean GENERATED ALWAYS AS (true) STORED,
    created_at timestamp without time zone GENERATED ALWAYS AS (CURRENT_TIMESTAMP) STORED,
    updated_at timestamp without time zone GENERATED ALWAYS AS (CURRENT_TIMESTAMP) STORED,
    status character varying(30) GENERATED ALWAYS AS ('active'::character varying) STORED,
    current_stage character varying(50) GENERATED ALWAYS AS ('initial'::character varying) STORED,
    assigned_doctor_id integer,
    past_medical_history text,
    latest_condition text,
    condition_updated_at timestamp without time zone,
    medical_history text,
    CONSTRAINT patients_assigned_doctor_id_fkey3 FOREIGN KEY (assigned_doctor_id) REFERENCES users(id),
    CONSTRAINT patients_assigned_doctor_id_fkey2 FOREIGN KEY (assigned_doctor_id) REFERENCES users(id),
    CONSTRAINT patients_assigned_doctor_id_fkey1 FOREIGN KEY (assigned_doctor_id) REFERENCES users(id),
    CONSTRAINT patients_assigned_doctor_id_fkey FOREIGN KEY (assigned_doctor_id) REFERENCES users(id),
    CONSTRAINT patients_gender_check CHECK (((gender)::text = ANY ((ARRAY['男'::character varying, '女'::character varying, '其他'::character varying])::text[]))),
    CONSTRAINT patients_age_check CHECK (((age >= 0) AND (age <= 150)))
)
WITH (checksum=on);
COMMENT ON TABLE patients IS '患者基本信息表';
COMMENT ON COLUMN patients.first_visit IS '是否首次就诊';
COMMENT ON COLUMN patients.status IS '患者档案状态';
COMMENT ON COLUMN patients.current_stage IS '当前诊疗阶段';
COMMENT ON COLUMN patients.assigned_doctor_id IS '当前负责医生ID';
COMMENT ON COLUMN patients.past_medical_history IS '过往病史：包括慢性病史、过敏史、手术史、家族史等，首次就诊时录入';
COMMENT ON COLUMN patients.latest_condition IS '最新病症：AI自动整合的病情总结，包含过往病史+近期诊断';
COMMENT ON COLUMN patients.condition_updated_at IS '最新病症更新时间';
COMMENT ON COLUMN patients.medical_history IS '既往病史';
CREATE INDEX idx_patients_created_at ON public.patients USING btree (created_at DESC) WITH (checksum='on');
CREATE INDEX idx_patients_phone ON public.patients USING btree (phone) WITH (checksum='on');
CREATE INDEX idx_patients_name ON public.patients USING btree (name) WITH (checksum='on');
ALTER TABLE patients ADD CONSTRAINT patients_pkey PRIMARY KEY (patient_id) WITH (checksum='on');





15.prescriptions

SET search_path = public;
CREATE TABLE prescriptions (
    id integer GENERATED ALWAYS AS (nextval('prescriptions_id_seq'::regclass)) STORED NOT NULL,
    patient_id integer,
    doctor_id integer,
    diagnosis_id integer,
    medications jsonb NOT NULL,
    instructions text,
    notes text,
    status character varying(20) GENERATED ALWAYS AS ('active'::character varying) STORED,
    created_at timestamp without time zone GENERATED ALWAYS AS (now()) STORED,
    updated_at timestamp without time zone GENERATED ALWAYS AS (now()) STORED,
    CONSTRAINT prescriptions_diagnosis_id_fkey FOREIGN KEY (diagnosis_id) REFERENCES patient_diagnosis(id),
    CONSTRAINT prescriptions_doctor_id_fkey FOREIGN KEY (doctor_id) REFERENCES users(id),
    CONSTRAINT prescriptions_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES patients(patient_id)
)
WITH (checksum=on);
COMMENT ON TABLE prescriptions IS '处方表';
CREATE INDEX idx_prescriptions_diagnosis ON public.prescriptions USING btree (diagnosis_id) WITH (checksum='on');
CREATE INDEX idx_prescriptions_doctor ON public.prescriptions USING btree (doctor_id) WITH (checksum='on');
CREATE INDEX idx_prescriptions_patient ON public.prescriptions USING btree (patient_id) WITH (checksum='on');
ALTER TABLE prescriptions ADD CONSTRAINT prescriptions_pkey PRIMARY KEY (id) WITH (checksum='on');





16.review_queue

SET search_path = public;
CREATE TABLE review_queue (
    id integer GENERATED ALWAYS AS (nextval('review_queue_id_seq'::regclass)) STORED NOT NULL,
    patient_id integer NOT NULL,
    diagnosis_id integer,
    source character varying(50) NOT NULL,
    reason text NOT NULL,
    details jsonb,
    status character varying(20) GENERATED ALWAYS AS ('pending'::character varying) STORED NOT NULL,
    priority character varying(20) GENERATED ALWAYS AS ('medium'::character varying) STORED,
    reviewer_id integer,
    resolved_at timestamp without time zone,
    resolution_notes text,
    created_at timestamp without time zone GENERATED ALWAYS AS (CURRENT_TIMESTAMP) STORED,
    CONSTRAINT review_queue_reviewer_id_fkey FOREIGN KEY (reviewer_id) REFERENCES users(id),
    CONSTRAINT review_queue_diagnosis_id_fkey FOREIGN KEY (diagnosis_id) REFERENCES patient_diagnosis(id) ON DELETE SET NULL,
    CONSTRAINT review_queue_patient_id_fkey FOREIGN KEY (patient_id) REFERENCES patients(patient_id) ON DELETE CASCADE,
    CONSTRAINT review_queue_priority_check CHECK (((priority)::text = ANY ((ARRAY['low'::character varying, 'medium'::character varying, 'high'::character varying])::text[]))),
    CONSTRAINT review_queue_status_check CHECK (((status)::text = ANY ((ARRAY['pending'::character varying, 'in_review'::character varying, 'resolved'::character varying])::text[])))
)
WITH (checksum=on);
COMMENT ON TABLE review_queue IS '多模态一致性复核队列';
COMMENT ON COLUMN review_queue.details IS '存储冲突的结构化明细 JSON';
CREATE INDEX idx_review_queue_priority ON public.review_queue USING btree (priority, created_at DESC) WITH (checksum='on');
CREATE INDEX idx_review_queue_patient ON public.review_queue USING btree (patient_id, created_at DESC) WITH (checksum='on');
CREATE INDEX idx_review_queue_status ON public.review_queue USING btree (status) WITH (checksum='on');
ALTER TABLE review_queue ADD CONSTRAINT review_queue_pkey PRIMARY KEY (id) WITH (checksum='on');



17.users

SET search_path = public;
CREATE TABLE users (
    id integer GENERATED ALWAYS AS (nextval('users_id_seq'::regclass)) STORED NOT NULL,
    username character varying(50) NOT NULL,
    password_hash character varying(255) NOT NULL,
    name character varying(50),
    role character varying(30) NOT NULL,
    department_id integer,
    email character varying(100),
    phone character varying(20),
    status character varying(20) GENERATED ALWAYS AS ('active'::character varying) STORED,
    last_login_at timestamp without time zone,
    created_at timestamp without time zone GENERATED ALWAYS AS (now()) STORED,
    updated_at timestamp without time zone GENERATED ALWAYS AS (now()) STORED,
    CONSTRAINT users_department_id_fkey FOREIGN KEY (department_id) REFERENCES departments(id)
)
WITH (checksum=on);
COMMENT ON TABLE users IS '用户表';
COMMENT ON COLUMN users.username IS '用户名';
COMMENT ON COLUMN users.password_hash IS '密码哈希值（bcrypt加密）';
COMMENT ON COLUMN users.role IS '用户角色';
COMMENT ON COLUMN users.status IS '用户状态';
CREATE INDEX idx_users_department ON public.users USING btree (department_id) WITH (checksum='on');
CREATE INDEX idx_users_role ON public.users USING btree (role) WITH (checksum='on');
CREATE INDEX idx_users_username ON public.users USING btree (username) WITH (checksum='on');
ALTER TABLE users ADD CONSTRAINT users_username_key UNIQUE (username) WITH (checksum='on');
ALTER TABLE users ADD CONSTRAINT users_pkey PRIMARY KEY (id) WITH (checksum='on');



















SELECT proname, proargtypes, prorettype
FROM pg_proc
WHERE proname LIKE 'smart_diagnosis%';结果如下：

| proname            | proargtypes | prorettype |
| ------------------ | ----------- | ---------- |
| smart_diagnosis    | 23          | 2249       |
| smart_diagnosis_v2 | 23          | 3802       |





SELECT pg_get_functiondef('smart_diagnosis_v2(integer)'::regprocedure);结果如下：

CREATE OR REPLACE FUNCTION public.smart_diagnosis_v2(p_patient_id integer)
 RETURNS jsonb
 LANGUAGE plpgsql
AS $function$
DECLARE
    v_text_evidence JSONB;
    v_ct_evidence JSONB;
    v_lab_evidence JSONB;
    v_diagnosis TEXT;
    v_confidence FLOAT;
BEGIN
    -- 获取文本证据
    SELECT jsonb_build_object(
        'text_id', id,
        'text_summary', text_summary,
        'key_findings', key_findings
    )
    INTO v_text_evidence
    FROM patient_text_data
    WHERE patient_id = p_patient_id
    ORDER BY created_at DESC
    LIMIT 1;

    -- 获取CT证据
    SELECT jsonb_build_object(
        'ct_id', id,
        'findings', analysis_result,
        'image_url', ct_url
    )
    INTO v_ct_evidence
    FROM patient_ct_data
    WHERE patient_id = p_patient_id
    ORDER BY created_at DESC
    LIMIT 1;
    
    -- 获取实验室指标证据
    SELECT jsonb_build_object(
        'lab_id', id,
        'indicators', lab_json
    )
    INTO v_lab_evidence
    FROM patient_lab_data
    WHERE patient_id = p_patient_id
    ORDER BY created_at DESC
    LIMIT 1;
    
    -- 基于证据生成诊断结论
    -- TODO: 这里可以实现更复杂的诊断逻辑
    v_diagnosis := CASE 
        WHEN v_text_evidence IS NOT NULL AND v_text_evidence->>'text_summary' IS NOT NULL THEN
            v_text_evidence->>'text_summary'
        ELSE
            '未找到足够的诊断证据'
    END;
    
    v_confidence := CASE
        WHEN v_text_evidence IS NOT NULL AND v_ct_evidence IS NOT NULL AND v_lab_evidence IS NOT NULL THEN 0.9
        WHEN v_text_evidence IS NOT NULL AND (v_ct_evidence IS NOT NULL OR v_lab_evidence IS NOT NULL) THEN 0.7
        WHEN v_text_evidence IS NOT NULL THEN 0.5
        ELSE 0.3
    END;
    
    -- 返回诊断结果
    RETURN jsonb_build_object(
        'patient_id', p_patient_id,
        'diagnosis_text', v_diagnosis,
        'confidence', v_confidence,
        'evidence', jsonb_build_object(
            'text', v_text_evidence,
            'ct', v_ct_evidence,
            'lab', v_lab_evidence
        ),
        'timestamp', CURRENT_TIMESTAMP
    );
END;
$function$



