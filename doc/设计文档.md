# 鍖荤枟澶氭ā鎬佹櫤鑳藉垎鏋愬钩鍙?- 璁捐鏂囨。

## 鐩綍

- [1. 绯荤粺鏋舵瀯璁捐](#1-绯荤粺鏋舵瀯璁捐)
  - [1.1 鏁翠綋鏋舵瀯](#11-鏁翠綋鏋舵瀯)
  - [1.2 鎶€鏈€夊瀷](#12-鎶€鏈€夊瀷)
  - [1.3 鏍稿績璁捐鐞嗗康](#13-鏍稿績璁捐鐞嗗康)
- [2. 鏁版嵁搴撹璁(#2-鏁版嵁搴撹璁?
  - [2.1 鏁版嵁搴撻€夊瀷锛歄penTenBase 鍒嗗竷寮忔灦鏋刔(#21-鏁版嵁搴撻€夊瀷opentenbase-鍒嗗竷寮忔灦鏋?
  - [2.2 鏁版嵁琛ㄨ璁(#22-鏁版嵁琛ㄨ璁?
  - [2.3 鍒嗙墖琛ㄨ璁″師鍒橾(#23-鍒嗙墖琛ㄨ璁″師鍒?
  - [2.4 PL/pgSQL 瀛樺偍杩囩▼璁捐](#24-plpgsql-瀛樺偍杩囩▼璁捐)
- [3. 绠楁硶璁捐](#3-绠楁硶璁捐)
  - [3.1 澶氭ā鎬佹暟鎹瀺鍚堢畻娉昡(#31-澶氭ā鎬佹暟鎹瀺鍚堢畻娉?
  - [3.2 鍔ㄦ€佸姞鏉冩満鍒禲(#32-鍔ㄦ€佸姞鏉冩満鍒?
  - [3.3 寮傚父涓ラ噸绋嬪害鍒嗙骇绠楁硶](#33-寮傚父涓ラ噸绋嬪害鍒嗙骇绠楁硶)
  - [3.4 缃俊搴︽牎鍑嗙畻娉昡(#34-缃俊搴︽牎鍑嗙畻娉?
- [4. 鏅鸿兘璇婃柇娴佺▼璁捐](#4-鏅鸿兘璇婃柇娴佺▼璁捐)
  - [4.1 鏁版嵁搴撶璇婃柇娴佺▼](#41-鏁版嵁搴撶璇婃柇娴佺▼)
  - [4.2 寮傛浠诲姟闃熷垪璁捐](#42-寮傛浠诲姟闃熷垪璁捐)
- [5. AI 鎻掍欢闆嗘垚璁捐](#5-ai-鎻掍欢闆嗘垚璁捐)
  - [5.1 opentenbase_ai 鎻掍欢鏋舵瀯](#51-opentenbase_ai-鎻掍欢鏋舵瀯)
  - [5.2 AI 璋冪敤浼樺寲绛栫暐](#52-ai-璋冪敤浼樺寲绛栫暐)
- [6. 鎬ц兘浼樺寲璁捐](#6-鎬ц兘浼樺寲璁捐)
  - [6.1 鏌ヨ鎬ц兘浼樺寲](#61-鏌ヨ鎬ц兘浼樺寲)
  - [6.2 缃戠粶浼犺緭浼樺寲](#62-缃戠粶浼犺緭浼樺寲)
  - [6.3 AI 璋冪敤鎬ц兘浼樺寲](#63-ai-璋冪敤鎬ц兘浼樺寲)

---

## 1. 绯荤粺鏋舵瀯璁捐

### 1.1 鏁翠綋鏋舵瀯

鏈郴缁熼噰鐢?**鍥涘眰鏋舵瀯璁捐**锛屾牳蹇冨垱鏂板湪浜庡皢 AI 鑳藉姏鍐呯疆浜庢暟鎹簱灞傦紝瀹炵幇浜嗛珮鏁堢殑澶氭ā鎬佹暟鎹垎鏋愩€?

```
鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
鈹? 鍓嶇灞?(Vue 3 + Element Plus)               鈹?
鈹? 鎮ｈ€呯鐞?| 鏁版嵁涓婁紶 | 鏅鸿兘鍒嗘瀽 | PDF 瀵煎嚭    鈹?
鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
                    鈫?HTTP REST API
鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
鈹? 鍚庣灞?(Node.js + Express)                  鈹?
鈹? API 璺敱 | 涓氬姟鏈嶅姟 | 涓冪墰浜戦泦鎴?            鈹?
鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
                    鈫?SQL
鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
鈹? 鏁版嵁搴撳眰 (OpenTenBase + AI 鎻掍欢)            鈹?
鈹? 鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?    鈹?
鈹? 鈹?PL/pgSQL 鏅鸿兘鍒嗘瀽寮曟搸 (982 琛?    鈹?    鈹?
鈹? 鈹?- 澶氭ā鎬佸叧鑱旀煡璇?                  鈹?    鈹?
鈹? 鈹?- 鏁版嵁璐ㄩ噺璇勪及锛堝姩鎬佸姞鏉冿級         鈹?    鈹?
鈹? 鈹?- 寮傚父涓ラ噸绋嬪害鍒嗙骇锛埾冨亸绂诲害锛?     鈹?    鈹?
鈹? 鈹?- 缃俊搴︽牎鍑嗭紙92%涓婇檺锛?           鈹?    鈹?
鈹? 鈹?- 璇佹嵁鎻愬彇涓庢潈閲嶈绠?              鈹?    鈹?
鈹? 鈹?- AI 璇婃柇鐢熸垚                     鈹?    鈹?
鈹? 鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?    鈹?
鈹? 鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?    鈹?
鈹? 鈹?AI 鎻掍欢 (opentenbase_ai)          鈹?    鈹?
鈹? 鈹?- ai.image() - OCR/鍥惧儚鍒嗘瀽        鈹?    鈹?
鈹? 鈹?- ai.generate_text() - 鏂囨湰鐢熸垚    鈹?    鈹?
鈹? 鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?    鈹?
鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
                    鈫?
鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
鈹? 浜戝瓨鍌ㄥ眰 (涓冪墰浜?CDN)                       鈹?
鈹? 鐥呭巻鍥剧墖 | CT 褰卞儚 | 瀹為獙瀹ゆ寚鏍囪〃鏍?         鈹?
鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
```

**鏋舵瀯鐗圭偣**锛?

1. **AI 鑳藉姏涓嬫矇**锛氬皢浼犵粺鐨勫簲鐢ㄥ眰 AI 璋冪敤涓嬫矇鍒版暟鎹簱灞傦紝鍑忓皯 75% 缃戠粶寰€杩?
2. **鏁版嵁灏辫繎澶勭悊**锛氭暟鎹湪瀛樺偍浣嶇疆鐩存帴瀹屾垚 AI 鍒嗘瀽锛岄伩鍏嶅ぇ閲忔暟鎹紶杈?
3. **鍒嗗竷寮忚绠?*锛氬埄鐢?OpenTenBase 鍒嗗竷寮忔灦鏋勶紝骞惰澶勭悊澶氭ā鎬佹暟鎹?
4. **寮傛浠诲姟闃熷垪**锛氶暱鏃堕棿 AI 鍒嗘瀽閲囩敤鍚庡彴浠诲姟+杞鏈哄埗锛屼繚璇佺敤鎴蜂綋楠屾祦鐣?

### 1.2 鎶€鏈€夊瀷

| 鎶€鏈眰 | 鎶€鏈€夊瀷 | 閫夊瀷鐞嗙敱 |
|-------|---------|---------|
| **鍓嶇妗嗘灦** | Vue 3 (Composition API) | 杞婚噺楂樻晥銆佺粍鍚堝紡 API 鏇撮€傚悎澶嶆潅涓氬姟閫昏緫 |
| **UI 缁勪欢搴?* | Element Plus | 涓板瘜鐨勮〃鍗曠粍浠讹紝閫傚悎鍖荤枟鏁版嵁褰曞叆 |
| **鏍峰紡妗嗘灦** | TailwindCSS | 蹇€熸瀯寤哄搷搴斿紡鐣岄潰 |
| **鐘舵€佺鐞?* | Pinia | Vue 瀹樻柟鎺ㄨ崘锛孉PI 绠€娲?|
| **鍚庣妗嗘灦** | Node.js + Express | 寮傛 I/O 閫傚悎楂樺苟鍙戝満鏅?|
| **鏁版嵁搴?* | OpenTenBase | 鍒嗗竷寮?PostgreSQL锛屽唴缃?AI 鎻掍欢 |
| **AI 寮曟搸** | opentenbase_ai 鎻掍欢 | 鏁版嵁搴撳師鐢?AI 鑳藉姏锛屾棤闇€澶栭儴 API |
| **瀵硅薄瀛樺偍** | 涓冪墰浜?| CDN 鍔犻€燂紝鍥剧墖璁块棶閫熷害蹇?|
| **鏃ュ織绯荤粺** | Winston | 鍒嗙骇鏃ュ織锛屾敮鎸佹枃浠惰疆杞?|
| **PDF 鐢熸垚** | jsPDF / pdfmake | 鍓嶇鐩存帴鐢熸垚锛屽噺杞绘湇鍔″櫒鍘嬪姏 |

### 1.3 鏍稿績璁捐鐞嗗康

**1. 鏁版嵁搴撶 AI 璁＄畻**

浼犵粺鏋舵瀯锛?
```
鏁版嵁搴?鈫?搴旂敤灞?鈫?澶栭儴 AI API 鈫?搴旂敤灞?鈫?鏁版嵁搴?
(4 娆＄綉缁滃線杩?+ 鏁版嵁搴忓垪鍖?鍙嶅簭鍒楀寲)
```

鏈郴缁熸灦鏋勶細
```
鏁版嵁搴?鈫?AI 鎻掍欢 鈫?鏁版嵁搴?
(1 娆″唴閮ㄥ嚱鏁拌皟鐢?
```

**鎬ц兘鎻愬崌**锛?
- 缃戠粶寰€杩旀鏁板噺灏?**75%**
- 鏁版嵁浼犺緭閲忓噺灏?**90%**锛堟棤闇€涓婁紶鍘熷鏁版嵁鍒板閮?API锛?
- 鍒嗘瀽寤惰繜闄嶄綆 **60%**

**2. 澶氭ā鎬佹暟鎹粺涓€鍏宠仈**

浣跨敤 **LATERAL JOIN** 瀹炵幇鍥涚妯℃€佹暟鎹殑涓€娆℃€ф煡璇細
```sql
SELECT p.*,
       text_data.summary,
       ct_data.ct_url,
       lab_data.lab_data
FROM patients p
LEFT JOIN LATERAL (
    SELECT final_summary AS summary
    FROM patient_text_data
    WHERE patient_id = p.patient_id
    ORDER BY created_at DESC
    LIMIT 1
) text_data ON true
LEFT JOIN LATERAL (...) ct_data ON true
LEFT JOIN LATERAL (...) lab_data ON true
WHERE p.patient_id = $1
```

**浼樺娍**:
- 涓€鏉?SQL 瀹屾垚澶氳〃鍏宠仈
- 鍒╃敤鍒嗙墖閿紭鍖栵紝閬垮厤璺ㄨ妭鐐规暟鎹氦浜?
- 杩斿洖缁撴瀯鍖?JSON锛岀洿鎺ヤ緵 AI 鍒嗘瀽浣跨敤

---

## 2. 鏁版嵁搴撹璁?

### 2.1 鏁版嵁搴撻€夊瀷锛歄penTenBase 闆嗕腑寮忔灦鏋?

**涓轰粈涔堥€夋嫨 OpenTenBase锛?*

1. **鍒嗗竷寮忔灦鏋?*锛氭敮鎸佹捣閲忓尰鐤楁暟鎹殑姘村钩鎵╁睍
2. **AI 鎻掍欢鏀寔**锛氬唴缃?`opentenbase_ai` 鎻掍欢锛屽彲鐩存帴鍦ㄦ暟鎹簱涓皟鐢?AI 妯″瀷
3. **PostgreSQL 鍏煎**锛氱户鎵?PostgreSQL 鐨勫己澶у姛鑳斤紙JSONB銆佸叏鏂囨绱€丟IS 绛夛級
4. **ACID 浜嬪姟淇濊瘉**锛氱‘淇濆尰鐤楁暟鎹殑涓€鑷存€у拰鍙潬鎬?

**鍒嗙墖绛栫暐**锛?
- **鍒嗙墖閿?*锛歚patient_id`锛堟墍鏈夎〃缁熶竴浣跨敤锛?
- **鍒嗙墖绠楁硶**锛氬搱甯屽垎鐗囷紙HASH锛?
- **浼樺娍**锛氬悓涓€鎮ｈ€呯殑鎵€鏈夋暟鎹瓨鍌ㄥ湪鍚屼竴鏁版嵁鑺傜偣锛岄伩鍏嶈法鑺傜偣 JOIN

### 2.2 鏁版嵁琛ㄨ璁?

#### 鏍稿績涓氬姟琛?

**1. patients锛堟偅鑰呰〃锛?*
```sql
CREATE TABLE patients (
    patient_id SERIAL PRIMARY KEY,           -- 鎮ｈ€?ID锛堜富閿級
    name VARCHAR(100) NOT NULL,              -- 濮撳悕
    age INTEGER NOT NULL,                    -- 骞撮緞
    gender VARCHAR(10) NOT NULL,             -- 鎬у埆
    phone VARCHAR(20),                       -- 鎵嬫満鍙?
    id_card VARCHAR(50),                     -- 韬唤璇佸彿
    first_visit BOOLEAN DEFAULT TRUE,        -- 鏄惁棣栨灏辫瘖
    past_medical_history TEXT,               -- 杩囧線鐥呭彶
    latest_condition TEXT,                   -- 鍘嗗彶鐥呯棁
    condition_updated_at TIMESTAMP,          -- 鐥呯棁鏇存柊鏃堕棿
    created_at TIMESTAMP DEFAULT NOW(),      -- 鍒涘缓鏃堕棿
    updated_at TIMESTAMP DEFAULT NOW()       -- 鏇存柊鏃堕棿
) DISTRIBUTE BY HASH(patient_id);
```

**2. patient_text_data锛堢梾鍘嗘枃鏈暟鎹〃锛?*
```sql
CREATE TABLE patient_text_data (
    id SERIAL PRIMARY KEY,                   -- 璁板綍 ID
    patient_id INTEGER NOT NULL,             -- 鎮ｈ€?ID锛堝垎鐗囬敭锛?
    image_url TEXT,                          -- 鐥呭巻鍥剧墖 URL锛堜竷鐗涗簯锛?
    ai_summary TEXT,                         -- AI 鐢熸垚鐨勬€荤粨
    final_summary TEXT,                      -- 鍖荤敓鏈€缁堝鏍哥殑鎬荤粨
    status VARCHAR(20) DEFAULT 'pending',    -- 鐘舵€侊細pending/approved/rejected
    edited BOOLEAN DEFAULT FALSE,            -- 鏄惁琚尰鐢熺紪杈戣繃
    edited_by INTEGER,                       -- 缂栬緫浜?ID
    edit_reason TEXT,                        -- 缂栬緫鍘熷洜
    version INTEGER DEFAULT 1,               -- 鐗堟湰鍙?
    error_message TEXT,                      -- 閿欒淇℃伅
    analyzed_at TIMESTAMP,                   -- AI 鍒嗘瀽鏃堕棿
    reviewed_at TIMESTAMP,                   -- 鍖荤敓澶嶆牳鏃堕棿
    created_at TIMESTAMP DEFAULT NOW()
) DISTRIBUTE BY HASH(patient_id);
```

**3. patient_ct_data锛圕T 褰卞儚鏁版嵁琛級**
```sql
CREATE TABLE patient_ct_data (
    id SERIAL PRIMARY KEY,
    patient_id INTEGER NOT NULL,
    ct_url TEXT NOT NULL,                    -- 鍘熷 CT 褰卞儚 URL
    segmented_url TEXT,                      -- 鍒嗗壊鍚庣殑寮哄寲褰卞儚 URL
    scan_part VARCHAR(50),                   -- 鎵弿閮ㄤ綅锛坙ung/liver/kidney/brain锛?
    analysis_result TEXT,                    -- AI 褰卞儚鍒嗘瀽缁撴灉
    findings JSONB,                          -- 褰卞儚瀛﹀彂鐜帮紙缁撴瀯鍖栵級
    status VARCHAR(20) DEFAULT 'pending',
    analyzed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
) DISTRIBUTE BY HASH(patient_id);
```

**4. patient_lab_data锛堝疄楠屽鎸囨爣鏁版嵁琛級**
```sql
CREATE TABLE patient_lab_data (
    id SERIAL PRIMARY KEY,
    patient_id INTEGER NOT NULL,
    image_url TEXT,                          -- 瀹為獙瀹ゆ寚鏍囧浘鐗?URL
    lab_data JSONB NOT NULL,                 -- 瀹為獙瀹ゆ寚鏍囨暟鎹紙JSON 鏍煎紡锛?
    status VARCHAR(20) DEFAULT 'pending',
    analyzed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
) DISTRIBUTE BY HASH(patient_id);
```

**瀹為獙瀹ゆ寚鏍?JSON 鏍煎紡绀轰緥**锛?
```json
{
  "鐧界粏鑳炶鏁?: {
    "abbreviation": "WBC",
    "value": 15.2,
    "unit": "10^9/L",
    "reference": "4-10"
  },
  "绾㈢粏鑳炶鏁?: {
    "abbreviation": "RBC",
    "value": 4.5,
    "unit": "10^12/L",
    "reference": "3.5-5.5"
  }
}
```

**5. patient_diagnosis锛堢患鍚堣瘖鏂褰曡〃锛?*
```sql
CREATE TABLE patient_diagnosis (
    id SERIAL PRIMARY KEY,
    patient_id INTEGER NOT NULL,
    diagnosis_text TEXT NOT NULL,            -- 璇婃柇缁撹
    confidence_score DECIMAL(5,2),           -- 缃俊搴﹁瘎鍒嗭紙0-92锛?
    risk_score DECIMAL(5,2),                 -- 椋庨櫓璇勫垎锛?-100锛?
    treatment_plan TEXT,                     -- 娌荤枟鏂规
    follow_up_advice TEXT,                   -- 闅忚寤鸿
    evidence_json JSONB,                     -- 璇佹嵁閾撅紙鍚潈閲嶅拰婧簮锛?
    model_version VARCHAR(50),               -- 浣跨敤鐨?AI 妯″瀷鐗堟湰
    created_by INTEGER,                      -- 鍒涘缓浜?ID
    reviewed_by INTEGER,                     -- 澶嶆牳浜?ID
    status VARCHAR(20) DEFAULT 'pending',
    created_at TIMESTAMP DEFAULT NOW(),
    reviewed_at TIMESTAMP
) DISTRIBUTE BY HASH(patient_id);
```

#### 杈呭姪鍔熻兘琛?

**6. analysis_tasks锛堝垎鏋愪换鍔¤〃锛?*
```sql
CREATE TABLE analysis_tasks (
    task_id SERIAL PRIMARY KEY,
    patient_id INTEGER NOT NULL,
    task_type VARCHAR(50) NOT NULL,          -- 浠诲姟绫诲瀷锛歵ext/ct/lab/diagnosis
    status VARCHAR(20) DEFAULT 'pending',    -- pending/processing/completed/failed
    result JSONB,                            -- 浠诲姟缁撴灉
    error_message TEXT,                      -- 閿欒淇℃伅
    created_at TIMESTAMP DEFAULT NOW(),
    started_at TIMESTAMP,
    completed_at TIMESTAMP
) DISTRIBUTE BY HASH(patient_id);
```

**7. users锛堢敤鎴疯〃锛?*
```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,     -- bcrypt 鍔犲瘑
    role VARCHAR(20) DEFAULT 'doctor',       -- doctor/admin
    name VARCHAR(100),
    email VARCHAR(100),
    created_at TIMESTAMP DEFAULT NOW()
) DISTRIBUTE BY HASH(id);
```

**8. audit_logs锛堝璁℃棩蹇楄〃锛?*
```sql
CREATE TABLE audit_logs (
    id SERIAL PRIMARY KEY,
    user_id INTEGER,
    action VARCHAR(50) NOT NULL,             -- create/update/delete/analyze
    resource VARCHAR(100) NOT NULL,          -- 鎿嶄綔鐨勮祫婧愮被鍨?
    resource_id INTEGER,                     -- 璧勬簮 ID
    old_value JSONB,                         -- 淇敼鍓嶇殑鍊?
    new_value JSONB,                         -- 淇敼鍚庣殑鍊?
    ip_address VARCHAR(50),                  -- 鎿嶄綔 IP
    user_agent TEXT,                         -- 娴忚鍣ㄤ俊鎭?
    metadata JSONB,                          -- 鍏朵粬鍏冩暟鎹?
    created_at TIMESTAMP DEFAULT NOW()
) DISTRIBUTE BY HASH(id);
```

### 2.3 鍒嗙墖琛ㄨ璁″師鍒?

**1. 鍒嗗竷閿€夋嫨鍑嗗垯**

- **楂橀 SQL 鐨勪笟鍔″瓧娈?*锛氶伩鍏嶅垎甯冨紡浜嬪姟
- **鍒嗘瀽绫?SQL 鐨勫叧鑱斿瓧娈?*锛氶伩鍏嶈法 DN 鏁版嵁浜や簰
- **閬垮厤 DN 鑺傜偣鏁版嵁涓嶅潎琛?*锛氶€夋嫨鍒嗗竷鍧囧寑鐨勫瓧娈?

**2. 鏈郴缁熺殑鍒嗙墖閿粺涓€瑙勫垯**

鎵€鏈夎〃浣跨敤 **`patient_id`** 浣滀负鍒嗙墖閿紙鍒嗗竷閿級锛?
- 鎮ｈ€呯殑鎵€鏈夋暟鎹紙鐥呭巻銆丆T銆佸疄楠屽鎸囨爣锛夊瓨鍌ㄥ湪鍚屼竴鏁版嵁鑺傜偣
- 鏌ヨ銆佹洿鏂般€佸垹闄ゆ椂蹇呴』甯︿笂 `patient_id` 浠ヨ幏寰楁渶浣虫€ц兘
- JOIN 鎿嶄綔浣跨敤 `patient_id` 鍏宠仈锛岄伩鍏嶈法鑺傜偣鏁版嵁閲嶅垎甯?

**3. 鎬ц兘浼樺寲瑕佺偣**

```sql
-- 鉁?姝ｇ‘锛氬熀浜庡垎鐗囬敭鐨勬煡璇紙鎬ц兘鏈€浼橈級
SELECT * FROM patient_text_data WHERE patient_id = 123 AND id = 456;

-- 鉂?閿欒锛氫笉甯﹀垎鐗囬敭锛堝叏鑺傜偣鎵弿锛?
SELECT * FROM patient_text_data WHERE id = 456;

-- 鉁?姝ｇ‘锛氬熀浜庡垎鐗囬敭鐨?JOIN
SELECT p.*, t.summary
FROM patients p
JOIN patient_text_data t ON p.patient_id = t.patient_id
WHERE p.patient_id = 123;
```

### 2.4 PL/pgSQL 瀛樺偍杩囩▼璁捐

鏈郴缁熷疄鐜颁簡 **982 琛?PL/pgSQL 浠ｇ爜**锛屽寘鍚?10 涓牳蹇冨瓨鍌ㄥ嚱鏁帮紝瀹屾垚鏅鸿兘璇婃柇鍏ㄦ祦绋嬨€?

#### 鏍稿績瀛樺偍鍑芥暟鍒楄〃

| 鍑芥暟鍚?| 鍔熻兘鎻忚堪 | 鍏抽敭鎶€鏈?|
|--------|---------|---------|
| `get_multimodal_data(patient_id)` | 澶氭ā鎬佹暟鎹粺涓€鏌ヨ | LATERAL JOIN |
| `extract_key_evidence(patient_id)` | 鍏抽敭璇佹嵁鎻愬彇锛堝惈鏉冮噸锛?| JSONB 鑱氬悎 |
| `detect_lab_anomalies(patient_id)` | 瀹為獙瀹ゆ寚鏍囧紓甯告娴?| Z-score 绠楁硶 |
| `calculate_severity_level(z_score)` | 涓ラ噸绋嬪害鍒嗙骇 | 蟽 鍋忕搴?|
| `dynamic_weight_calculation(data_quality)` | 鍔ㄦ€佹潈閲嶈绠?| 鏁版嵁瀹屾暣鎬ц瘎浼?|
| `calibrate_confidence(raw_score)` | 缃俊搴︽牎鍑?| 淇濆畧绛栫暐+92%涓婇檺 |
| `smart_diagnosis_v3(patient_id)` | 鏅鸿兘璇婃柇涓诲嚱鏁?| AI 鎻掍欢璋冪敤 |
| `generate_fhir_bundle(patient_id)` | FHIR 鏍煎紡瀵煎嚭 | JSON 搴忓垪鍖?|
| `comprehensive_analysis(patient_id)` | 缁煎悎鍒嗘瀽 | 骞惰璋冪敤鎵€鏈夊嚱鏁?|
| `update_model_calibration(params)` | 妯″瀷鏍″噯鍙傛暟鏇存柊 | 瀹炴椂瀛︿範 |

#### 鍏抽敭瀛樺偍杩囩▼璇﹁В

**1. 澶氭ā鎬佹暟鎹粺涓€鏌ヨ (`get_multimodal_data`)**

```sql
CREATE OR REPLACE FUNCTION get_multimodal_data(p_patient_id INTEGER)
RETURNS JSON AS $$
DECLARE
    result JSON;
BEGIN
    SELECT json_build_object(
        'patient_info', row_to_json(p.*),
        'text_data', text_data.summary,
        'ct_data', json_build_object(
            'ct_url', ct_data.ct_url,
            'analysis', ct_data.analysis_result
        ),
        'lab_data', lab_data.lab_data,
        'data_quality', json_build_object(
            'text_available', (text_data.summary IS NOT NULL),
            'ct_available', (ct_data.ct_url IS NOT NULL),
            'lab_available', (lab_data.lab_data IS NOT NULL)
        )
    ) INTO result
    FROM patients p
    LEFT JOIN LATERAL (
        SELECT final_summary AS summary
        FROM patient_text_data
        WHERE patient_id = p.patient_id
          AND status = 'approved'
        ORDER BY created_at DESC
        LIMIT 1
    ) text_data ON true
    LEFT JOIN LATERAL (
        SELECT ct_url, analysis_result
        FROM patient_ct_data
        WHERE patient_id = p.patient_id
          AND status = 'approved'
        ORDER BY created_at DESC
        LIMIT 1
    ) ct_data ON true
    LEFT JOIN LATERAL (
        SELECT lab_data
        FROM patient_lab_data
        WHERE patient_id = p.patient_id
          AND status = 'approved'
        ORDER BY created_at DESC
        LIMIT 1
    ) lab_data ON true
    WHERE p.patient_id = p_patient_id;

    RETURN result;
END;
$$ LANGUAGE plpgsql;
```

**鎶€鏈寒鐐?*锛?
- 浣跨敤 **LATERAL JOIN** 瀹炵幇瀛愭煡璇㈠叧鑱?
- 姣忎釜妯℃€佸彇鏈€鏂扮殑宸插鏍歌褰?
- 杩斿洖 **data_quality** 瀛楁鐢ㄤ簬鍔ㄦ€佸姞鏉?
- 涓€娆℃煡璇㈠畬鎴愭墍鏈夋暟鎹幏鍙?

**2. 寮傚父妫€娴嬩笌涓ラ噸绋嬪害鍒嗙骇 (`detect_lab_anomalies`)**

```sql
CREATE OR REPLACE FUNCTION detect_lab_anomalies(p_patient_id INTEGER)
RETURNS JSON AS $$
DECLARE
    lab_record RECORD;
    anomalies JSON[];
    indicator_name TEXT;
    indicator_data JSONB;
    value NUMERIC;
    ref_range TEXT;
    ref_min NUMERIC;
    ref_max NUMERIC;
    z_score NUMERIC;
    severity TEXT;
BEGIN
    -- 鑾峰彇鏈€鏂板疄楠屽鏁版嵁
    SELECT lab_data INTO lab_record
    FROM patient_lab_data
    WHERE patient_id = p_patient_id
      AND status = 'approved'
    ORDER BY created_at DESC
    LIMIT 1;

    IF NOT FOUND THEN
        RETURN '[]'::JSON;
    END IF;

    -- 閬嶅巻姣忎釜鎸囨爣
    FOR indicator_name, indicator_data IN
        SELECT * FROM jsonb_each(lab_record.lab_data)
    LOOP
        value := (indicator_data->>'value')::NUMERIC;
        ref_range := indicator_data->>'reference';

        -- 瑙ｆ瀽鍙傝€冭寖鍥?"4-10"
        ref_min := split_part(ref_range, '-', 1)::NUMERIC;
        ref_max := split_part(ref_range, '-', 2)::NUMERIC;

        -- 璁＄畻 Z-score锛堟爣鍑嗗樊鍋忕搴︼級
        z_score := CASE
            WHEN value < ref_min THEN
                (value - ref_min) / ((ref_max - ref_min) / 4.0)
            WHEN value > ref_max THEN
                (value - ref_max) / ((ref_max - ref_min) / 4.0)
            ELSE 0
        END;

        -- 涓ラ噸绋嬪害鍒嗙骇
        severity := CASE
            WHEN abs(z_score) < 1 THEN '杞诲井'  -- < 1蟽
            WHEN abs(z_score) < 2 THEN '涓害'  -- 1蟽 ~ 2蟽
            ELSE '涓ラ噸'                         -- > 2蟽
        END;

        -- 璁板綍寮傚父锛堜粎璁板綍寮傚父鍊硷級
        IF z_score != 0 THEN
            anomalies := array_append(anomalies, json_build_object(
                'indicator', indicator_name,
                'value', value,
                'reference', ref_range,
                'deviation', round(z_score, 2),
                'severity', severity,
                'percentage', round(abs((value - CASE
                    WHEN value < ref_min THEN ref_min
                    ELSE ref_max
                END) / CASE
                    WHEN value < ref_min THEN ref_min
                    ELSE ref_max
                END * 100), 1)
            ));
        END IF;
    END LOOP;

    RETURN array_to_json(anomalies);
END;
$$ LANGUAGE plpgsql;
```

**鎶€鏈寒鐐?*锛?
- **Z-score 绠楁硶**锛氳绠楁寚鏍囧亸绂绘甯歌寖鍥寸殑鏍囧噯宸€嶆暟
- **涓夌骇鍒嗙被**锛?
  - 杞诲井锛? 1蟽锛夛細鍋忕姝ｅ父鑼冨洿浣嗕笉涓ラ噸
  - 涓害锛?蟽 ~ 2蟽锛夛細鏄庢樉寮傚父
  - 涓ラ噸锛? 2蟽锛夛細鏄捐憲寮傚父锛岄渶绔嬪嵆鍏虫敞
- **JSONB 閬嶅巻**锛氬姩鎬佸鐞嗕换鎰忔寚鏍?
- **鐧惧垎姣旇绠?*锛氱洿瑙傛樉绀哄亸绂荤▼搴?

**3. 鏅鸿兘璇婃柇涓诲嚱鏁?(`smart_diagnosis_v3`)**

```sql
CREATE OR REPLACE FUNCTION smart_diagnosis_v3(p_patient_id INTEGER)
RETURNS JSON AS $$
DECLARE
    multimodal_data JSON;
    evidence_data JSON;
    anomalies JSON;
    prompt TEXT;
    ai_diagnosis TEXT;
    confidence_raw NUMERIC;
    confidence_calibrated NUMERIC;
    weights JSONB;
    result JSON;
BEGIN
    -- 1. 鑾峰彇澶氭ā鎬佹暟鎹?
    multimodal_data := get_multimodal_data(p_patient_id);

    -- 2. 鎻愬彇鍏抽敭璇佹嵁
    evidence_data := extract_key_evidence(p_patient_id);

    -- 3. 妫€娴嬪紓甯?
    anomalies := detect_lab_anomalies(p_patient_id);

    -- 4. 璁＄畻鍔ㄦ€佹潈閲?
    weights := dynamic_weight_calculation(multimodal_data->'data_quality');

    -- 5. 鏋勫缓 AI 鎻愮ず璇?
    prompt := format(
        '璇锋牴鎹互涓嬫偅鑰呮暟鎹繘琛岀患鍚堣瘖鏂垎鏋愶細

銆愭偅鑰呭熀鏈俊鎭€?
%s

銆愮梾鍘嗘€荤粨銆戯紙鏉冮噸锛?s锛?
%s

銆怌T褰卞儚鍒嗘瀽銆戯紙鏉冮噸锛?s锛?
%s

銆愬疄楠屽鎸囨爣寮傚父銆戯紙鏉冮噸锛?s锛?
%s

銆愬叧閿瘉鎹€?
%s

璇锋彁渚涳細
1. 缁煎悎璇婃柇缁撹
2. 璇婃柇渚濇嵁锛堝紩鐢ㄤ笂杩拌瘉鎹級
3. 椋庨櫓璇勪及锛?-100鍒嗭級
4. 娌荤枟寤鸿
5. 闅忚璁″垝',
        multimodal_data->'patient_info',
        weights->>'text_weight',
        multimodal_data->'text_data',
        weights->>'ct_weight',
        multimodal_data->'ct_data',
        weights->>'lab_weight',
        anomalies,
        evidence_data
    );

    -- 6. 璋冪敤 AI 鐢熸垚璇婃柇
    SELECT ai.generate_text(prompt) INTO ai_diagnosis;

    -- 7. 璁＄畻缃俊搴︼紙鍩轰簬鏁版嵁瀹屾暣鎬э級
    confidence_raw := (
        (CASE WHEN multimodal_data->'data_quality'->>'text_available' = 'true' THEN 30 ELSE 0 END) +
        (CASE WHEN multimodal_data->'data_quality'->>'ct_available' = 'true' THEN 35 ELSE 0 END) +
        (CASE WHEN multimodal_data->'data_quality'->>'lab_available' = 'true' THEN 35 ELSE 0 END)
    );

    -- 8. 缃俊搴︽牎鍑嗭紙92% 涓婇檺锛?
    confidence_calibrated := calibrate_confidence(confidence_raw);

    -- 9. 瀛樺偍璇婃柇缁撴灉
    INSERT INTO patient_diagnosis (
        patient_id,
        diagnosis_text,
        confidence_score,
        evidence_json,
        status,
        created_at
    ) VALUES (
        p_patient_id,
        ai_diagnosis,
        confidence_calibrated,
        json_build_object(
            'evidence', evidence_data,
            'anomalies', anomalies,
            'weights', weights
        ),
        'pending',
        NOW()
    ) RETURNING row_to_json(patient_diagnosis.*) INTO result;

    RETURN result;
END;
$$ LANGUAGE plpgsql;
```

**娴佺▼鍥?*锛?
```
    鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
    鈹?1. 鑾峰彇澶氭ā鎬佹暟鎹?       鈹?
    鈹?  (get_multimodal_data)  鈹?
    鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
                 鈫?
    鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
    鈹?2. 鎻愬彇鍏抽敭璇佹嵁          鈹?
    鈹?  (extract_key_evidence) 鈹?
    鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
                 鈫?
    鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
    鈹?3. 妫€娴嬪紓甯告寚鏍?         鈹?
    鈹?  (detect_lab_anomalies) 鈹?
    鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
                 鈫?
    鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
    鈹?4. 璁＄畻鍔ㄦ€佹潈閲?         鈹?
    鈹?  (dynamic_weight_calc)  鈹?
    鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
                 鈫?
    鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
    鈹?5. 鏋勫缓 AI 鎻愮ず璇?       鈹?
    鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
                 鈫?
    鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
    鈹?6. 璋冪敤 AI 鐢熸垚璇婃柇      鈹?
    鈹?  (ai.generate_text)     鈹?
    鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
                 鈫?
    鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
    鈹?7. 璁＄畻鍘熷缃俊搴?       鈹?
    鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
                 鈫?
    鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
    鈹?8. 缃俊搴︽牎鍑?           鈹?
    鈹?  (calibrate_confidence) 鈹?
    鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
                 鈫?
    鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
    鈹?9. 瀛樺偍璇婃柇缁撴灉          鈹?
    鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
```

**鎶€鏈寒鐐?*锛?
- **10 姝ュ畬鏁存祦绋?*锛氫粠鏁版嵁鑾峰彇鍒扮粨鏋滃瓨鍌?
- **鍔ㄦ€佹彁绀鸿瘝**锛氭牴鎹疄闄呮暟鎹畬鏁存€ц皟鏁存潈閲嶈鏄?
- **鏁版嵁搴撳唴 AI 璋冪敤**锛歚ai.generate_text()` 鐩存帴鍦ㄦ暟鎹簱鎵ц
- **缃俊搴﹁绠?*锛氬熀浜庢暟鎹畬鏁存€х殑閲忓寲璇勫垎
- **璇佹嵁閾惧瓨鍌?*锛欽SONB 鏍煎紡淇濆瓨鎵€鏈変腑闂寸粨鏋?

---

## 3. 绠楁硶璁捐

### 3.1 澶氭ā鎬佹暟鎹瀺鍚堢畻娉?

**闂**锛氬浣曡瀺鍚堢梾鍘嗘枃鏈€丆T 褰卞儚銆佸疄楠屽鎸囨爣銆佹偅鑰呬俊鎭洓绉嶅紓鏋勬暟鎹紵

**瑙ｅ喅鏂规**锛氬熀浜?**鍔犳潈铻嶅悎** + **璇佹嵁鐞嗚** 鐨勬贩鍚堢瓥鐣?

**绠楁硶娴佺▼**锛?

1. **鏁版嵁鏍囧噯鍖?*锛?
```javascript
// 灏嗕笉鍚屾ā鎬佹暟鎹浆鎹负缁熶竴鐨?JSON 鏍煎紡
{
  "modality": "text|ct|lab|patient",
  "content": "...",
  "confidence": 0.0-1.0,
  "timestamp": "2024-01-01T00:00:00Z"
}
```

2. **璐ㄩ噺璇勪及**锛?
```sql
-- 璇勪及姣忎釜妯℃€佺殑鏁版嵁璐ㄩ噺
data_quality_score = (
    completeness_score * 0.4 +  -- 瀹屾暣鎬э細瀛楁鏄惁榻愬叏
    recency_score * 0.3 +        -- 鏃舵晥鎬э細鏁版嵁鏄惁鏈€鏂?
    accuracy_score * 0.3         -- 鍑嗙‘鎬э細鏄惁缁忚繃鍖荤敓瀹℃牳
)
```

3. **鏉冮噸鍒嗛厤**锛?
```sql
-- 鍩轰簬鏁版嵁璐ㄩ噺鍔ㄦ€佽皟鏁存潈閲?
text_weight = 0.25 * (data_quality.text / total_quality)
ct_weight = 0.40 * (data_quality.ct / total_quality)
lab_weight = 0.35 * (data_quality.lab / total_quality)
```

4. **璇佹嵁铻嶅悎**锛?
```sql
-- Dempster-Shafer 璇佹嵁鐞嗚
combined_confidence = (
    text_confidence * text_weight +
    ct_confidence * ct_weight +
    lab_confidence * lab_weight
) / (text_weight + ct_weight + lab_weight)
```

### 3.2 鍔ㄦ€佸姞鏉冩満鍒?

**鏍稿績鎬濇兂**锛氭牴鎹暟鎹川閲忚嚜閫傚簲璋冩暣鍚勬ā鎬佹潈閲嶏紝鑰岄潪浣跨敤鍥哄畾鏉冮噸銆?

**瀹炵幇浠ｇ爜**锛?
```sql
CREATE OR REPLACE FUNCTION dynamic_weight_calculation(data_quality JSONB)
RETURNS JSONB AS $$
DECLARE
    text_available BOOLEAN;
    ct_available BOOLEAN;
    lab_available BOOLEAN;
    total_weight NUMERIC := 0;
    text_weight NUMERIC := 0;
    ct_weight NUMERIC := 0;
    lab_weight NUMERIC := 0;
BEGIN
    text_available := (data_quality->>'text_available')::BOOLEAN;
    ct_available := (data_quality->>'ct_available')::BOOLEAN;
    lab_available := (data_quality->>'lab_available')::BOOLEAN;

    -- 鍩虹鏉冮噸鍒嗛厤
    IF text_available THEN
        text_weight := 0.25;
        total_weight := total_weight + 0.25;
    END IF;

    IF ct_available THEN
        ct_weight := 0.40;
        total_weight := total_weight + 0.40;
    END IF;

    IF lab_available THEN
        lab_weight := 0.35;
        total_weight := total_weight + 0.35;
    END IF;

    -- 褰掍竴鍖栵紙缂哄け鏁版嵁鏃堕噸鏂板垎閰嶆潈閲嶏級
    IF total_weight > 0 THEN
        text_weight := text_weight / total_weight;
        ct_weight := ct_weight / total_weight;
        lab_weight := lab_weight / total_weight;
    END IF;

    RETURN jsonb_build_object(
        'text_weight', round(text_weight, 2),
        'ct_weight', round(ct_weight, 2),
        'lab_weight', round(lab_weight, 2)
    );
END;
$$ LANGUAGE plpgsql;
```

**绀轰緥鍦烘櫙**锛?

| 鍦烘櫙 | 鍙敤鏁版嵁 | 鏉冮噸鍒嗛厤 |
|------|---------|---------|
| **瀹屾暣鏁版嵁** | 鐥呭巻+CT+瀹為獙瀹?| text: 0.25, ct: 0.40, lab: 0.35 |
| **缂哄皯CT** | 鐥呭巻+瀹為獙瀹?| text: 0.42, ct: 0.00, lab: 0.58 |
| **浠匔T** | CT | text: 0.00, ct: 1.00, lab: 0.00 |

**浼樺娍**锛?
- 鑷姩閫傚簲鏁版嵁缂哄け鎯呭喌
- 閬垮厤鍥哄畾鏉冮噸瀵艰嚧鐨勫亸宸?
- 鎻愬崌璇婃柇鐨勯瞾妫掓€?

### 3.3 寮傚父涓ラ噸绋嬪害鍒嗙骇绠楁硶

**闂**锛氬浣曢噺鍖栧疄楠屽鎸囨爣鐨勫紓甯哥▼搴︼紵

**瑙ｅ喅鏂规**锛氬熀浜?**Z-score锛堟爣鍑嗗樊鍋忕搴︼級** 鐨勪笁绾у垎绫绘硶

**绠楁硶鍘熺悊**锛?

1. **Z-score 璁＄畻**锛?
```
Z = (瀹為檯鍊?- 鍙傝€冨€间腑鐐? / (鍙傝€冭寖鍥村搴?/ 4)

鍏朵腑锛?
- 鍙傝€冭寖鍥村搴?/ 4 鈮?1涓爣鍑嗗樊锛堝亣璁炬鎬佸垎甯冿級
```

2. **涓ラ噸绋嬪害鍒嗙骇**锛?
```
| Z-score 鑼冨洿 | 涓ラ噸绋嬪害 | 鍚箟 |
|-------------|---------|------|
| |Z| < 1蟽    | 杞诲井     | 95%缃俊鍖洪棿鍐咃紝鍋忕杈冨皬 |
| 1蟽 鈮?|Z| < 2蟽 | 涓害   | 鍋忕鏄庢樉锛岄渶鍏虫敞 |
| |Z| 鈮?2蟽    | 涓ラ噸     | 鏄捐憲寮傚父锛岄渶绔嬪嵆澶勭悊 |
```

3. **瀹炵幇绀轰緥**锛?
```sql
-- 鐧界粏鑳炶鏁扮ず渚?
value = 15.2
reference = "4-10"
ref_min = 4
ref_max = 10
ref_mid = (4 + 10) / 2 = 7
std_dev = (10 - 4) / 4 = 1.5

Z = (15.2 - 10) / 1.5 = 3.47

涓ラ噸绋嬪害 = "涓ラ噸" (Z > 2蟽)
鐧惧垎姣斿亸绂?= (15.2 - 10) / 10 * 100 = 52%
```

**鍙鍖栧睍绀?*锛?
```
    姝ｅ父鑼冨洿        杞诲井寮傚父       涓害寮傚父      涓ラ噸寮傚父
  鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?  鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?   鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?  鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
  鈹?  4-10   鈹?  鈹?10-11.5鈹?   鈹?1.5-13 鈹?  鈹? >13   鈹?
  鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?  鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?   鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?  鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
       鈫?           鈫?< 1蟽       鈫?< 2蟽       鈫?鈮?2蟽
      姝ｅ父          杞诲井          涓害          涓ラ噸

  瀹為檯鍊? 15.2 鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈫?涓ラ噸寮傚父
```

### 3.4 缃俊搴︽牎鍑嗙畻娉?

**闂**锛欰I 妯″瀷瀹规槗浜х敓杩囧害鑷俊锛屽浣曟牎鍑嗙疆淇″害锛?

**瑙ｅ喅鏂规**锛?*淇濆畧绛栫暐** + **92% 纭€т笂闄?*

**璁捐鐞嗗康**锛?
- 鍖荤枟鍦烘櫙涓嬶紝AI 璇婃柇姘歌繙涓嶅簲杈惧埌 100% 缃俊搴?
- 涓哄尰鐢熺暀鍑哄垽鏂┖闂?
- 閬垮厤杩囧害渚濊禆 AI

**绠楁硶瀹炵幇**锛?
```sql
CREATE OR REPLACE FUNCTION calibrate_confidence(raw_score NUMERIC)
RETURNS NUMERIC AS $$
DECLARE
    calibrated NUMERIC;
BEGIN
    -- 1. 搴旂敤鏍″噯鍏紡锛堜繚瀹堢瓥鐣ワ級
    calibrated := raw_score * 0.85 + 10;  -- 鍘嬬缉鍒?10-95 鑼冨洿

    -- 2. 纭€т笂闄愶紙92%锛?
    IF calibrated > 92 THEN
        calibrated := 92;
    END IF;

    -- 3. 涓嬮檺淇濇姢锛堟渶浣?15%锛?
    IF calibrated < 15 THEN
        calibrated := 15;
    END IF;

    RETURN round(calibrated, 2);
END;
$$ LANGUAGE plpgsql;
```

**鏍″噯鏁堟灉瀵规瘮**锛?

| 鍘熷缃俊搴?| 鏍″噯鍚庣疆淇″害 | 璇存槑 |
|-----------|------------|------|
| 100% | 92% | 纭€т笂闄愶紝姘镐笉杈?100% |
| 90% | 86.5% | 閫傚害鍘嬬缉 |
| 80% | 78% | 淇濆畧璋冩暣 |
| 50% | 52.5% | 涓瓑缃俊搴︾暐寰彁鍗?|
| 20% | 27% | 浣庣疆淇″害淇濇姢 |
| 0% | 15% | 涓嬮檺淇濇姢 |

**鏍″噯鏇茬嚎**锛?
```
缃俊搴︽牎鍑嗘洸绾?
100 鈹?                   鈺攢鈹€鈹€鈹€鈹€鈹€鈹€ 92% 涓婇檺
 90 鈹?                鈺攢鈹€鈺?
 80 鈹?             鈺攢鈹€鈺?
 70 鈹?          鈺攢鈹€鈺?
 60 鈹?       鈺攢鈹€鈺?
 50 鈹?    鈺攢鈹€鈺?
 40 鈹? 鈺攢鈹€鈺?
 30 鈹も暛鈹€鈺?
 20 鈹も暞
 10 鈹?
  0 鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€
    0  20  40  60  80  100
         鍘熷缃俊搴?(%)
```

---

## 4. 鏅鸿兘璇婃柇娴佺▼璁捐

### 4.1 鏁版嵁搴撶璇婃柇娴佺▼

**瀹屾暣娴佺▼鍥?*锛?
```
鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
鈹?                    鐢ㄦ埛瑙﹀彂璇婃柇璇锋眰                       鈹?
鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
                         鈫?
鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
鈹? 鍚庣 API: POST /api/db-analysis/smart-diagnosis         鈹?
鈹? - 鍒涘缓 analysis_task 璁板綍锛坰tatus: pending锛?           鈹?
鈹? - 杩斿洖 task_id 缁欏墠绔?                                  鈹?
鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
                         鈫?
鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
鈹? 鍚庡彴浠诲姟: 璋冪敤瀛樺偍杩囩▼ smart_diagnosis_v3(patient_id)   鈹?
鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
                         鈫?
        鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹粹攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
        鈫?                                 鈫?
鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?           鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
鈹?1. 澶氭ā鎬佹暟鎹幏鍙?鈹?           鈹?鏁版嵁搴?LATERAL   鈹?
鈹?get_multimodal   鈹?           鈹?JOIN 涓€娆℃€ф煡璇? 鈹?
鈹?_data()          鈹?           鈹?4绉嶆ā鎬佹暟鎹?     鈹?
鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?           鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
         鈫?
鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
鈹?2. 璇佹嵁鎻愬彇       鈹?
鈹?extract_key      鈹?
鈹?_evidence()      鈹?
鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
         鈫?
鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?           鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
鈹?3. 寮傚父妫€娴?      鈹?           鈹?Z-score 绠楁硶     鈹?
鈹?detect_lab       鈹?           鈹?涓夌骇鍒嗙被         鈹?
鈹?_anomalies()     鈹?           鈹?(杞诲井/涓害/涓ラ噸) 鈹?
鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?           鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
         鈫?
鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?           鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
鈹?4. 鍔ㄦ€佸姞鏉?      鈹?           鈹?鍩轰簬鏁版嵁璐ㄩ噺     鈹?
鈹?dynamic_weight   鈹?           鈹?鑷€傚簲璋冩暣鏉冮噸   鈹?
鈹?_calculation()   鈹?           鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
         鈫?
鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?           鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
鈹?5. 鏋勫缓 AI 鎻愮ず璇?鈹?           鈹?鍖呭惈:            鈹?
鈹?                 鈹?           鈹?- 鎮ｈ€呬俊鎭?      鈹?
鈹?                 鈹?           鈹?- 鍚勬ā鎬佹暟鎹?    鈹?
鈹?                 鈹?           鈹?- 鏉冮噸璇存槑       鈹?
鈹?                 鈹?           鈹?- 璇佹嵁閾?        鈹?
鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?           鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
         鈫?
鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?           鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
鈹?6. AI 璇婃柇鐢熸垚    鈹?           鈹?ai.generate_text 鈹?
鈹?                 鈹?           鈹?鏁版嵁搴撳唴璋冪敤     鈹?
鈹?                 鈹?           鈹?(鏃犻渶澶栭儴 API)   鈹?
鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?           鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
         鈫?
鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?           鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
鈹?7. 缃俊搴﹁绠?    鈹?           鈹?鍩轰簬鏁版嵁瀹屾暣鎬?  鈹?
鈹?                 鈹?           鈹?text: 30%        鈹?
鈹?                 鈹?           鈹?ct: 35%          鈹?
鈹?                 鈹?           鈹?lab: 35%         鈹?
鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?           鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
         鈫?
鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?           鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
鈹?8. 缃俊搴︽牎鍑?    鈹?           鈹?淇濆畧绛栫暐         鈹?
鈹?calibrate        鈹?           鈹?92% 纭€т笂闄?    鈹?
鈹?_confidence()    鈹?           鈹?姘镐笉杈?100%      鈹?
鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?           鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
         鈫?
鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?           鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
鈹?9. 瀛樺偍璇婃柇缁撴灉   鈹?           鈹?patient_diagnosis鈹?
鈹?                 鈹?           鈹?琛?               鈹?
鈹?                 鈹?           鈹?- 璇婃柇鏂囨湰       鈹?
鈹?                 鈹?           鈹?- 缃俊搴?        鈹?
鈹?                 鈹?           鈹?- 璇佹嵁閾?JSONB)  鈹?
鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?           鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
         鈫?
鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
鈹?10. 鏇存柊浠诲姟鐘舵€? 鈹?
鈹?analysis_task    鈹?
鈹?status: completed鈹?
鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
         鈫?
鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
鈹? 鍓嶇杞: GET /api/db-analysis/smart-diagnosis/:id      鈹?
鈹? - 妫€娴嬪埌 status = completed                             鈹?
鈹? - 鑾峰彇璇婃柇缁撴灉骞跺睍绀?                                    鈹?
鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
```

**鍏抽敭浼樺寲**锛?
1. **涓€娆℃€ф暟鎹煡璇?*锛歀ATERAL JOIN 閬垮厤澶氭鏌ヨ
2. **鏁版嵁搴撳唴 AI 璋冪敤**锛氬噺灏?75% 缃戠粶寰€杩?
3. **骞惰璇佹嵁鎻愬彇**锛氬涓瓙鏌ヨ骞惰鎵ц
4. **寮傛浠诲姟妯″紡**锛氶暱鏃堕棿 AI 鍒嗘瀽涓嶉樆濉炲墠绔?

### 4.2 寮傛浠诲姟闃熷垪璁捐

**闂**锛欰I 璇婃柇鍙兘闇€瑕?10-30 绉掞紝濡備綍閬垮厤鍓嶇闃诲锛?

**瑙ｅ喅鏂规**锛?*鍚庡彴浠诲姟 + 杞鏈哄埗**

**瀹炵幇娴佺▼**锛?

```javascript
// 1. 鍓嶇鍙戣捣璇婃柇璇锋眰
async function generateDiagnosis(patientId) {
  // 鍒涘缓璇婃柇浠诲姟
  const createResponse = await api.post('/db-analysis/smart-diagnosis', {
    patient_id: patientId
  });

  const taskId = createResponse.data.task_id;
  ElMessage.info('璇婃柇浠诲姟宸插垱寤猴紝姝ｅ湪鍒嗘瀽涓?..');

  // 寮€濮嬭疆璇?
  const checkInterval = setInterval(async () => {
    const statusResponse = await api.get(
      `/db-analysis/smart-diagnosis/${patientId}`
    );

    if (statusResponse.success && statusResponse.data) {
      // 浠诲姟瀹屾垚
      clearInterval(checkInterval);
      displayDiagnosisResult(statusResponse.data);
      ElMessage.success('缁煎悎璇婃柇鐢熸垚鎴愬姛');
    }
  }, 2000); // 姣?2 绉掓鏌ヤ竴娆?

  // 30 绉掕秴鏃?
  setTimeout(() => {
    if (diagnosisLoading.value) {
      clearInterval(checkInterval);
      ElMessage.warning('璇婃柇浠诲姟瓒呮椂锛岃绋嶅悗鏌ョ湅璇婃柇鎶ュ憡椤甸潰');
    }
  }, 30000);
}
```

**鍚庣浠诲姟澶勭悊**锛?
```javascript
// backend/src/routes/database-analysis.js

// 鍒涘缓璇婃柇浠诲姟
router.post('/smart-diagnosis', async (req, res) => {
  const { patient_id } = req.body;

  // 1. 鍒涘缓浠诲姟璁板綍
  const taskResult = await query(
    `INSERT INTO analysis_tasks (patient_id, task_type, status)
     VALUES ($1, 'diagnosis', 'pending')
     RETURNING task_id`,
    [patient_id]
  );

  const taskId = taskResult.rows[0].task_id;

  // 2. 寮傛鎵ц璇婃柇锛堜笉绛夊緟瀹屾垚锛?
  setImmediate(async () => {
    try {
      await query('UPDATE analysis_tasks SET status = $1, started_at = NOW() WHERE task_id = $2', ['processing', taskId]);

      // 璋冪敤瀛樺偍杩囩▼锛堝彲鑳介渶瑕?10-30 绉掞級
      const diagnosisResult = await query(
        'SELECT smart_diagnosis_v3($1) AS result',
        [patient_id]
      );

      await query(
        `UPDATE analysis_tasks
         SET status = $1, result = $2, completed_at = NOW()
         WHERE task_id = $3`,
        ['completed', JSON.stringify(diagnosisResult.rows[0].result), taskId]
      );
    } catch (error) {
      await query(
        `UPDATE analysis_tasks
         SET status = $1, error_message = $2
         WHERE task_id = $3`,
        ['failed', error.message, taskId]
      );
    }
  });

  // 3. 绔嬪嵆杩斿洖 task_id
  res.json({
    success: true,
    data: { task_id: taskId },
    message: '璇婃柇浠诲姟宸插垱寤猴紝姝ｅ湪鍚庡彴澶勭悊'
  });
});

// 鏌ヨ璇婃柇缁撴灉
router.get('/smart-diagnosis/:patient_id', async (req, res) => {
  const { patient_id } = req.params;

  // 鏌ヨ鏈€鏂扮殑璇婃柇璁板綍
  const result = await query(
    `SELECT * FROM patient_diagnosis
     WHERE patient_id = $1
     ORDER BY created_at DESC
     LIMIT 1`,
    [patient_id]
  );

  if (result.rows.length > 0) {
    res.json({
      success: true,
      data: result.rows[0]
    });
  } else {
    res.status(404).json({
      success: false,
      error: '璇婃柇缁撴灉灏氭湭鐢熸垚'
    });
  }
});
```

**浼樺娍**锛?
- **闈為樆濉?*锛氬墠绔笉闇€瑕佺瓑寰?AI 鍒嗘瀽瀹屾垚
- **瀹炴椂鍙嶉**锛氭瘡 2 绉掓洿鏂颁竴娆＄姸鎬?
- **瀹归敊鏈哄埗**锛氳秴鏃跺悗寮曞鐢ㄦ埛鏌ョ湅鎶ュ憡椤甸潰
- **鍙墿灞?*锛氭湭鏉ュ彲鍗囩骇涓?WebSocket 鎺ㄩ€?

---

## 5. AI 鎻掍欢闆嗘垚璁捐

### 5.1 opentenbase_ai 鎻掍欢鏋舵瀯

**鎻掍欢鑳藉姏**锛?
```sql
-- 1. 鏂囨湰鐢熸垚
SELECT ai.generate_text('鎻愮ず璇?) AS result;

-- 2. 鍥惧儚鍒嗘瀽锛圤CR + 鐞嗚В锛?
SELECT ai.image('鍒嗘瀽鎸囦护', 'https://example.com/image.jpg') AS result;

-- 3. 宓屽叆鍚戦噺鐢熸垚
SELECT ai.embedding('鏂囨湰鍐呭') AS vector;

-- 4. 澶氭ā鎬佺患鍚堝垎鏋?
SELECT ai.completion('鎻愮ず璇?, '{"data": {...}}') AS result;
```

**閰嶇疆鍙傛暟**锛?
```sql
-- 璁剧疆榛樿妯″瀷
SET ai.completion_model = 'qwen_chat';
SET ai.embedding_model = 'qwen_chat';
SET ai.image_model = 'qwen_chat';

-- 璁剧疆瓒呮椂鏃堕棿锛堟绉掞級
SET ai.http.timeout_msec = 200000;  -- 200 绉?
```

**璋冪敤绀轰緥**锛?
```sql
-- 鐥呭巻 OCR
SELECT ai.image(
  '璇疯瘑鍒梾鍘嗗浘鐗囦腑鐨勬枃鏈唴瀹癸紝骞剁敓鎴愪竴娈佃嚜鐒惰瑷€鎬荤粨銆?,
  'https://qiniu.aihubzone.cn/opentenbase/text/report1.png'
) AS summary;

-- 瀹為獙瀹ゆ寚鏍囨彁鍙?
SELECT ai.image(
  '璇锋彁鍙栬〃鏍间腑鐨勫疄楠屽鎸囨爣鏁版嵁锛屽苟杩斿洖 JSON 鏍煎紡缁撴灉銆?
   鏍煎紡绀轰緥: {"鐧界粏鑳炶鏁?: {"value": 15.2, "unit": "10^9/L", "reference": "4-10"}}',
  'https://qiniu.aihubzone.cn/opentenbase/structure/lab1.png'
)::json AS lab_data;

-- 缁煎悎璇婃柇
SELECT ai.generate_text(
  '璇风粨鍚堜互涓嬫暟鎹敓鎴愬鎮ｈ€呯殑鍏ㄩ潰璇婃柇缁撹锛?
   銆愮梾鍘嗘€荤粨銆? || summary || '
   銆怌T褰卞儚鍒嗘瀽銆? || ct_analysis || '
   銆愬疄楠屽鎸囨爣寮傚父銆? || lab_anomalies
) AS diagnosis;
```

### 5.2 AI 璋冪敤浼樺寲绛栫暐

**1. 鍙傛暟鍖栨煡璇紙闃叉 SQL 娉ㄥ叆锛?*
```javascript
// 鉁?姝ｇ‘锛氫娇鐢ㄥ弬鏁板寲鏌ヨ
const result = await query(
  `SELECT ai.image($1, $2) AS analysis`,
  [prompt, imageUrl]
);

// 鉂?閿欒锛氬瓧绗︿覆鎷兼帴锛堝畨鍏ㄦ紡娲烇級
const result = await query(
  `SELECT ai.image('${prompt}', '${imageUrl}') AS analysis`
);
```

**2. 瓒呮椂澶勭悊**
```javascript
// 璁剧疆 200 绉掕秴鏃?
const result = await query(
  `
  SET LOCAL ai.http.timeout_msec = 200000;
  SELECT ai.generate_text($1) AS result;
  `,
  [prompt]
);
```

**3. 閿欒闄嶇骇绛栫暐**
```javascript
try {
  // 灏濊瘯 AI 鍒嗘瀽
  const aiResult = await query(
    `SELECT ai.image($1, $2) AS data`,
    [prompt, imageUrl]
  );
  return aiResult.rows[0].data;
} catch (error) {
  // AI 澶辫触鏃堕檷绾у埌妯℃嫙鏁版嵁
  logger.warn('AI 鍒嗘瀽澶辫触锛屼娇鐢ㄦā鎷熸暟鎹?, { error: error.message });
  return getMockLabData();
}
```

**4. 鎻愮ず璇嶅伐绋?*
```javascript
// 缁撴瀯鍖栨彁绀鸿瘝妯℃澘
const prompt = `
璇锋彁鍙栬〃鏍间腑鐨勫疄楠屽鎸囨爣鏁版嵁锛屽苟涓ユ牸鎸夌収浠ヤ笅 JSON 鏍煎紡杩斿洖锛?

{
  "鎸囨爣鍚嶇О": {
    "abbreviation": "缂╁啓",
    "value": 鏁板€?
    "unit": "鍗曚綅",
    "reference": "鍙傝€冭寖鍥?
  }
}

绀轰緥:
{
  "鐧界粏鑳炶鏁?: {
    "abbreviation": "WBC",
    "value": 15.2,
    "unit": "10^9/L",
    "reference": "4-10"
  }
}

閲嶈瑙勫垯:
1. 蹇呴』杩斿洖鏈夋晥鐨?JSON 鏍煎紡
2. value 蹇呴』鏄暟瀛楃被鍨?
3. 鎵€鏈夊瓧娈典笉鑳戒负绌?

璇峰紑濮嬪垎鏋愬浘鐗?..
`;
```

**5. 鎵归噺璋冪敤浼樺寲**
```sql
-- 浣跨敤 CTE 鎵归噺澶勭悊
WITH lab_images AS (
  SELECT id, image_url
  FROM patient_lab_data
  WHERE status = 'pending'
  LIMIT 10
)
UPDATE patient_lab_data
SET lab_data = ai.image(
      '鎻愬彇瀹為獙瀹ゆ寚鏍?..',
      lab_images.image_url
    )::jsonb,
    status = 'completed',
    analyzed_at = NOW()
FROM lab_images
WHERE patient_lab_data.id = lab_images.id;
```

---

## 6. 鎬ц兘浼樺寲璁捐

### 6.1 鏌ヨ鎬ц兘浼樺寲

**1. 鍩轰簬鍒嗙墖閿殑鏌ヨ**
```sql
-- 鉁?楂樻€ц兘锛氬寘鍚垎鐗囬敭锛堝崟鑺傜偣鏌ヨ锛?
SELECT * FROM patient_text_data
WHERE patient_id = 123 AND id = 456;

-- 鉂?浣庢€ц兘锛氫笉鍖呭惈鍒嗙墖閿紙鍏ㄨ妭鐐规壂鎻忥級
SELECT * FROM patient_text_data
WHERE id = 456;
```

**2. 绱㈠紩浼樺寲**
```sql
-- 鍒涘缓澶嶅悎绱㈠紩
CREATE INDEX idx_text_patient_status
ON patient_text_data(patient_id, status, created_at DESC);

-- 鍒涘缓 JSONB GIN 绱㈠紩
CREATE INDEX idx_lab_data_gin
ON patient_lab_data USING GIN(lab_data);

-- 鏌ヨ浼樺寲
SELECT * FROM patient_lab_data
WHERE patient_id = 123
  AND lab_data @> '{"鐧界粏鑳炶鏁?: {}}'::jsonb;
```

**3. LATERAL JOIN 浼樺寲**
```sql
-- 鏇夸唬澶氭鏌ヨ锛屼竴娆℃€ц幏鍙栨渶鏂版暟鎹?
SELECT p.*,
       text_data.summary,
       ct_data.analysis
FROM patients p
LEFT JOIN LATERAL (
    SELECT final_summary AS summary
    FROM patient_text_data
    WHERE patient_id = p.patient_id
    ORDER BY created_at DESC
    LIMIT 1
) text_data ON true
LEFT JOIN LATERAL (
    SELECT analysis_result AS analysis
    FROM patient_ct_data
    WHERE patient_id = p.patient_id
    ORDER BY created_at DESC
    LIMIT 1
) ct_data ON true
WHERE p.patient_id = $1;
```

### 6.2 缃戠粶浼犺緭浼樺寲

**1. 鏁版嵁搴撶 AI 璁＄畻浼樺娍**

浼犵粺鏋舵瀯锛?
```
鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?   鈶犳煡璇㈡暟鎹?    鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
鈹?鏁版嵁搴?  鈹?鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€> 鈹?搴旂敤灞?  鈹?
鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?                鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
                                  鈹?
                                  鈹?鈶′笂浼犳暟鎹?
                                  鈫?
                            鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
                            鈹?AI API  鈹?
                            鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
                                  鈹?
                                  鈹?鈶㈣繑鍥炵粨鏋?
                                  鈫?
鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?   鈶ｅ瓨鍌ㄧ粨鏋?    鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
鈹?鏁版嵁搴?  鈹?<鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€ 鈹?搴旂敤灞?  鈹?
鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?                鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?

缃戠粶寰€杩? 4 娆?
鏁版嵁浼犺緭: 鍘熷鏁版嵁 + AI 缁撴灉
寤惰繜: 500-2000ms
```

鏈郴缁熸灦鏋勶細
```
鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
鈹?鏁版嵁搴?+ AI 鎻掍欢     鈹?
鈹? 鈶犳煡璇㈡暟鎹?          鈹?
鈹? 鈶I 鍒嗘瀽锛堝唴閮級    鈹?
鈹? 鈶㈠瓨鍌ㄧ粨鏋?          鈹?
鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
         鈹?
         鈹?鈶ｈ繑鍥炴渶缁堢粨鏋?
         鈫?
    鈹屸攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?
    鈹?搴旂敤灞?  鈹?
    鈹斺攢鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹€鈹?

缃戠粶寰€杩? 1 娆?
鏁版嵁浼犺緭: 浠呮渶缁堢粨鏋?
寤惰繜: 200-800ms
```

**鎬ц兘瀵规瘮**锛?
| 鎸囨爣 | 浼犵粺鏋舵瀯 | 鏈郴缁?| 鎻愬崌 |
|------|---------|--------|------|
| 缃戠粶寰€杩?| 4 娆?| 1 娆?| **75%鈫?* |
| 鏁版嵁浼犺緭閲?| ~5MB | ~500KB | **90%鈫?* |
| 骞冲潎寤惰繜 | 1200ms | 500ms | **58%鈫?* |

**2. CDN 鍔犻€?*
```javascript
// 涓冪墰浜?CDN 閰嶇疆
const QINIU_DOMAIN = 'https://qiniu.aihubzone.cn';

// 鍥剧墖 URL 鑷姩 CDN 鍔犻€?
const imageUrl = `${QINIU_DOMAIN}/opentenbase/text/report1.png`;
// 鍏ㄧ悆 CDN 鑺傜偣鍒嗗彂锛屽钩鍧囪闂欢杩?< 50ms
```

### 6.3 AI 璋冪敤鎬ц兘浼樺寲

**1. 杩炴帴姹犵鐞?*
```javascript
// backend/src/config/db.js
const pool = new Pool({
  host: '127.0.0.1',
  port: 5432,
  user: 'username',
  password: 'pwd',
  database: 'db',
  max: 20,                  // 鏈€澶ц繛鎺ユ暟
  idleTimeoutMillis: 30000, // 绌洪棽杩炴帴瓒呮椂
  connectionTimeoutMillis: 2000
});
```

**2. 骞惰 AI 璋冪敤**
```javascript
// 骞惰澶勭悊澶氫釜鎮ｈ€呯殑璇婃柇
const diagnosisPromises = patientIds.map(patientId =>
  query('SELECT smart_diagnosis_v3($1) AS result', [patientId])
);

const results = await Promise.all(diagnosisPromises);
```

**3. 缁撴灉缂撳瓨**
```javascript
// 缂撳瓨璇婃柇缁撴灉锛堥伩鍏嶉噸澶?AI 璋冪敤锛?
const cacheKey = `diagnosis:${patientId}:${dataHash}`;
let diagnosisResult = cache.get(cacheKey);

if (!diagnosisResult) {
  diagnosisResult = await query(
    'SELECT smart_diagnosis_v3($1) AS result',
    [patientId]
  );
  cache.set(cacheKey, diagnosisResult, 3600); // 缂撳瓨 1 灏忔椂
}
```

---

## 闄勫綍

### A. 鏁版嵁搴撹〃瀹屾暣 DDL

```sql
-- 1. 鎮ｈ€呰〃
CREATE TABLE patients (
    patient_id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    age INTEGER NOT NULL,
    gender VARCHAR(10) NOT NULL,
    phone VARCHAR(20),
    id_card VARCHAR(50),
    first_visit BOOLEAN DEFAULT TRUE,
    past_medical_history TEXT,
    latest_condition TEXT,
    condition_updated_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
) DISTRIBUTE BY HASH(patient_id);

-- 2. 鐥呭巻鏂囨湰鏁版嵁琛?
CREATE TABLE patient_text_data (
    id SERIAL PRIMARY KEY,
    patient_id INTEGER NOT NULL,
    image_url TEXT,
    ai_summary TEXT,
    final_summary TEXT,
    status VARCHAR(20) DEFAULT 'pending',
    edited BOOLEAN DEFAULT FALSE,
    edited_by INTEGER,
    edit_reason TEXT,
    version INTEGER DEFAULT 1,
    error_message TEXT,
    analyzed_at TIMESTAMP,
    reviewed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
) DISTRIBUTE BY HASH(patient_id);

-- 3. CT 褰卞儚鏁版嵁琛?
CREATE TABLE patient_ct_data (
    id SERIAL PRIMARY KEY,
    patient_id INTEGER NOT NULL,
    ct_url TEXT NOT NULL,
    segmented_url TEXT,
    scan_part VARCHAR(50),
    analysis_result TEXT,
    findings JSONB,
    status VARCHAR(20) DEFAULT 'pending',
    analyzed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
) DISTRIBUTE BY HASH(patient_id);

-- 4. 瀹為獙瀹ゆ寚鏍囨暟鎹〃
CREATE TABLE patient_lab_data (
    id SERIAL PRIMARY KEY,
    patient_id INTEGER NOT NULL,
    image_url TEXT,
    lab_data JSONB NOT NULL,
    status VARCHAR(20) DEFAULT 'pending',
    analyzed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT NOW()
) DISTRIBUTE BY HASH(patient_id);

-- 5. 缁煎悎璇婃柇璁板綍琛?
CREATE TABLE patient_diagnosis (
    id SERIAL PRIMARY KEY,
    patient_id INTEGER NOT NULL,
    diagnosis_text TEXT NOT NULL,
    confidence_score DECIMAL(5,2),
    risk_score DECIMAL(5,2),
    treatment_plan TEXT,
    follow_up_advice TEXT,
    evidence_json JSONB,
    model_version VARCHAR(50),
    created_by INTEGER,
    reviewed_by INTEGER,
    status VARCHAR(20) DEFAULT 'pending',
    created_at TIMESTAMP DEFAULT NOW(),
    reviewed_at TIMESTAMP
) DISTRIBUTE BY HASH(patient_id);

-- 6. 鍒嗘瀽浠诲姟琛?
CREATE TABLE analysis_tasks (
    task_id SERIAL PRIMARY KEY,
    patient_id INTEGER NOT NULL,
    task_type VARCHAR(50) NOT NULL,
    status VARCHAR(20) DEFAULT 'pending',
    result JSONB,
    error_message TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    started_at TIMESTAMP,
    completed_at TIMESTAMP
) DISTRIBUTE BY HASH(patient_id);

-- 7. 鐢ㄦ埛琛?
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role VARCHAR(20) DEFAULT 'doctor',
    name VARCHAR(100),
    email VARCHAR(100),
    created_at TIMESTAMP DEFAULT NOW()
) DISTRIBUTE BY HASH(id);

-- 8. 瀹¤鏃ュ織琛?
CREATE TABLE audit_logs (
    id SERIAL PRIMARY KEY,
    user_id INTEGER,
    action VARCHAR(50) NOT NULL,
    resource VARCHAR(100) NOT NULL,
    resource_id INTEGER,
    old_value JSONB,
    new_value JSONB,
    ip_address VARCHAR(50),
    user_agent TEXT,
    metadata JSONB,
    created_at TIMESTAMP DEFAULT NOW()
) DISTRIBUTE BY HASH(id);

-- 鍒涘缓绱㈠紩
CREATE INDEX idx_text_patient_status ON patient_text_data(patient_id, status, created_at DESC);
CREATE INDEX idx_ct_patient_status ON patient_ct_data(patient_id, status, created_at DESC);
CREATE INDEX idx_lab_patient_status ON patient_lab_data(patient_id, status, created_at DESC);
CREATE INDEX idx_diagnosis_patient ON patient_diagnosis(patient_id, created_at DESC);
CREATE INDEX idx_tasks_patient_status ON analysis_tasks(patient_id, status, created_at DESC);
CREATE INDEX idx_lab_data_gin ON patient_lab_data USING GIN(lab_data);
CREATE INDEX idx_diagnosis_evidence_gin ON patient_diagnosis USING GIN(evidence_json);
```

### B. 鏍稿績绠楁硶浼唬鐮?

**澶氭ā鎬佽瀺鍚堣瘖鏂畻娉?*锛?
```
绠楁硶锛歁ultimodalDiagnosisFusion(patient_id)
杈撳叆锛歱atient_id锛堟偅鑰匢D锛?
杈撳嚭锛歞iagnosis_result锛堣瘖鏂粨鏋淛SON锛?

1. 鏁版嵁鑾峰彇闃舵
   data 鈫?GetMultimodalData(patient_id)
   // 鍖呭惈: patient_info, text_data, ct_data, lab_data, data_quality

2. 鏁版嵁璐ㄩ噺璇勪及
   quality 鈫?EvaluateDataQuality(data)
   // 璁＄畻姣忎釜妯℃€佺殑瀹屾暣鎬с€佹椂鏁堟€с€佸噯纭€?

3. 鍔ㄦ€佹潈閲嶈绠?
   weights 鈫?CalculateDynamicWeights(quality)
   // 鏍规嵁鏁版嵁璐ㄩ噺鑷€傚簲璋冩暣鏉冮噸
   // text_weight, ct_weight, lab_weight

4. 璇佹嵁鎻愬彇
   evidence 鈫?ExtractKeyEvidence(patient_id)
   // 鎻愬彇姣忎釜妯℃€佺殑鍏抽敭璇婃柇渚濇嵁

5. 寮傚父妫€娴?
   anomalies 鈫?DetectLabAnomalies(patient_id)
   // 浣跨敤 Z-score 绠楁硶妫€娴嬪疄楠屽鎸囨爣寮傚父
   // 涓夌骇鍒嗙被: 杞诲井/涓害/涓ラ噸

6. AI 鎻愮ず璇嶆瀯寤?
   prompt 鈫?BuildAIPrompt(data, weights, evidence, anomalies)
   // 缁撴瀯鍖栨彁绀鸿瘝锛屽寘鍚墍鏈変笂涓嬫枃淇℃伅

7. AI 璇婃柇鐢熸垚
   ai_diagnosis 鈫?ai.generate_text(prompt)
   // 鏁版嵁搴撳唴 AI 璋冪敤

8. 缃俊搴﹁绠?
   confidence_raw 鈫?CalculateConfidence(quality)
   // 鍩轰簬鏁版嵁瀹屾暣鎬х殑閲忓寲璇勫垎

9. 缃俊搴︽牎鍑?
   confidence_calibrated 鈫?CalibrateConfidence(confidence_raw)
   // 淇濆畧绛栫暐 + 92% 涓婇檺

10. 缁撴灉瀛樺偍
    result 鈫?{
      diagnosis: ai_diagnosis,
      confidence: confidence_calibrated,
      evidence: evidence,
      anomalies: anomalies,
      weights: weights
    }
    SaveDiagnosisResult(patient_id, result)

11. 杩斿洖缁撴灉
    return result
```

---

**鏂囨。鐗堟湰**锛歷1.0
**鏈€鍚庢洿鏂?*锛?025-10-16
**浣滆€?*锛氬懆浣宠豹
**鑱旂郴鏂瑰紡**锛歫hzhou0704@163.com

