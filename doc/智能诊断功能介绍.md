一键智能诊断现在是一条完全由数据库驱动的流水线，整体工作原理可分为六个阶段（全部在 smart_diagnosis_v3 及其辅助函数中完成），然后由后端与前端进行展示：

------

### 1. 数据准备 – prepare_diagnosis_context(p_patient_id)

- 汇总该患者的基础信息、最近一条的病历文本、CT 分析、检验结果，以及最新的异常指标、历史诊断。
- 只取状态正常（status != 'failed'）且拍板后的记录，优先使用最终审核结果。
- 产出一个 JSONB 上下文，为后续步骤提供所有原始数据。

### 2. 证据建模 – compute_evidence_profile(p_context)

- 读取 evidence_weights 最新版本权重（若无则默认 0.33/0.33/0.34）。
- 对病历、影像、检验分别生成一行摘要，并整理出 detail 字段（含原始结构化数据）。
- 返回值中包含 summary、detail 以及实际权重，为风险评估和 AI 提示词提供输入。

### 3. 风险评估 – compute_risk_profile(p_context, p_evidence)

- 基于检验异常数量及证据权重估算 0~1 的 risk_score，再映射为 low/medium/high。
- 结果中包含 risk_score、risk_level 和异常项数量。

### 4. AI 诊断生成 – generate_ai_diagnosis(...)

- 以患者信息、证据摘要、风险洞察为提示词，调用 OpenTenBase ai.generate_text。
- 解析返回 JSON，附带容错逻辑：若模型输出被 Markdown 包裹或不符 JSON，自动清洗并提供兜底诊断/分析文本。
- 输出字段：diagnosis、analysis、recommendations、warnings、confidence，同时保留原始文本 raw_text。

### 5. 置信度校准 – apply_confidence_calibration(...)

- 查询 model_calibration 中 smart_diagnosis_v3 的最新参数（温度缩放或线性校准）。
- 对原始置信度进行校准（无配置时直接返回原值）。

### 6. 结果落库与回传 – persist_diagnosis_result(...)

- 将最终诊断写入 patient_diagnosis（含 AI 原文、诊断依据、证据摘要、风险分数、校准后置信度）。

- 记录 analysis_tasks 方便追踪任务；同时，API 层会写 audit_logs（调用发生在后端路由）。

- 函数返回 JSON：

  json

  

  `{  "patient_id": ...,  "diagnosis_id": ...,  "diagnosis": "...",  "analysis": "...",  "confidence": 0.82,  "calibrated_confidence": 0.78,  "risk_score": 0.46,  "risk_level": "medium",  "evidence_summary": [...],  "evidence_detail": {...},  "recommendations": [...],  "warnings": [...],  "metadata": {...},  "source": "plpgsql",  "generated_at": "2025-10-09T..." } `

------

### 后端与前端的交互

1. **后端路由 /api/db-analysis/smart-diagnosis**

   - 调用 smart_diagnosis_v3，将返回的 JSON 直接透传给前端，出现错误时返回提示，并记录日志/审计。
   - 校准接口默认指向 smart_diagnosis_v3。

2. **前端 SmartDiagnosisPanel.vue 展示**

   - 顶部卡片：主诊断、原置信度/校准后置信度、风险百分比，生成时间与诊断 ID。

   - analysis 自动分段展示。

   - evidence_summary 列表化，强调主要证据。

   - evidence_detail

     ：

     - 病历：摘要及关键发现；
     - 影像：分析文本及“查看影像”链接；
     - 检验：结构化表格列出指标名称、数值、参考范围，并单列异常指标列表；
     - 风险提醒 warnings 与治疗/随访 recommendations 分块展示。

   - RiskScoreGauge 以图形呈现风险指数。

------

### 结果输出与落地快照

- patient_diagnosis：存储 AI 原始内容、校准置信度、风险评分、证据细节（JSONB）、推荐/医嘱等，可供日志与 PDF 导出复用。
- analysis_tasks：记录诊断任务流程（状态、耗时、诊断 ID 等）。
- audit_logs：后端路由每次调用完成后登记操作痕迹。
- 前端展示完全靠函数返回的结构化数据，用户看到的是格式化后的自然语言、清晰的证据与检验指标表，而不是生硬的 JSON。

------

如果后续需要扩展（例如更多风险模型、关联医生审核流程、PDF 凭证或旧逻辑切换），基于上述结构都可以继续演化。当前流程已经实现了“数据库端聚合 → AI 调用 → 结果落地 → 前端立即可视化”的闭环。