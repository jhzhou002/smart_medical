# 医疗多模态智能分析平台 - 使用文档

## 目录

- [1. 安装与部署](#1-安装与部署)
  - [1.1 环境要求](#11-环境要求)
  - [1.2 快速启动](#12-快速启动)
  - [1.3 环境变量配置](#13-环境变量配置)
  - [1.4 数据库配置](#14-数据库配置)
  - [1.5 生产环境部署](#15-生产环境部署)
- [2. 功能使用指南](#2-功能使用指南)
  - [2.1 患者管理](#21-患者管理)
  - [2.2 数据上传与分析](#22-数据上传与分析)
  - [2.3 智能诊断](#23-智能诊断)
  - [2.4 诊断报告查看](#24-诊断报告查看)
  - [2.5 PDF 报告导出](#25-pdf-报告导出)
- [3. API 接口文档](#3-api-接口文档)
  - [3.1 认证接口](#31-认证接口)
  - [3.2 患者管理接口](#32-患者管理接口)
  - [3.3 文本分析接口](#33-文本分析接口)
  - [3.4 CT 分析接口](#34-ct-分析接口)
  - [3.5 实验室指标接口](#35-实验室指标接口)
  - [3.6 智能诊断接口](#36-智能诊断接口)
  - [3.7 数据库端分析接口](#37-数据库端分析接口)
- [4. 常见问题](#4-常见问题)
  - [4.1 安装问题](#41-安装问题)
  - [4.2 运行问题](#42-运行问题)
  - [4.3 功能问题](#43-功能问题)
- [5. 故障排查](#5-故障排查)
  - [5.1 后端服务问题](#51-后端服务问题)
  - [5.2 前端问题](#52-前端问题)
  - [5.3 数据库问题](#53-数据库问题)
  - [5.4 AI 分析问题](#54-ai-分析问题)

---

## 1. 安装与部署

### 1.1 环境要求

**硬件要求**：
- CPU: 2 核及以上
- 内存: 8GB 及以上
- 硬盘: 40GB 可用空间

**软件要求**：
- Node.js: >= 18.0.0
- npm: >= 9.0.0
- OpenTenBase 数据库（已安装 `opentenbase_ai` 插件）
- 七牛云账号（对象存储服务）

**支持的操作系统**：
- Windows 10/11
- macOS 10.15+
- Linux (Ubuntu 20.04+, CentOS 8+)

### 1.2 快速启动

#### 第一步：克隆项目

```bash
# 克隆代码仓库
git clone https://github.com/jhzhou002/smart_medical.git
cd smart_medical
```

#### 第二步：启动后端服务

```bash
# 进入后端目录
cd backend

# 安装依赖
npm install

# 配置环境变量
cp .env.example .env
# 编辑 .env 文件，填写数据库和七牛云配置（详见 1.3 节）

# 启动后端（开发模式，带自动重载）
npm run dev

# 后端服务将运行在 http://127.0.0.1:3000
```

#### 第三步：启动前端服务（新终端窗口）

```bash
# 进入前端目录
cd frontend

# 安装依赖
npm install

# 启动前端（开发模式，带热更新）
npm run dev

# 前端服务将运行在 http://127.0.0.1:5173
```

#### 第四步：访问系统

打开浏览器访问：**http://127.0.0.1:5173**

### 1.3 环境变量配置

**后端环境变量** (`backend/.env`)：

```bash
# ====== 数据库配置 ======
# 重要：必须使用 127.0.0.1，不要使用 localhost
DB_HOST=127.0.0.1
DB_PORT=5432
DB_USER=username
DB_PASSWORD=pwd
DB_NAME=db

# ====== 服务器配置 ======
PORT=3000
NODE_ENV=development

# ====== 七牛云对象存储配置 ======
QINIU_ACCESS_KEY=your_access_key_here
QINIU_SECRET_KEY=your_secret_key_here
QINIU_BUCKET=your_bucket_name
QINIU_DOMAIN=your_domain

# ====== JWT 认证配置（可选）======
JWT_SECRET=your-secret-key-here-change-in-production
JWT_EXPIRES_IN=7d

# ====== 文件上传配置 ======
MAX_FILE_SIZE=52428800  # 50MB

# ====== 日志配置 ======
LOG_LEVEL=info
LOG_FILE_PATH=./logs
```

**前端环境变量** (`frontend/.env.development`)：

```bash
# 开发环境 API 地址
VITE_API_BASE_URL=/api
```

**重要提示**：本项目通过 SSH 隧道连接到远程 OpenTenBase 数据库。

#### SSH 隧道配置

在开始之前，确保 SSH 隧道已建立（保持终端运行）：

```bash
# 建立 SSH 隧道（端口转发）
ssh -L 5432:内网IP:port opentenbase@公网IP

# 输入密码后，保持该终端窗口运行
# 不要关闭此窗口，否则数据库连接会中断
```

#### 数据库连接参数

| 参数 | 值 | 说明 |
|------|-----|------|
| **主机** | `127.0.0.1` | ⚠️ 必须使用 127.0.0.1，不要使用 localhost |
| **端口** | `5432` | SSH 隧道本地端口 |
| **用户名** | `opentenbase` | 数据库用户 |
| **密码** | `zhjh0704` | 数据库密码 |
| **数据库名** | `smart_medical` | 项目数据库 |

#### 验证数据库连接

```bash
# 方法1：通过健康检查接口
curl http://127.0.0.1:3000/health

# 预期响应：
# {
#   "status": "ok",
#   "database": "connected",
#   "timestamp": "2025-01-15T10:30:00.000Z"
# }

# 方法2：通过 Node.js 脚本（推荐）
# 创建文件 backend/test-db-connection.js
node backend/test-db-connection.js
```

**测试脚本示例** (`backend/test-db-connection.js`)：

```javascript
require('dotenv').config({ path: require('path').join(__dirname, '.env') });
const { query, testConnection } = require('./src/config/db');

async function test() {
  try {
    // 测试连接
    await testConnection();
    console.log('✅ 数据库连接成功');

    // 查询表列表
    const tables = await query(`
      SELECT tablename FROM pg_tables
      WHERE schemaname = 'public'
      ORDER BY tablename
    `);
    console.log('📋 数据库表列表:', tables.rows.map(r => r.tablename));

    process.exit(0);
  } catch (error) {
    console.error('❌ 数据库连接失败:', error.message);
    process.exit(1);
  }
}

test();
```

### 1.5 生产环境部署

#### 方案一：手动部署

**1. 构建前端**：
```bash
cd frontend
npm run build

# 生成的静态文件位于 frontend/dist/
```

**2. 配置 Nginx**：
```nginx
# /etc/nginx/conf.d/smart_medical.conf

server {
    listen 80;
    server_name your-domain.com;

    # 前端静态文件
    location / {
        root /var/www/smart_medical/frontend/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # 后端 API 代理
    location /api {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

**3. 启动后端**（使用 PM2）：
```bash
# 安装 PM2
npm install -g pm2

# 启动后端服务
cd backend
pm2 start src/app.js --name smart-medical-api

# 设置开机自启
pm2 startup
pm2 save

# 查看日志
pm2 logs smart-medical-api
```

## 2. 功能使用指南

### 2.1 患者管理

#### 创建新患者

1. **访问患者管理页面**
   - 点击左侧菜单 "患者管理"

2. **填写患者信息**
   - 点击"新增患者"按钮
   - 填写必填信息：
     * 姓名（2-100 个字符）
     * 年龄（0-150 岁）
     * 性别（男/女/其他）
   - 选填信息：
     * 手机号（11 位手机号）
     * 身份证号
     * 是否首次就诊
     * 过往病史（文本）
     * 历史病症（文本）

3. **保存患者**
   - 点击"确定"按钮
   - 系统自动生成患者 ID

**示例**：
```
姓名: 张三
年龄: 45
性别: 男
手机号: 13800138000
过往病史: 高血压 5 年，糖尿病 3 年
历史病症: 近期头晕，血压控制不佳
```

#### 查询患者

**方法1：列表浏览**
- 患者列表默认按创建时间倒序排列
- 支持分页浏览

**方法2：搜索查询**
- 输入搜索关键词（姓名/手机号/身份证号）
- 系统自动模糊匹配

**方法3：患者详情**
- 点击"查看"按钮查看患者完整档案
- 包含：基本信息、病历数据、CT 数据、实验室数据、诊断记录

#### 编辑患者

1. 点击患者列表中的"编辑"按钮
2. 修改需要更新的字段
3. 点击"确定"保存修改

#### 删除患者

⚠️ **危险操作**：删除患者将同时删除其所有关联数据（病历、CT、实验室、诊断记录）

1. 点击"删除"按钮
2. 确认删除操作
3. 系统执行级联删除

### 2.2 数据上传与分析

#### 病历文本上传

**方式1：上传病历图片（OCR 识别）**

1. 访问"AI 智能分析"页面
2. 选择患者
3. 切换到"病历文本"标签页
4. 选择"上传病历图片（OCR 识别）"
5. 拖拽或点击上传病历图片
   - 支持格式：JPG、PNG
   - 文件大小：≤ 10MB
6. 系统自动执行：
   - ① 上传到七牛云
   - ② AI OCR 识别文本
   - ③ 生成自然语言总结
   - ④ 存入数据库
7. 查看并编辑 AI 生成的病历总结
8. 点击"保存"确认

**方式2：使用患者病史信息**

1. 选择"使用患者病史信息"
2. 系统自动加载患者的"过往病史"和"历史病症"
3. 可在此基础上补充或修改
4. 点击"保存为病历总结"

**示例**：
```
AI 生成的病历总结：
患者主诉头晕 3 天，伴有恶心。既往高血压病史 5 年，糖尿病病史 3 年。
体格检查：血压 160/100 mmHg，心率 88 次/分。
初步诊断：高血压急症，血糖控制不佳。
```

#### CT 影像上传

1. 切换到"CT 影像"标签页
2. 拖拽或点击上传 CT 影像
   - 支持格式：JPG、PNG
   - 文件大小：≤ 10MB
3. 系统自动执行：
   - ① 上传原始 CT 到七牛云
   - ② AI 影像分析
   - ③ 生成影像学报告
4. 查看并编辑 AI 分析结果

**AI 分析内容**：
- CT 影像描述
- 病灶位置和性质
- 影像学诊断建议

#### 实验室指标上传

1. 切换到"实验室指标"标签页
2. 拖拽或点击上传实验室检查单图片
   - 支持格式：JPG、PNG
   - 文件大小：≤ 10MB
3. 系统自动执行：
   - ① 上传到七牛云
   - ② AI 表格识别
   - ③ 提取结构化数据（JSON 格式）
4. 查看并编辑识别的指标数据

**识别的数据格式**：
```
| 指标名称    | 缩写 | 检测值 | 单位     | 参考范围 |
|------------|------|--------|---------|---------|
| 白细胞计数  | WBC  | 15.2   | 10^9/L  | 4-10    |
| 红细胞计数  | RBC  | 4.5    | 10^12/L | 3.5-5.5 |
| 血红蛋白    | HGB  | 130    | g/L     | 120-160 |
```

### 2.3 智能诊断

#### 生成综合诊断

**前提条件**：
- 至少上传了一种模态的数据（病历/CT/实验室指标）
- 数据状态为"已审核"（approved）

**操作步骤**：

1. 在"AI 智能分析"页面，确保已选择患者
2. 确认已上传所需数据
3. 点击"生成综合诊断"按钮
4. 系统执行（约 10-30 秒）：
   - ① 创建诊断任务
   - ② 后台调用 PL/pgSQL 存储过程
   - ③ 执行 10 步诊断流程：
     * 获取多模态数据
     * 提取关键证据
     * 检测异常指标
     * 计算动态权重
     * 构建 AI 提示词
     * 调用 AI 生成诊断
     * 计算置信度
     * 置信度校准
     * 存储诊断结果
   - ④ 前端每 2 秒轮询一次状态
5. 诊断完成后，自动显示诊断结果

**诊断结果包含**：
- **诊断结论**：AI 生成的综合诊断文本
- **置信度评分**：0-92 分（永不达 100%）
- **风险评分**：0-100 分
- **治疗建议**：AI 推荐的治疗方案
- **随访建议**：后续跟踪计划

**示例诊断结果**：
```
【综合诊断】
根据患者的病历、CT 影像和实验室检查结果，综合诊断如下：

1. 高血压急症（血压 160/100 mmHg，明显高于正常范围）
2. 糖尿病血糖控制不佳（空腹血糖 12.5 mmol/L，超过参考范围 56%）
3. 白细胞增多（WBC 15.2，提示可能存在感染）

【诊断依据】
- 病历记录：患者主诉头晕 3 天，既往高血压、糖尿病病史
- 实验室指标：血压显著升高，血糖超标，白细胞计数异常
- 证据权重：实验室指标 40%，病历文本 35%，患者信息 25%

【治疗建议】
1. 立即降压治疗（口服降压药或静脉给药）
2. 调整降糖方案，控制血糖至目标范围
3. 进一步检查感染原因（血常规复查、尿常规、胸片等）
4. 住院观察，密切监测生命体征

【随访计划】
- 3 天后复查血压、血糖
- 1 周后复查血常规
- 1 个月后门诊随访，评估血压、血糖控制情况

【置信度评分】85.6 分
```

#### 查看异常指标

系统自动标注实验室指标的异常严重程度：

| 指标 | 检测值 | 参考范围 | 偏离度 | 百分比 | 严重程度 |
|------|--------|---------|--------|--------|---------|
| 白细胞计数 | 15.2 | 4-10 | 3.47σ | 52% | 🔴 严重 |
| 血糖 | 12.5 | 3.9-6.1 | 2.56σ | 56% | 🔴 严重 |
| 血红蛋白 | 115 | 120-160 | -0.25σ | -4.2% | 🟡 轻微 |

**严重程度分级规则**：
- 🟢 **正常**：在参考范围内
- 🟡 **轻微**：偏离 < 1σ
- 🟠 **中度**：1σ ≤ 偏离 < 2σ
- 🔴 **严重**：偏离 ≥ 2σ

### 2.4 诊断报告查看

#### 访问诊断报告页面

**方法1**：通过导航菜单
- 点击左侧菜单"诊断报告"

**方法2**：通过诊断结果跳转
- 在"AI 智能分析"页面生成诊断后
- 点击"查看完整报告"按钮

#### 诊断报告内容

诊断报告包含以下部分：

**1. 患者基本信息**
```
姓名: 张三
年龄: 45 岁
性别: 男
患者 ID: 9
诊断时间: 2024-01-15 11:30:00
```

**2. 诊断结论**
- AI 生成的综合诊断文本
- 支持 Markdown 格式渲染（加粗、斜体、列表等）

**3. 置信度与风险评分**
- 置信度评分：0-92 分（仪表盘可视化）
- 风险评分：0-100 分（颜色编码）
  - 绿色（0-40）：低风险
  - 黄色（40-70）：中等风险
  - 红色（70-100）：高风险

**4. 证据链**
- 时间轴展示所有诊断依据
- 每条证据标注来源、权重、时间
- 支持点击查看原始数据

**5. 异常指标**
- 表格展示所有异常的实验室指标
- 三色标注严重程度（轻微/中度/严重）
- 显示偏离度和百分比

**6. 治疗建议与随访计划**
- AI 生成的治疗方案
- 随访时间节点和检查项目

### 2.5 PDF 报告导出

#### 导出步骤

1. 在"诊断报告"页面
2. 点击"导出 PDF"按钮
3. 系统生成 PDF 文件（前端生成，无需后端）
4. 浏览器自动下载 PDF 文件

**文件命名格式**：
```
诊断报告_张三_20240115.pdf
```

#### PDF 报告内容

PDF 报告包含完整的诊断信息：

```
╔════════════════════════════════════════════╗
║     医疗多模态智能分析平台 - 诊断报告      ║
╚════════════════════════════════════════════╝

【患者信息】
姓名: 张三           年龄: 45 岁
性别: 男             患者 ID: 9
诊断时间: 2024-01-15 11:30:00

【综合诊断】
(诊断结论完整文本)

【置信度评分】85.6 分
【风险评分】78 分（中高风险）

【诊断依据】
1. [实验室指标] 权重：40%
   白细胞计数 15.2 (正常 4-10)，超出参考范围 52%

2. [病历文本] 权重：35%
   病历记录显示患者发热 3 天，体温 38.5°C

3. [CT 影像] 权重：25%
   CT 影像显示肺部阴影，考虑肺部感染

【异常指标表格】
┌────────────┬────────┬──────────┬────────┬────────┬──────────┐
│ 指标       │ 检测值  │ 参考范围  │ 偏离度  │ 百分比  │ 严重程度  │
├────────────┼────────┼──────────┼────────┼────────┼──────────┤
│ 白细胞计数  │ 15.2   │ 4-10     │ 3.47σ  │ 52%    │ 严重     │
│ 血糖       │ 12.5   │ 3.9-6.1  │ 2.56σ  │ 56%    │ 严重     │
│ 血红蛋白   │ 115    │ 120-160  │ -0.25σ │ -4.2%  │ 轻微     │
└────────────┴────────┴──────────┴────────┴────────┴──────────┘

【治疗建议】
(治疗方案完整文本)

【随访计划】
(随访安排完整文本)

---
报告生成时间: 2025-10-15 11:45:00
系统版本: v1.0
```

---

## 3. API 接口文档

### 3.1 认证接口

#### 用户注册

**接口地址**：`POST /api/auth/register`

**请求参数**：
```json
{
  "username": "doctor01",
  "password": "password123",
  "name": "张医生",
  "email": "zhangdoctor@example.com",
  "role": "doctor"
}
```

**响应示例**：
```json
{
  "success": true,
  "data": {
    "id": 1,
    "username": "doctor01",
    "name": "张医生",
    "role": "doctor",
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  },
  "message": "注册成功"
}
```

#### 用户登录

**接口地址**：`POST /api/auth/login`

**请求参数**：
```json
{
  "username": "doctor01",
  "password": "password123"
}
```

**响应示例**：
```json
{
  "success": true,
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "user": {
      "id": 1,
      "username": "doctor01",
      "name": "张医生",
      "role": "doctor"
    }
  },
  "message": "登录成功"
}
```

#### 获取当前用户信息

**接口地址**：`GET /api/auth/me`

**请求头**：
```
Authorization: Bearer <token>
```

**响应示例**：
```json
{
  "success": true,
  "data": {
    "id": 1,
    "username": "doctor01",
    "name": "张医生",
    "email": "zhangdoctor@example.com",
    "role": "doctor"
  }
}
```

### 3.2 患者管理接口

#### 创建患者

**接口地址**：`POST /api/patients`

**请求参数**：
```json
{
  "name": "张三",
  "age": 45,
  "gender": "男",
  "phone": "13800138000",
  "id_card": "110101198001011234",
  "first_visit": true,
  "past_medical_history": "高血压 5 年，糖尿病 3 年",
  "latest_condition": "近期头晕，血压控制不佳"
}
```

**字段说明**：
- `name` (必填): 患者姓名，2-100 个字符
- `age` (必填): 年龄，0-150 岁
- `gender` (必填): 性别，枚举值："男"、"女"、"其他"
- `phone` (选填): 手机号，11 位数字
- `id_card` (选填): 身份证号
- `first_visit` (选填): 是否首次就诊，默认 true
- `past_medical_history` (选填): 过往病史
- `latest_condition` (选填): 历史病症

**响应示例**：
```json
{
  "success": true,
  "data": {
    "patient_id": 9,
    "name": "张三",
    "age": 45,
    "gender": "男",
    "phone": "13800138000",
    "id_card": "110101198001011234",
    "first_visit": true,
    "past_medical_history": "高血压 5 年，糖尿病 3 年",
    "latest_condition": "近期头晕，血压控制不佳",
    "created_at": "2024-01-15T10:30:00.000Z"
  },
  "message": "患者创建成功"
}
```

#### 获取患者列表

**接口地址**：`GET /api/patients`

**查询参数**：
- `limit` (选填): 每页数量，默认不限制
- `offset` (选填): 偏移量，默认 0
- `orderBy` (选填): 排序字段，默认 `created_at`
- `order` (选填): 排序方向，默认 `DESC`

**示例请求**：
```
GET /api/patients?limit=10&offset=0&orderBy=created_at&order=DESC
```

**响应示例**：
```json
{
  "success": true,
  "data": [
    {
      "patient_id": 9,
      "name": "张三",
      "age": 45,
      "gender": "男",
      "phone": "13800138000",
      "created_at": "2024-01-15T10:30:00.000Z"
    },
    {
      "patient_id": 8,
      "name": "李四",
      "age": 38,
      "gender": "女",
      "phone": "13900139000",
      "created_at": "2024-01-14T15:20:00.000Z"
    }
  ],
  "meta": {
    "total": 2,
    "limit": 10,
    "offset": 0
  }
}
```

#### 获取单个患者详情

**接口地址**：`GET /api/patients/:id`

**示例请求**：
```
GET /api/patients/9
```

**响应示例**：
```json
{
  "success": true,
  "data": {
    "patient_id": 9,
    "name": "张三",
    "age": 45,
    "gender": "男",
    "phone": "13800138000",
    "id_card": "110101198001011234",
    "first_visit": true,
    "past_medical_history": "高血压 5 年，糖尿病 3 年",
    "latest_condition": "近期头晕，血压控制不佳",
    "created_at": "2024-01-15T10:30:00.000Z",
    "updated_at": "2024-01-15T10:30:00.000Z"
  }
}
```

#### 搜索患者

**接口地址**：`GET /api/patients/search/:keyword`

**示例请求**：
```
GET /api/patients/search/张三
```

**响应示例**：
```json
{
  "success": true,
  "data": [
    {
      "patient_id": 9,
      "name": "张三",
      "age": 45,
      "gender": "男",
      "phone": "13800138000"
    }
  ]
}
```

#### 更新患者信息

**接口地址**：`PUT /api/patients/:id`

**请求参数**（只需要提供需要更新的字段）：
```json
{
  "age": 46,
  "latest_condition": "血压已控制，头晕症状缓解"
}
```

**响应示例**：
```json
{
  "success": true,
  "data": {
    "patient_id": 9,
    "name": "张三",
    "age": 46,
    "latest_condition": "血压已控制，头晕症状缓解",
    "updated_at": "2024-01-16T09:00:00.000Z"
  },
  "message": "更新成功"
}
```

#### 删除患者

**接口地址**：`DELETE /api/patients/:id`

**示例请求**：
```
DELETE /api/patients/9
```

**响应示例**：
```json
{
  "success": true,
  "message": "患者删除成功"
}
```

### 3.3 文本分析接口

#### 上传病历图片并分析

**接口地址**：`POST /api/text-analysis/upload`

**请求类型**：`multipart/form-data`

**请求参数**：
- `file` (必填): 病历图片文件，支持 JPG/PNG，≤ 10MB
- `patient_id` (必填): 患者 ID
- `data_type` (选填): 数据类型，默认 `medical_record`

**示例请求**（使用 curl）：
```bash
curl -X POST http://127.0.0.1:3000/api/text-analysis/upload \
  -F "file=@/path/to/medical_record.jpg" \
  -F "patient_id=9" \
  -F "data_type=medical_record"
```

**响应示例**：
```json
{
  "success": true,
  "data": {
    "id": 15,
    "patient_id": 9,
    "image_url": "https://qiniu.aihubzone.cn/opentenbase/text/1705308600000-abc123.jpg",
    "ai_summary": "患者主诉头晕 3 天，伴有恶心。既往高血压病史 5 年...",
    "final_summary": "患者主诉头晕 3 天，伴有恶心。既往高血压病史 5 年...",
    "summary": "患者主诉头晕 3 天，伴有恶心。既往高血压病史 5 年...",
    "status": "approved",
    "created_at": "2024-01-15T10:30:00.000Z"
  },
  "message": "病历分析完成"
}
```

#### 保存历史病症为病历总结

**接口地址**：`POST /api/text-analysis/save-condition`

**请求参数**：
```json
{
  "patient_id": 9,
  "summary": "【过往病史】\n高血压 5 年，糖尿病 3 年\n\n【历史病症】\n近期头晕，血压控制不佳"
}
```

**响应示例**：
```json
{
  "success": true,
  "data": {
    "id": 16,
    "patient_id": 9,
    "image_url": null,
    "ai_summary": "【过往病史】\n高血压 5 年...",
    "final_summary": "【过往病史】\n高血压 5 年...",
    "summary": "【过往病史】\n高血压 5 年...",
    "status": "approved",
    "created_at": "2024-01-15T11:00:00.000Z"
  },
  "message": "病历总结保存成功"
}
```

#### 获取患者的文本数据

**接口地址**：`GET /api/text-analysis/patient/:patientId`

**示例请求**：
```
GET /api/text-analysis/patient/9
```

**响应示例**：
```json
{
  "success": true,
  "data": [
    {
      "id": 16,
      "patient_id": 9,
      "image_url": null,
      "summary": "【过往病史】\n高血压 5 年...",
      "status": "approved",
      "created_at": "2024-01-15T11:00:00.000Z"
    },
    {
      "id": 15,
      "patient_id": 9,
      "image_url": "https://qiniu.aihubzone.cn/...",
      "summary": "患者主诉头晕 3 天...",
      "status": "approved",
      "created_at": "2024-01-15T10:30:00.000Z"
    }
  ]
}
```

#### 更新病历分析结果

**接口地址**：`PUT /api/text-analysis/:text_id`

**请求参数**：
```json
{
  "summary": "修改后的病历总结内容",
  "edit_reason": "补充完善诊断信息"
}
```

**响应示例**：
```json
{
  "success": true,
  "data": {
    "id": 15,
    "patient_id": 9,
    "final_summary": "修改后的病历总结内容",
    "summary": "修改后的病历总结内容",
    "edited": true,
    "edit_reason": "补充完善诊断信息",
    "version": 2,
    "reviewed_at": "2024-01-15T12:00:00.000Z"
  },
  "message": "更新成功"
}
```

#### 删除文本数据

**接口地址**：`DELETE /api/text-analysis/:text_id`

**示例请求**：
```
DELETE /api/text-analysis/15
```

**响应示例**：
```json
{
  "success": true,
  "message": "删除成功"
}
```

### 3.4 CT 分析接口

#### 上传 CT 图片并分析

**接口地址**：`POST /api/ct-analysis/upload`

**请求类型**：`multipart/form-data`

**请求参数**：
- `file` (必填): CT 影像文件，支持 JPG/PNG，≤ 10MB
- `patient_id` (必填): 患者 ID
- `scan_part` (选填): 扫描部位，枚举值："lung"/"liver"/"kidney"/"brain"，默认 "lung"

**示例请求**（使用 curl）：
```bash
curl -X POST http://127.0.0.1:3000/api/ct-analysis/upload \
  -F "file=@/path/to/ct_image.jpg" \
  -F "patient_id=9" \
  -F "scan_part=lung"
```

**响应示例**：
```json
{
  "success": true,
  "data": {
    "id": 12,
    "patient_id": 9,
    "ct_url": "https://qiniu.aihubzone.cn/opentenbase/CT/1705308700000-def456.jpg",
    "scan_part": "lung",
    "analysis_result": "CT 影像显示双肺野清晰，未见明显实质性病变。纵隔居中，心影大小正常。",
    "status": "approved",
    "created_at": "2024-01-14T14:00:00.000Z"
  },
  "message": "CT 影像分析完成"
}
```

#### 获取患者的 CT 数据

**接口地址**：`GET /api/ct-analysis/patient/:patientId`

**示例请求**：
```
GET /api/ct-analysis/patient/9
```

**响应示例**：
```json
{
  "success": true,
  "data": [
    {
      "id": 12,
      "patient_id": 9,
      "ct_url": "https://qiniu.aihubzone.cn/opentenbase/CT/1705308700000-def456.jpg",
      "scan_part": "lung",
      "analysis_result": "CT 影像显示双肺野清晰...",
      "status": "approved",
      "created_at": "2024-01-14T14:00:00.000Z"
    }
  ]
}
```

#### 更新 CT 分析结果

**接口地址**：`PUT /api/ct-analysis/:ct_id`

**请求参数**：
```json
{
  "analysis_result": "修改后的 CT 分析结果"
}
```

**响应示例**：
```json
{
  "success": true,
  "data": {
    "id": 12,
    "patient_id": 9,
    "analysis_result": "修改后的 CT 分析结果",
    "reviewed_at": "2024-01-15T13:00:00.000Z"
  },
  "message": "更新成功"
}
```

#### 删除 CT 数据

**接口地址**：`DELETE /api/ct-analysis/:ct_id`

**示例请求**：
```
DELETE /api/ct-analysis/12
```

**响应示例**：
```json
{
  "success": true,
  "message": "删除成功"
}
```

### 3.5 实验室指标接口

#### 上传实验室指标图片并分析

**接口地址**：`POST /api/lab-analysis/upload`

**请求类型**：`multipart/form-data`

**请求参数**：
- `file` (必填): 实验室指标图片文件，支持 JPG/PNG，≤ 10MB
- `patient_id` (必填): 患者 ID

**示例请求**（使用 curl）：
```bash
curl -X POST http://127.0.0.1:3000/api/lab-analysis/upload \
  -F "file=@/path/to/lab_report.jpg" \
  -F "patient_id=9"
```

**响应示例**：
```json
{
  "success": true,
  "data": {
    "id": 18,
    "patient_id": 9,
    "image_url": "https://qiniu.aihubzone.cn/opentenbase/structure/1705308800000-ghi789.jpg",
    "lab_data": {
      "白细胞计数": {
        "abbreviation": "WBC",
        "value": 15.2,
        "unit": "10^9/L",
        "reference": "4-10"
      },
      "红细胞计数": {
        "abbreviation": "RBC",
        "value": 4.5,
        "unit": "10^12/L",
        "reference": "3.5-5.5"
      },
      "血红蛋白": {
        "abbreviation": "HGB",
        "value": 130,
        "unit": "g/L",
        "reference": "120-160"
      }
    },
    "status": "approved",
    "created_at": "2024-01-15T09:00:00.000Z"
  },
  "message": "实验室指标分析完成"
}
```

#### 获取患者的实验室数据

**接口地址**：`GET /api/lab-analysis/patient/:patientId`

**示例请求**：
```
GET /api/lab-analysis/patient/9
```

**响应示例**：
```json
{
  "success": true,
  "data": [
    {
      "id": 18,
      "patient_id": 9,
      "image_url": "https://qiniu.aihubzone.cn/...",
      "lab_data": {
        "白细胞计数": {
          "abbreviation": "WBC",
          "value": 15.2,
          "unit": "10^9/L",
          "reference": "4-10"
        }
      },
      "status": "approved",
      "created_at": "2024-01-15T09:00:00.000Z"
    }
  ]
}
```

#### 更新实验室指标数据

**接口地址**：`PUT /api/lab-analysis/:lab_id`

**请求参数**：
```json
{
  "lab_data": {
    "白细胞计数": {
      "abbreviation": "WBC",
      "value": 14.8,
      "unit": "10^9/L",
      "reference": "4-10"
    },
    "红细胞计数": {
      "abbreviation": "RBC",
      "value": 4.5,
      "unit": "10^12/L",
      "reference": "3.5-5.5"
    }
  }
}
```

**响应示例**：
```json
{
  "success": true,
  "data": {
    "id": 18,
    "patient_id": 9,
    "lab_data": {
      "白细胞计数": {
        "abbreviation": "WBC",
        "value": 14.8,
        "unit": "10^9/L",
        "reference": "4-10"
      },
      "红细胞计数": {
        "abbreviation": "RBC",
        "value": 4.5,
        "unit": "10^12/L",
        "reference": "3.5-5.5"
      }
    },
    "reviewed_at": "2024-01-15T14:00:00.000Z"
  },
  "message": "更新成功"
}
```

#### 删除实验室数据

**接口地址**：`DELETE /api/lab-analysis/:lab_id`

**示例请求**：
```
DELETE /api/lab-analysis/18
```

**响应示例**：
```json
{
  "success": true,
  "message": "删除成功"
}
```

### 3.6 智能诊断接口

#### 生成综合诊断（应用层）

**接口地址**：`POST /api/diagnosis`

**请求参数**：
```json
{
  "patient_id": 9
}
```

**响应示例**：
```json
{
  "success": true,
  "data": {
    "id": 5,
    "patient_id": 9,
    "diagnosis_text": "根据患者的病历、CT 影像和实验室检查结果...",
    "confidence_score": 85.6,
    "risk_score": 78,
    "treatment_plan": "1. 立即降压治疗...",
    "follow_up_advice": "3 天后复查血压、血糖...",
    "evidence_json": {
      "evidence": [...]
    },
    "status": "pending",
    "created_at": "2024-01-15T11:30:00.000Z"
  },
  "message": "综合诊断生成成功"
}
```

#### 获取患者的诊断记录

**接口地址**：`GET /api/diagnosis/patient/:patientId`

**示例请求**：
```
GET /api/diagnosis/patient/9
```

**响应示例**：
```json
{
  "success": true,
  "data": [
    {
      "id": 5,
      "patient_id": 9,
      "diagnosis_text": "根据患者的病历、CT 影像和实验室检查结果...",
      "confidence_score": 85.6,
      "risk_score": 78,
      "created_at": "2024-01-15T11:30:00.000Z"
    }
  ]
}
```

### 3.7 数据库端分析接口

#### 多模态数据统一查询

**接口地址**：`GET /api/db-analysis/multimodal/:patient_id`

**示例请求**：
```
GET /api/db-analysis/multimodal/9
```

**响应示例**：
```json
{
  "success": true,
  "data": {
    "patient_info": {
      "patient_id": 9,
      "name": "张三",
      "age": 45,
      "gender": "男"
    },
    "text_data": "患者主诉头晕 3 天...",
    "ct_data": {
      "ct_url": "https://qiniu.aihubzone.cn/...",
      "analysis": "CT 影像显示..."
    },
    "lab_data": {
      "白细胞计数": {
        "value": 15.2,
        "unit": "10^9/L",
        "reference": "4-10"
      }
    },
    "data_quality": {
      "text_available": true,
      "ct_available": true,
      "lab_available": true
    }
  }
}
```

#### 关键证据提取

**接口地址**：`GET /api/db-analysis/evidence/:patient_id`

**示例请求**：
```
GET /api/db-analysis/evidence/9
```

**响应示例**：
```json
{
  "success": true,
  "data": [
    {
      "source": "lab_data",
      "weight": 0.4,
      "content": "白细胞计数 15.2 (正常 4-10)，超出参考范围 52%"
    },
    {
      "source": "text_data",
      "weight": 0.35,
      "content": "病历记录显示患者发热 3 天，体温 38.5°C"
    },
    {
      "source": "ct_data",
      "weight": 0.25,
      "content": "CT 影像显示肺部阴影，考虑肺部感染"
    }
  ]
}
```

#### 实验室指标异常检测

**接口地址**：`GET /api/db-analysis/anomalies/:patient_id`

**示例请求**：
```
GET /api/db-analysis/anomalies/9
```

**响应示例**：
```json
{
  "success": true,
  "data": [
    {
      "indicator": "白细胞计数",
      "value": 15.2,
      "reference": "4-10",
      "deviation": 3.47,
      "severity": "严重",
      "percentage": 52.0
    },
    {
      "indicator": "血糖",
      "value": 12.5,
      "reference": "3.9-6.1",
      "deviation": 2.56,
      "severity": "严重",
      "percentage": 56.0
    }
  ]
}
```

#### 智能诊断（PL/pgSQL 存储过程）

**接口地址**：`POST /api/db-analysis/smart-diagnosis`

**请求参数**：
```json
{
  "patient_id": 9
}
```

**响应示例**（立即返回）：
```json
{
  "success": true,
  "data": {
    "task_id": 42
  },
  "message": "诊断任务已创建，正在后台处理"
}
```

**查询诊断结果**：`GET /api/db-analysis/smart-diagnosis/:patient_id`

**示例请求**：
```
GET /api/db-analysis/smart-diagnosis/9
```

**响应示例**（诊断完成后）：
```json
{
  "success": true,
  "data": {
    "id": 5,
    "patient_id": 9,
    "diagnosis_text": "根据患者的病历、CT 影像和实验室检查结果，综合诊断如下：\n\n1. 高血压急症...",
    "confidence_score": 85.6,
    "risk_score": 78,
    "treatment_plan": "1. 立即降压治疗...",
    "follow_up_advice": "3 天后复查血压、血糖...",
    "evidence_json": {
      "evidence": [...],
      "anomalies": [...],
      "weights": {
        "text_weight": 0.35,
        "ct_weight": 0.25,
        "lab_weight": 0.40
      }
    },
    "created_at": "2024-01-15T11:30:00.000Z"
  }
}
```

**响应示例**（诊断尚未完成）：
```json
{
  "success": false,
  "error": "诊断结果尚未生成"
}
```

#### 综合分析（并行调用所有存储过程）

**接口地址**：`GET /api/db-analysis/comprehensive/:patient_id`

**示例请求**：
```
GET /api/db-analysis/comprehensive/9
```

**响应示例**：
```json
{
  "success": true,
  "data": {
    "multimodal_data": {...},
    "evidence": [...],
    "anomalies": [...],
    "diagnosis": {...}
  }
}
```

---

## 4. 常见问题

### 4.1 安装问题

**Q1：npm install 失败怎么办？**

A：尝试以下解决方案：
```bash
# 方案1：清除缓存后重新安装
npm cache clean --force
rm -rf node_modules package-lock.json
npm install

# 方案2：使用国内镜像源
npm config set registry https://registry.npmmirror.com
npm install

# 方案3：使用 cnpm
npm install -g cnpm --registry=https://registry.npmmirror.com
cnpm install
```

**Q2：Node.js 版本不兼容怎么办？**

A：使用 nvm (Node Version Manager) 管理 Node.js 版本：
```bash
# 安装 nvm（Linux/Mac）
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash

# 安装 Node.js 18
nvm install 18
nvm use 18

# 验证版本
node -v  # 应输出 v18.x.x
```

### 4.2 运行问题

**Q1：后端启动时提示"数据库连接失败"？**

A：检查以下几点：
1. **SSH 隧道是否建立**：
   ```bash
   # 检查 5432 端口是否被占用（说明隧道正常）
   netstat -an | findstr :5432  # Windows
   lsof -i :5432                # Linux/Mac
   ```
2. **数据库配置是否正确**（`.env` 文件）：
   - `DB_HOST` 必须是 `127.0.0.1`（不要用 `localhost`）
   - `DB_PORT` 必须是 `5432`
   - `DB_USER` 和 `DB_PASSWORD` 是否正确
3. **运行测试脚本**：
   ```bash
   node backend/test-db-connection.js
   ```

**Q2：前端无法访问后端 API？**

A：检查以下几点：
1. **后端服务是否启动**：
   ```bash
   curl http://127.0.0.1:3000/health
   ```
2. **前端代理配置是否正确**（`frontend/vite.config.js`）：
   ```javascript
   server: {
     proxy: {
       '/api': {
         target: 'http://127.0.0.1:3000',
         changeOrigin: true
       }
     }
   }
   ```
3. **浏览器控制台是否有跨域错误**：
   - 如果有，检查后端 CORS 配置（`backend/src/app.js`）

**Q3：文件上传失败？**

A：检查以下几点：
1. **文件大小是否超过限制**（默认 50MB）
2. **文件格式是否支持**（JPG/PNG）
3. **七牛云配置是否正确**（AK/SK）
4. **查看后端日志**：
   ```bash
   type backend\logs\error.log | more  # Windows
   tail -f backend/logs/error.log      # Linux/Mac
   ```

**Q4：AI 分析返回空结果或超时？**

A：检查以下几点：
1. **图片 URL 是否可访问**（在浏览器中打开测试）
2. **AI 插件是否正常**：
   ```javascript
   // 创建测试脚本 test-ai.js
   const { query } = require('./src/config/db');
   query(`SELECT ai.generate_text('测试') AS result`)
     .then(res => console.log('AI 插件正常:', res.rows))
     .catch(err => console.error('AI 插件异常:', err.message));
   ```
3. **网络是否稳定**（AI 调用需要访问外部服务）
4. **超时时间是否足够**（默认 200 秒）

### 4.3 功能问题

**Q1：为什么诊断结果的置信度最高只有 92%？**

A：这是系统的保守策略设计，目的是：
- 避免 AI 过度自信
- 为医生留出判断空间
- 提醒医生进行人工复核

92% 的硬性上限是经过校准的，永远不会达到 100%。

**Q2：实验室指标的严重程度是如何分级的？**

A：系统使用 Z-score 算法进行三级分类：
- **轻微**（< 1σ）：偏离正常范围但不严重
- **中度**（1σ ~ 2σ）：明显异常，需关注
- **严重**（≥ 2σ）：显著异常，需立即处理

公式：`Z = (实际值 - 参考值中点) / (参考范围宽度 / 4)`

**Q3：如何编辑 AI 生成的分析结果？**

A：所有 AI 分析结果都支持医生编辑：
1. **病历总结**：点击编辑按钮，修改后保存
2. **CT 分析**：点击编辑按钮，修改后保存
3. **实验室指标**：点击表格单元格，直接编辑
4. 编辑后，系统会：
   - 标记为"已编辑"
   - 记录编辑人和编辑时间
   - 版本号自动 +1
   - 写入审计日志

**Q4：如何导出 PDF 报告？**

A：在诊断报告页面：
1. 点击"导出 PDF"按钮
2. 系统在前端生成 PDF（无需后端处理）
3. 浏览器自动下载文件
4. PDF 包含完整的诊断信息、证据链、异常指标表格

---

## 5. 故障排查

### 5.1 后端服务问题

#### 问题：后端启动后立即崩溃

**排查步骤**：
1. **查看错误日志**：
   ```bash
   type backend\logs\error.log | more  # Windows
   tail -f backend/logs/error.log      # Linux/Mac
   ```
2. **检查环境变量**：
   ```bash
   # 确认 .env 文件存在
   ls backend/.env  # Linux/Mac
   dir backend\.env # Windows
   
   # 检查关键变量
   cat backend/.env | grep DB_HOST
   ```
3. **测试数据库连接**：
   ```bash
   node backend/test-db-connection.js
   ```
4. **检查端口占用**：
   ```bash
   netstat -ano | findstr :3000  # Windows
   lsof -i :3000                 # Linux/Mac
   ```

**常见错误及解决方案**：
| 错误信息 | 原因 | 解决方案 |
|---------|------|---------|
| `ECONNREFUSED` | 数据库连接失败 | 检查 SSH 隧道和数据库配置 |
| `EADDRINUSE` | 端口已被占用 | 修改 PORT 或关闭占用进程 |
| `MODULE_NOT_FOUND` | 依赖未安装 | 运行 `npm install` |
| `Syntax Error` | Node.js 版本过低 | 升级到 >= 18.0.0 |

#### 问题：API 请求响应缓慢

**排查步骤**：
1. **查看后端日志**，分析耗时操作
2. **检查数据库查询性能**：
   ```javascript
   // 在查询前后记录时间
   const start = Date.now();
   await query('SELECT * FROM patients WHERE patient_id = $1', [id]);
   console.log(`查询耗时: ${Date.now() - start}ms`);
   ```
3. **检查是否使用了分片键**（performance.md）
4. **检查 AI 调用超时设置**：
   ```sql
   -- 查看当前超时设置
   SHOW ai.http.timeout_msec;
   ```

**优化建议**：
- 确保查询带上 `patient_id` 分片键
- 为常用字段创建索引
- AI 调用设置合理的超时时间（200 秒）
- 使用连接池管理数据库连接

### 5.2 前端问题

#### 问题：前端页面无法加载

**排查步骤**：
1. **检查前端服务是否启动**：
   ```bash
   curl http://127.0.0.1:5173
   ```
2. **查看浏览器控制台错误**：
   - 按 F12 打开开发者工具
   - 查看 Console 标签页
3. **检查 API 代理配置**：
   ```javascript
   // frontend/vite.config.js
   server: {
     proxy: {
       '/api': {
         target: 'http://127.0.0.1:3000',
         changeOrigin: true
       }
     }
   }
   ```
4. **清除浏览器缓存**：
   - Chrome: Ctrl+Shift+Delete
   - 选择"清除缓存的图片和文件"

#### 问题：文件上传卡住不动

**排查步骤**：
1. **检查文件大小**（是否超过 10MB）
2. **检查网络请求**：
   - F12 → Network 标签页
   - 查看上传请求的状态
3. **查看后端日志**，确认是否收到请求
4. **检查七牛云配置**：
   ```bash
   # 测试七牛云上传
   curl -X POST "https://upload.qiniup.com" \
     -H "Authorization: UpToken <your-upload-token>" \
     -F "file=@test.jpg"
   ```

### 5.3 数据库问题

#### 问题：SSH 隧道断开

**现象**：
- 后端报错：`ECONNREFUSED 127.0.0.1:5432`
- 数据库连接失败

**解决方案**：
1. **重新建立 SSH 隧道**：
   ```bash
   ssh -L 5432:10.3.0.7:11000 opentenbase@123.207.69.169
   ```
2. **保持隧道稳定**（可选）：
   ```bash
   # 使用 autossh 自动重连（Linux/Mac）
   autossh -M 0 -L 5432:10.3.0.7:11000 opentenbase@123.207.69.169
   
   # 使用 screen 保持会话（Linux/Mac）
   screen -S ssh-tunnel
   ssh -L 5432:10.3.0.7:11000 opentenbase@123.207.69.169
   # 按 Ctrl+A+D 退出 screen，隧道继续运行
   ```

#### 问题：查询超时

**排查步骤**：
1. **检查查询是否包含分片键**：
   ```sql
   -- ✅ 正确：包含分片键（快速）
   SELECT * FROM patient_text_data WHERE patient_id = 9 AND id = 15;
   
   -- ❌ 错误：不包含分片键（慢）
   SELECT * FROM patient_text_data WHERE id = 15;
   ```
2. **查看查询执行计划**：
   ```sql
   EXPLAIN ANALYZE SELECT * FROM patient_text_data WHERE patient_id = 9;
   ```
3. **检查索引是否存在**：
   ```sql
   SELECT indexname FROM pg_indexes WHERE tablename = 'patient_text_data';
   ```

### 5.4 AI 分析问题

#### 问题：AI 分析失败或返回空结果

**排查步骤**：
1. **验证图片 URL 可访问性**：
   - 在浏览器中打开图片 URL
   - 确认返回 200 状态码
2. **测试 AI 插件**：
   ```javascript
   // 创建测试脚本 test-ai.js
   const { query } = require('./src/config/db');
   
   async function testAI() {
     // 测试文本生成
     const textResult = await query(`SELECT ai.generate_text('你好') AS result`);
     console.log('文本生成:', textResult.rows[0].result);
   
     // 测试图像分析
     const imageResult = await query(
       `SELECT ai.image('描述这张图片', $1) AS result`,
       ['https://qiniu.aihubzone.cn/opentenbase/text/test.jpg']
     );
     console.log('图像分析:', imageResult.rows[0].result);
   }
   
   testAI().catch(console.error);
   ```
3. **检查 AI 插件配置**：
   ```sql
   -- 查看 AI 插件是否安装
   SELECT * FROM pg_extension WHERE extname = 'opentenbase_ai';
   
   -- 查看 AI 模型配置
   SHOW ai.completion_model;
   SHOW ai.image_model;
   SHOW ai.http.timeout_msec;
   ```
4. **检查网络连接**（AI 插件需要访问外部服务）

#### 问题：诊断任务一直处于 pending 状态

**排查步骤**：
1. **查看任务表**：
   ```javascript
   const { query } = require('./src/config/db');
   query(`
     SELECT * FROM analysis_tasks
     WHERE task_type = 'diagnosis'
     ORDER BY created_at DESC
     LIMIT 10
   `).then(res => console.log(res.rows));
   ```
2. **检查是否有数据**：
   ```javascript
   // 确认患者至少有一种模态的数据
   query(`
     SELECT
       (SELECT COUNT(*) FROM patient_text_data WHERE patient_id = 9) AS text_count,
       (SELECT COUNT(*) FROM patient_ct_data WHERE patient_id = 9) AS ct_count,
       (SELECT COUNT(*) FROM patient_lab_data WHERE patient_id = 9) AS lab_count
   `).then(res => console.log(res.rows));
   ```
3. **手动调用诊断函数**：
   ```javascript
   query(`SELECT smart_diagnosis_v3(9) AS result`)
     .then(res => console.log('诊断成功:', res.rows))
     .catch(err => console.error('诊断失败:', err.message));
   ```

---

**文档版本**：v1.0
**最后更新**：2025-10-16
**作者**：周佳豪
**联系方式**：jhzhou0704@163.com

**相关文档**：
- [README.md](../README.md) - 项目总览
- [设计文档.md](./设计文档.md) - 架构与算法设计
