# 医疗多模态智能分析平台 - 使用文档

## 目录

- [1. 环境部署](#1-环境部署)
  - [1.1 环境要求](#11-环境要求)
  - [1.2 快速启动](#12-快速启动)
  - [1.3 环境变量配置](#13-环境变量配置)
  - [1.4 生产环境部署](#14-生产环境部署)
- [2. 系统使用教程](#2-系统使用教程)
  - [2.1 患者管理](#21-患者管理)
  - [2.2 数据上传与分析](#22-数据上传与分析)
  - [2.3 智能诊断](#23-智能诊断)
  - [2.4 诊断报告查看与导出](#24-诊断报告查看与导出)

---

## 1. 环境部署

### 1.1 环境要求

**硬件要求**：
- CPU: 2 核及以上
- 内存: 4GB 及以上
- 硬盘: 20GB 可用空间

**软件要求**：
- Node.js: >= 18.0.0
- npm: >= 9.0.0
- OpenTenBase 数据库（已安装 `opentenbase_ai` 插件）
- 七牛云账号（对象存储服务）

**支持的操作系统**：
- Windows 10/11
- macOS 10.15+
- Linux (Ubuntu 20.04+, CentOS 8+)

### 1.2 快速启动

#### 第一步：克隆项目

```bash
git clone https://github.com/jhzhou002/smart_medical.git
cd smart_medical
```

#### 第二步：配置数据库连接

**重要提示**：本项目通过 SSH 隧道连接到远程 OpenTenBase 数据库。

**建立 SSH 隧道**（保持终端运行）：
```bash
ssh -L 5432:内网IP:端口 用户名@公网IP

# 输入密码后，保持该终端窗口运行
# 不要关闭此窗口，否则数据库连接会中断
```

#### 第三步：启动后端服务

```bash
# 进入后端目录
cd backend

# 安装依赖
npm install

# 配置环境变量
cp .env.example .env
# 编辑 .env 文件，填写数据库和七牛云配置

# 启动后端（开发模式）
npm run dev

# 后端服务将运行在 http://127.0.0.1:3000
```

#### 第四步：启动前端服务（新终端窗口）

```bash
# 进入前端目录
cd frontend

# 安装依赖
npm install

# 启动前端（开发模式）
npm run dev

# 前端服务将运行在 http://127.0.0.1:5173
```

#### 第五步：访问系统

打开浏览器访问：**http://127.0.0.1:5173**

### 1.3 环境变量配置

**后端环境变量** (`backend/.env`)：

```bash
# ====== 数据库配置 ======
# 重要：必须使用 127.0.0.1，不要使用 localhost
DB_HOST=127.0.0.1
DB_PORT=5432
DB_USER=your_username
DB_PASSWORD=your_password
DB_NAME=smart_medical

# ====== 服务器配置 ======
PORT=3000
NODE_ENV=development

# ====== 七牛云对象存储配置 ======
QINIU_ACCESS_KEY=your_access_key_here
QINIU_SECRET_KEY=your_secret_key_here
QINIU_BUCKET=your_bucket_name
QINIU_DOMAIN=https://your-domain.com

# ====== JWT 认证配置（可选）======
JWT_SECRET=your-secret-key-here
JWT_EXPIRES_IN=7d

# ====== 文件上传配置 ======
MAX_FILE_SIZE=52428800  # 50MB
```

**验证数据库连接**：

```bash
# 通过健康检查接口
curl http://127.0.0.1:3000/health

# 预期响应：
# {
#   "status": "ok",
#   "database": "connected",
#   "timestamp": "2025-01-15T10:30:00.000Z"
# }
```

---

## 2. 系统使用教程

### 2.1 患者管理

#### 创建新患者

1. **访问患者管理页面**
   - 点击左侧菜单 "患者管理"

2. **填写患者信息**
   - 点击"新增患者"按钮
   - 填写必填信息：
     * 姓名（2-100 个字符）
     * 年龄（0-150 岁）
     * 性别（男/女/其他）
   - 选填信息：
     * 手机号（11 位）
     * 身份证号
     * 是否首次就诊
     * 过往病史
     * 历史病症

3. **保存患者**
   - 点击"确定"按钮
   - 系统自动生成患者 ID

**示例**：

```
姓名: 张三
年龄: 45
性别: 男
手机号: 13800138000
过往病史: 高血压 5 年，糖尿病 3 年
历史病症: 近期头晕，血压控制不佳
```

![image-20251016155720955](D:/Desktop/OpenAtom/smart_medical/doc/assets/image-20251016155720955.png)

#### 查询患者

**列表浏览**：
- 患者列表默认按创建时间倒序排列
- 支持分页浏览

**搜索查询**：
- 输入搜索关键词（姓名/手机号/身份证号）
- 系统自动模糊匹配

**患者详情**：
- 点击"查看"按钮查看患者完整档案
- 包含：基本信息、病历数据、CT 数据、实验室数据、诊断记录

![image-20251016155803015](D:/Desktop/OpenAtom/smart_medical/doc/assets/image-20251016155803015.png)

#### 编辑与删除

**编辑患者**：
1. 点击"编辑"按钮
2. 修改需要更新的字段
3. 点击"确定"保存

**删除患者**：
⚠️ **危险操作**：删除患者将同时删除其所有关联数据
1. 点击"删除"按钮
2. 确认删除操作

### 2.2 数据上传与分析

#### 病历文本上传

**方式1：上传病历图片（OCR 识别）**

![image-20251016155859806](D:/Desktop/OpenAtom/smart_medical/doc/assets/image-20251016155859806.png)

1. 访问"AI 智能分析"页面
2. 选择患者
3. 切换到"病历文本"标签页
4. 选择"上传病历图片（OCR 识别）"
5. 拖拽或点击上传病历图片
   - 支持格式：JPG、PNG
   - 文件大小：≤ 10MB
6. 系统自动执行：
   - ① 上传到七牛云
   - ② AI OCR 识别文本
   - ③ 生成自然语言总结
   - ④ 存入数据库
7. 查看并编辑 AI 生成的病历总结
8. 点击"保存"确认

**方式2：使用患者病史信息**

![image-20251016155847589](D:/Desktop/OpenAtom/smart_medical/doc/assets/image-20251016155847589.png)

1. 选择"使用患者病史信息"
2. 系统自动加载患者的"过往病史"和"历史病症"
3. 可在此基础上补充或修改
4. 点击"保存为病历总结"

**AI 生成示例**：
```
患者主诉头晕 3 天，伴有恶心。
既往高血压病史 5 年，糖尿病病史 3 年。
体格检查：血压 160/100 mmHg，心率 88 次/分。
初步诊断：高血压急症，血糖控制不佳。
```

#### CT 影像上传

![image-20251016160042353](D:/Desktop/OpenAtom/smart_medical/doc/assets/image-20251016160042353.png)

1. 切换到"CT 影像"标签页
2. 拖拽或点击上传 CT 影像
   - 支持格式：JPG、PNG
   - 文件大小：≤ 10MB
3. 系统自动执行：
   - ① 上传原始 CT 到七牛云
   - ② AI 影像分析
   - ③ 生成影像学报告
4. 查看并编辑 AI 分析结果

**AI 分析内容**：
- CT 影像描述
- 病灶位置和性质
- 影像学诊断建议

#### 实验室指标上传

![image-20251016160009437](D:/Desktop/OpenAtom/smart_medical/doc/assets/image-20251016160009437.png)

1. 切换到"实验室指标"标签页
2. 拖拽或点击上传实验室检查单图片
   - 支持格式：JPG、PNG
   - 文件大小：≤ 10MB
3. 系统自动执行：
   - ① 上传到七牛云
   - ② AI 表格识别
   - ③ 提取结构化数据（JSON 格式）
4. 查看并编辑识别的指标数据

**识别数据格式**：
| 指标名称    | 缩写 | 检测值 | 单位     | 参考范围 |
|------------|------|--------|---------|---------|
| 白细胞计数  | WBC  | 15.2   | 10^9/L  | 4-10    |
| 红细胞计数  | RBC  | 4.5    | 10^12/L | 3.5-5.5 |
| 血红蛋白    | HGB  | 130    | g/L     | 120-160 |

### 2.3 智能诊断

#### 生成综合诊断

**前提条件**：

- 至少上传了一种模态的数据（病历/CT/实验室指标）

**操作步骤**：

1. 在"AI 分析"页面，确保已选择患者
2. 确认已上传所需数据
3. 点击"生成综合诊断"按钮
4. 系统执行（约 10-30 秒）：
   - 创建诊断任务
   - 后台调用 PL/pgSQL 存储过程
   - 执行多步诊断流程
   - 前端每 2 秒轮询一次状态
5. 诊断完成后，自动显示诊断结果

**诊断结果包含**：
- **诊断结论**：AI 生成的综合诊断文本
- **置信度评分**：0-92 分（永不达 100%）
- **风险评分**：0-100 分
- **治疗建议**：AI 推荐的治疗方案
- **随访建议**：后续跟踪计划

**诊断结果示例**：
```
【综合诊断】
根据患者的病历、CT 影像和实验室检查结果，综合诊断如下：

1. 高血压急症（血压 160/100 mmHg，明显高于正常范围）
2. 糖尿病血糖控制不佳（空腹血糖 12.5 mmol/L，超过参考范围 56%）
3. 白细胞增多（WBC 15.2，提示可能存在感染）

【诊断依据】
- 病历记录：患者主诉头晕 3 天，既往高血压、糖尿病病史
- 实验室指标：血压显著升高，血糖超标，白细胞计数异常
- 证据权重：实验室指标 40%，病历文本 35%，患者信息 25%

【治疗建议】
1. 立即降压治疗（口服降压药或静脉给药）
2. 调整降糖方案，控制血糖至目标范围
3. 进一步检查感染原因（血常规复查、尿常规、胸片等）
4. 住院观察，密切监测生命体征

【随访计划】
- 3 天后复查血压、血糖
- 1 周后复查血常规
- 1 个月后门诊随访，评估血压、血糖控制情况

【置信度评分】85.6 分
【风险评分】78 分（中高风险）
```

![image-20251016160335646](D:/Desktop/OpenAtom/smart_medical/doc/assets/image-20251016160335646.png)

![image-20251016160349825](D:/Desktop/OpenAtom/smart_medical/doc/assets/image-20251016160349825.png)

#### 查看异常指标

系统自动标注实验室指标的异常严重程度：

| 指标 | 检测值 | 参考范围 | 偏离度 | 百分比 | 严重程度 |
|------|--------|---------|--------|--------|---------|
| 白细胞计数 | 15.2 | 4-10 | 3.47σ | 52% | 🔴 严重 |
| 血糖 | 12.5 | 3.9-6.1 | 2.56σ | 56% | 🔴 严重 |
| 血红蛋白 | 115 | 120-160 | -0.25σ | -4.2% | 🟡 轻微 |

**严重程度分级规则**：
- 🟢 **正常**：在参考范围内
- 🟡 **轻微**：偏离 < 1σ
- 🟠 **中度**：1σ ≤ 偏离 < 2σ
- 🔴 **严重**：偏离 ≥ 2σ

**分级算法说明**：
系统使用 Z-score 算法计算偏离度：
```
Z = (实际值 - 参考值中点) / (参考范围宽度 / 4)
```

![image-20251016160403999](D:/Desktop/OpenAtom/smart_medical/doc/assets/image-20251016160403999.png)

### 2.4 诊断报告查看与导出

#### 访问诊断报告页面

**方法1**：通过导航菜单
- 点击左侧菜单"诊断报告"

**方法2**：通过诊断结果跳转
- 在"AI 智能分析"页面生成诊断后
- 点击"查看完整报告"按钮

#### 诊断报告内容

**1. 患者基本信息**
```
姓名: 张三
年龄: 45 岁
性别: 男
患者 ID: 9
诊断时间: 2024-01-15 11:30:00
```

**2. 诊断结论**
- AI 生成的综合诊断文本
- 支持 Markdown 格式渲染

**3. 异常指标**

- 表格展示所有异常的实验室指标
- 三色标注严重程度（轻微/中度/严重）
- 显示偏离度和百分比

**4. 治疗建议与随访计划**

- AI 生成的治疗方案
- 随访时间节点和检查项目

#### PDF 报告导出

**导出步骤**：
1. 在"诊断报告"页面
2. 点击"导出 PDF"按钮
3. 系统生成 PDF 文件（前端生成）
4. 浏览器自动下载 PDF 文件

**文件命名格式**：
```
诊断报告_张三_20240115.pdf
```

**PDF 报告包含**：
- 患者基本信息
- 综合诊断结论
- 置信度
- 诊断依据说明
- 异常指标表格
- 治疗建议
- 随访计划
- 报告生成时间

![image-20251016160628244](D:/Desktop/OpenAtom/smart_medical/doc/assets/image-20251016160628244.png)

---

## 常见问题

### 安装问题

**Q：npm install 失败怎么办？**

A：尝试以下解决方案：
```bash
# 方案1：清除缓存后重新安装
npm cache clean --force
rm -rf node_modules package-lock.json
npm install

# 方案2：使用国内镜像源
npm config set registry https://registry.npmmirror.com
npm install
```

**Q：Node.js 版本不兼容怎么办？**

A：使用 nvm 管理 Node.js 版本：
```bash
# 安装 nvm（Linux/Mac）
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash

# 安装 Node.js 18
nvm install 18
nvm use 18

# 验证版本
node -v  # 应输出 v18.x.x
```

### 运行问题

**Q：后端启动时提示"数据库连接失败"？**

A：检查以下几点：
1. SSH 隧道是否建立
2. 数据库配置是否正确（`.env` 文件）
   - `DB_HOST` 必须是 `127.0.0.1`
   - `DB_PORT`、`DB_USER`、`DB_PASSWORD` 是否正确
3. 运行测试脚本验证连接

**Q：前端无法访问后端 API？**

A：检查以下几点：
1. 后端服务是否启动：`curl http://127.0.0.1:3000/health`
2. 前端代理配置是否正确（`frontend/vite.config.js`）
3. 浏览器控制台是否有跨域错误

**Q：文件上传失败？**

A：检查以下几点：
1. 文件大小是否超过限制（默认 50MB）
2. 文件格式是否支持（JPG/PNG）
3. 七牛云配置是否正确（AK/SK）
4. 查看后端日志

**Q：AI 分析返回空结果或超时？**

A：检查以下几点：
1. 图片 URL 是否可访问（在浏览器中打开测试）
2. AI 插件是否正常
3. 网络是否稳定（AI 调用需要访问外部服务）
4. 超时时间是否足够（默认 200 秒）

### 功能问题

**Q：为什么诊断结果的置信度最高只有 92%？**

A：这是系统的保守策略设计，目的是：
- 避免 AI 过度自信
- 为医生留出判断空间
- 提醒医生进行人工复核

**Q：如何编辑 AI 生成的分析结果？**

A：所有 AI 分析结果都支持医生编辑：
1. 病历总结：点击编辑按钮，修改后保存
2. CT 分析：点击编辑按钮，修改后保存
3. 实验室指标：点击表格单元格，直接编辑

编辑后，系统会标记为"已编辑"并记录编辑人和时间。

---

**文档版本**：v1.0
**最后更新**：2025-01-16
**作者**：周佳豪
**联系方式**：jhzhou0704@163.com

**相关文档**：
- [README.md](../README.md) - 项目总览
- [设计文档.md](./设计文档.md) - 系统架构与算法设计
